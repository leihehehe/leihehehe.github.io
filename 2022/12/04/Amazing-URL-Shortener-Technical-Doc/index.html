<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <meta name="author" content="Leihehe" />
  <meta name="description" content="Shulei&#39;s Blog" />
  
  
  <title>
    
      Amazing URL Shortener - Technical Doc 
      
      
      |
    
     Shulei He - Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon1.png">
    <link rel="icon" href="/images/favicon1.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar_new.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Shulei He</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Amazing URL Shortener - Technical Doc</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2024-04-01 21:55:04
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="Categories"></i>
                
                <span class="span--category">
                  <a href="/categories/Development/" title="Development">
                    <b>#</b> Development
                  </a>
                </span>
                
                <span class="span--category">
                  <a href="/categories/Development/Java/" title="Java">
                    <b>#</b> Java
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Java-Project/" title="Java Project">
                    #Java Project
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/URL-shortener/" title="URL shortener">
                    #URL shortener
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Amazing URL Shortener is an online tool with high availability to shorten a long link and provide detailed statistics.</p>
<p><strong>Demo</strong>:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://official.urls.fit/">http://official.urls.fit</a></li>
<li><a target="_blank" rel="noopener" href="http://short.urls.fit/">http://short.urls.fit</a></li>
</ul>
<p><code>username: test</code></p>
<p><code>password: test</code></p>
<p><strong>Short link demo</strong>: <code>urls.fit/a26B4EM0</code></p>
<p><strong>GitHub repo:</strong> </p>
<ul>
<li>Backend: <a target="_blank" rel="noopener" href="https://github.com/leihehehe/java-url-shortener">https://github.com/leihehehe/java-url-shortener</a></li>
<li>Frontend: currently is a private repo</li>
</ul>
<span id="more"></span>

<h1 id="Technical-Stacks-Used"><a href="#Technical-Stacks-Used" class="headerlink" title="Technical Stacks Used"></a>Technical Stacks Used</h1><p><strong>Backend Techniques:</strong> </p>
<ul>
<li><p><strong>Framework</strong>: SpringBoot, Spring Cloud</p>
</li>
<li><p><strong>Gateway</strong>: Spring Cloud Gateway</p>
</li>
<li><p><strong>Message Queues</strong>: RabbitMQ, Kafka</p>
</li>
<li><p><strong>Database-related Techs</strong>: Redis, Redisson(operating on Redis), ClickHouse, SpringData JPA, MySQL,  Apache Shardingsphere</p>
</li>
<li><p><strong>Data Streaming-processing Framework</strong>: Flink</p>
</li>
<li><p><strong>Availability</strong>: resillience4j</p>
</li>
<li><p><strong>Others</strong>: Openfeign, etc.</p>
</li>
</ul>
<p><strong>Frontend:</strong> Angular.js</p>
<p><strong>DevOps</strong>:</p>
<ul>
<li>Jenkins</li>
<li>Kubernetes</li>
</ul>
<h2 id="ShardingSphere"><a href="#ShardingSphere" class="headerlink" title="ShardingSphere"></a>ShardingSphere</h2><blockquote>
<p><strong>ShardingSphere</strong> provides a distributed database solution based on the underlying database, which can scale computing and storage horizontally</p>
</blockquote>
<h3 id="Why-use-it"><a href="#Why-use-it" class="headerlink" title="Why use it?"></a>Why use it?</h3><p>Since we are developing a system that can handle massive data, it is not possible to just use one single database or a few tables to store the data. Storing massive data in only one node or database will cause much pressure on the database itself, and speed will be significantly slowed down.</p>
<p>Therefore, it is necessary to do sharding and partitioning. For example, I divided the <code>product_order</code> table into two tables stored in the <code>url_shop</code> database and divided the <code>short_link</code> table into 6 tables and every two tables are distributed in a <code>url_link</code> table. (For more details, please see the <strong>Database Structure</strong> part)</p>
<h3 id="Partition-Keys"><a href="#Partition-Keys" class="headerlink" title="Partition Keys"></a>Partition Keys</h3><p>Partition keys are set in terms of different cases. For example, for users to find their orders quickly, <code>accountNo</code> is used as a partition key, so that a user’s orders will be in the same table.</p>
<p>Another situation is that we need to handle a large number of shortened links across multiple databases and tables. In this case, I use <code>accountNo</code> as a partition key to finding out which <strong>databases</strong> the records are currently in. Besides, <code>groupId</code> is used as a partition key for finding out which <strong>tables</strong> the records are currently in.</p>
<h3 id="How-to-query-the-data-in-this-case"><a href="#How-to-query-the-data-in-this-case" class="headerlink" title="How to query the data in this case?"></a>How to query the data in this case?</h3><p>I used two methods to query the data</p>
<ul>
<li><strong>Modulo</strong>. For example, <code>k = accountNo mod n</code> where n is the number of tables that will query the <strong>kth</strong> table </li>
<li><strong>Store database and column info in the data itself</strong>. For example, we got a short link code stored in the database <code>a</code> and table <code>2</code>, then we can update the short link code to <code>axxxx2</code>, so that we could quickly locate this short link when querying the data.</li>
</ul>
<h2 id="Redis-Redisson-amp-Lua-Script"><a href="#Redis-Redisson-amp-Lua-Script" class="headerlink" title="Redis, Redisson &amp; Lua Script"></a>Redis, Redisson &amp; Lua Script</h2><ul>
<li>Redis is used as a cache in the project. It stores the users’ plan data information to prevent frequent requests to the MySQL database.</li>
<li>Redis and Redisson are used together to handle distributed locks. In addition to using Redisson, Lua script is also straightforward and used for creating locks.</li>
</ul>
<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><ul>
<li>RabbitMQ is used to slow down the response waiting time as operations can be asynchronously executed by sending messages.</li>
<li>RabbitMQ is also used to deliver delayed messages for different purposes like order cancellation and distributed transactions.</li>
<li>Compared to <code>Kafka</code>, it is more suitable for an e-commerce business service(e.g. scheduled tasks and distributed transaction management) </li>
</ul>
<h2 id="Flink-Kafka-amp-ClickHouse"><a href="#Flink-Kafka-amp-ClickHouse" class="headerlink" title="Flink, Kafka &amp; ClickHouse"></a>Flink, Kafka &amp; ClickHouse</h2><blockquote>
<p><strong>Flink is used for processing data streams at a large scale and to deliver real-time analytical insights about your processed data with your streaming application</strong>.</p>
</blockquote>
<p>In this project, I used <code>Flink</code> to get visitor information when a visitor is trying to access a shortened link. Flink helps to process the visitor information in each layer and pass the processed information to the next layer using <code>Kafka</code>.</p>
<p>At the last layer, I used Flink to pass the final datasets to ClickHouse which is a fast column-oriented database management system.</p>
<p>ClickHouse allows us to generate analytical reports using SQL queries.</p>
<h2 id="Jenkins-amp-Kubernetes-High-Availability"><a href="#Jenkins-amp-Kubernetes-High-Availability" class="headerlink" title="Jenkins &amp; Kubernetes(High Availability)"></a>Jenkins &amp; Kubernetes(High Availability)</h2><p>The Jenkins file is included in the project, and both front-end and back-end projects are deployed using Kubernetes and Jenkins.</p>
<p>Jenkins runs a piepeline to build and upload images to AWS ECR.</p>
<p>Using <strong>3</strong> servers(<strong>1 master node and 1 worker node</strong>) to build a Kubernetes cluster. </p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/202212042225127.png" alt="kubernetes deployments"></p>
<h1 id="Technical-Difficulties-amp-Solutions"><a href="#Technical-Difficulties-amp-Solutions" class="headerlink" title="Technical Difficulties &amp; Solutions"></a>Technical Difficulties &amp; Solutions</h1><h2 id="Creating-Short-URLs"><a href="#Creating-Short-URLs" class="headerlink" title="Creating Short URLs"></a>Creating Short URLs</h2><p><strong>There are two options.</strong></p>
<ol>
<li><p><strong>Snowflake ID + Base62 Encoding</strong>. For example, first we use <code>SnowFlake</code> to create a unique ID, then pass the resulting ID to a Base 62 encoding function. This will give us a unique link.</p>
<ul>
<li><p><strong>Pros</strong>: It ensures that every original url can produce a unique short url.</p>
</li>
<li><p><strong>Cons</strong>: </p>
<ul>
<li>We have to make sure that all the machines having the same system time configured.</li>
<li>If the Snowflake generated ID is long, the resulting short path, even after Base62 encoding, may not be sufficiently short.</li>
</ul>
</li>
<li><p>But there is still a possibility of two users generating the same short link when they creating the short link at the same time(within 1ms). </p>
</li>
</ul>
</li>
<li><p><strong>Snowflake ID + MurmurHash + Base62 Encoding.</strong> Compared to the first option, we use <code>MurmurHash</code> to hash our unique id, to make it shorter enough, then we use Base62 encoding.</p>
<ul>
<li><p><strong>Pros:</strong> we can generate shorter links.</p>
</li>
<li><p>**Cons: **</p>
<ul>
<li>All hash algorithms have the potential for hash conflicts. Although MurmurHash has a low conflict probability, it cannot guarantee complete conflict avoidance.</li>
<li>You can’t recover the original ID from the short path(but it does not matter in our case)</li>
</ul>
</li>
<li><p>To avoid hash conflicts, we can</p>
<ul>
<li><strong>Retry with Variation</strong>: If a collision is detected, modify the input slightly (e.g., by adding a counter or changing a bit in the original ID) and regenerate the hash. Repeat this process until a unique short path is generated.</li>
<li><strong>Salting</strong>: Introduce a salt—a random value added to the input of the hash function—to ensure that even if the original IDs are similar, the resulting hashes will be different. For example, we can add SnowFlake ID appended to the original url, and hash it again.</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="Database-Sharding-and-Partitioning"><a href="#Database-Sharding-and-Partitioning" class="headerlink" title="Database Sharding and Partitioning"></a>Database Sharding and Partitioning</h2><p>As we know users prefer to query links in terms of their <code>accountNo</code>, if the links are distributed in different databases and tables, it will be very difficult for users to query the data since the system needs to access all the databases and tables to get the records.</p>
<p>However, visitors, just need the <strong>short link code</strong> to locate tables so that they can get original urls quickly. But they have no idea about the <code>groupId</code> and <code>accountNo</code>.</p>
<p>So apparently, we would have two different partition keys to deal with these two cases.</p>
<p>Therefore, I duplicated the tables so that tables <code>group_link_mapping</code> are used to store data for <strong>users</strong>, <code>short_link</code> tables are used to store data for <strong>visitors</strong>.</p>
<h2 id="Distributed-Transaction-Management"><a href="#Distributed-Transaction-Management" class="headerlink" title="Distributed Transaction Management"></a>Distributed Transaction Management</h2><p>New issues have arisen after duplicating the short link tables. Since tables need to be synchronized, there will be inconsistent data if the operation on the user side failed but succeed on the visitor side.</p>
<p><strong>There are two solutions</strong></p>
<ul>
<li><strong>Message Queue:</strong> When we are trying to insert data, we send a message to a queue using <code>RabbitMQ</code>. The first table will retrieve the message and perform the insertion operation. If it fails, the second table will not do anything. If it succeeds, it will send another message indicating that the insertion was successful, and then the second table will perform the insertion. If the second table fails or succeeds, it will send a message, so that the first table can check if it needs to be reverted.</li>
<li><strong>Delayed Message Queue:</strong> Use <code>RabbitMQ</code> to send a <strong>delayed message</strong> to check if operations on both sides are successful.</li>
</ul>
<h2 id="Two-Users-Creating-the-Same-Short-Link"><a href="#Two-Users-Creating-the-Same-Short-Link" class="headerlink" title="Two Users Creating the Same Short Link"></a>Two Users Creating the Same Short Link</h2><p>If two users are generating the same short link, <strong>user A</strong> has inserted data to <code>group_link_mapping</code> and <strong>user B</strong> has inserted data into <code>short_link</code>, at this time, both users will fail because they cannot insert data into others tables(data already exists).</p>
<p><strong>Solution</strong>: Use <code>Redis</code> to add a lock. The value stored in the Redis will be <code>accountNo</code>, if <code>accountNo</code> in the Redis matches the current logged-in <code>accountNo</code>, continue the operations. Otherwise, stop the operations(another user is holding the lock).</p>
<h2 id="Nginx-Short-Link-Access-and-API-server"><a href="#Nginx-Short-Link-Access-and-API-server" class="headerlink" title="Nginx - Short Link Access and API server"></a>Nginx - Short Link Access and API server</h2><p><strong>Updates</strong>: </p>
<p>I have changed the Load balancer to Nginx. Using Nginx can help us load balance and proxy traffic to bankend servers. It significantly saves the overhead of using the AWS load balancer.</p>
<hr>
<p><del>I used the <strong>Load Balancer</strong> in AWS to forward different requests with different URLs and the specific port (80). Basically, we will have two different domains for websites and shorten urls.</del></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20230406225347.png"></p>
<h2 id="Eureka-Servers"><a href="#Eureka-Servers" class="headerlink" title="Eureka Servers"></a>Eureka Servers</h2><p>I did not deploy Eureka servers to Kubernetes. Instead, I deployed them to another machine and used Docker network functions to enable communication between them.</p>
<h1 id="Database-Structure-ER-Diagram"><a href="#Database-Structure-ER-Diagram" class="headerlink" title="Database Structure (ER Diagram)"></a>Database Structure (ER Diagram)</h1><p><strong>url_shop</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20221129155609.png"></p>
<p><strong>url_link_0</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20221129155800.png"></p>
<p><strong>url_link_1</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20221129155832.png"></p>
<p><strong>url_link_a</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20221129155900.png"></p>
<p><strong>url_shop</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221129155931898.png"></p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2022/11/16/FIT3031-Network-Security-Notes/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2024-04-01 21:55:04
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="Categories"></i>
                    
                    <span class="span--category">
                      <a href="/categories/Development/" title="Development">
                        <b>#</b> Development
                      </a>
                    </span>
                    
                    <span class="span--category">
                      <a href="/categories/Development/Java/" title="Java">
                        <b>#</b> Java
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Java-Project/" title="Java Project">
                        #Java Project
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/URL-shortener/" title="URL shortener">
                        #URL shortener
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2023/04/28/How-Did-I-Improve-My-Angular-Project-s-Loading-Speed/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Technical-Stacks-Used"><span class="toc-text">Technical Stacks Used</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ShardingSphere"><span class="toc-text">ShardingSphere</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-use-it"><span class="toc-text">Why use it?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partition-Keys"><span class="toc-text">Partition Keys</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-query-the-data-in-this-case"><span class="toc-text">How to query the data in this case?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-Redisson-amp-Lua-Script"><span class="toc-text">Redis, Redisson &amp; Lua Script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RabbitMQ"><span class="toc-text">RabbitMQ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flink-Kafka-amp-ClickHouse"><span class="toc-text">Flink, Kafka &amp; ClickHouse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins-amp-Kubernetes-High-Availability"><span class="toc-text">Jenkins &amp; Kubernetes(High Availability)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Technical-Difficulties-amp-Solutions"><span class="toc-text">Technical Difficulties &amp; Solutions</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Creating-Short-URLs"><span class="toc-text">Creating Short URLs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Database-Sharding-and-Partitioning"><span class="toc-text">Database Sharding and Partitioning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Distributed-Transaction-Management"><span class="toc-text">Distributed Transaction Management</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Two-Users-Creating-the-Same-Short-Link"><span class="toc-text">Two Users Creating the Same Short Link</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx-Short-Link-Access-and-API-server"><span class="toc-text">Nginx - Short Link Access and API server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka-Servers"><span class="toc-text">Eureka Servers</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Database-Structure-ER-Diagram"><span class="toc-text">Database Structure (ER Diagram)</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




<script>
  document.addEventListener("DOMContentLoaded", function() {
    var expandIconSVG = '<svg t="1701763017908" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1557" width="20" height="11"><path d="M332.16 883.84a40.96 40.96 0 0 0 58.24 0l338.56-343.04a40.96 40.96 0 0 0 0-58.24L390.4 140.16a40.96 40.96 0 0 0-58.24 58.24L640 512l-307.84 314.24a40.96 40.96 0 0 0 0 57.6z" fill="#8a8a8a" p-id="1558"></path></svg>'; // Your collapse icon SVG
    var collapseIconSVG = '<svg t="1701763045407" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1839" width="20" height="11"><path d="M140.16 332.16a40.96 40.96 0 0 0 0 58.24l343.04 338.56a40.96 40.96 0 0 0 58.24 0l342.4-338.56a40.96 40.96 0 1 0-58.24-58.24L512 640 197.76 332.16a40.96 40.96 0 0 0-57.6 0z" fill="#8a8a8a" p-id="1840"></path></svg>'; // Your expand icon SVG

    var tocItems = document.querySelectorAll('.catalog-content .toc-item');
    tocItems.forEach(function(item) {
      if (item.querySelector('.toc-child')) {
        var button = document.createElement('span');
        button.innerHTML = item.classList.contains('collapsed') ? expandIconSVG : collapseIconSVG; // Set initial icon
        button.classList.add('collapse-button');
        item.insertBefore(button, item.firstChild);

        button.addEventListener('click', function() {
          item.classList.toggle('collapsed');
          // Update icon
          button.innerHTML = item.classList.contains('collapsed') ? expandIconSVG : collapseIconSVG;
        });
      }
    });
  });
</script>




    
      <div class="comments-container">
        






  <div id="gitalk-container"></div>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
  <script>
    function loadGitalkSuc() {
      const gitalk = new Gitalk({
        clientID: '4fd0839f78c35735511f',
        clientSecret: 'c4d98a543b9bf9970b444154ad05c4c045afea26',
        repo: 'commentSys',
        owner: 'leihehehe',
        admin: ['leihehehe'],
        id: md5(location.pathname),
        distractionFreeMode: false
      })

      gitalk.render('gitalk-container')
    }
  </script>
  
    <link rel="stylesheet" href="/plugins/gitalk.css">
    <script type="text/javascript" src="/plugins/gitalk.min.js" onload="loadGitalkSuc(this)"></script>
  



      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/leihehehe">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="mailto:hslscarlett@gmail.com">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="linkedin" target="_blank" rel="noopener" href="https://www.linkedin.com/in/shulei-he/">
            <i class="iconfont icon-linkedin"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/leihehehe">Copyright © 2025 Shulei He</a>
        
    </div>
  
    
    <div class="footer-more">
      
        Theme by Oranges | Modified by Shulei
        
    </div>
  
  
    <div class="footer-views">
      
          Total Site Visits:<span id="busuanzi_value_site_pv"></span>
        
      
          Total Artical Views:<span id="busuanzi_value_page_pv"></span>
        
      
          Total Visitors Count:<span id="busuanzi_value_site_uv"></span>
        
      
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + Amazing%20URL%20Shortener%20-%20Technical%20Doc + '&url=' + https%3A%2F%2Fleihehe.top%2F2022%2F12%2F04%2FAmazing-URL-Shortener-Technical-Doc%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://leihehe.top/2022/12/04/Amazing-URL-Shortener-Technical-Doc/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
