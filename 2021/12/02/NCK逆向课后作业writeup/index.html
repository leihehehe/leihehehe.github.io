<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <meta name="author" content="Leihehe" />
  <meta name="description" content="Shulei&#39;s Blog" />
  
  
  <title>
    
      NCK逆向课后作业writeup 
      
      
      |
    
     Shulei He - Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon1.png">
    <link rel="icon" href="/images/favicon1.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar_new.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">Shulei He</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">NCK逆向课后作业writeup</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2023-06-15 17:12:06
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="Categories"></i>
                
                <span class="span--category">
                  <a href="/categories/Reverse-Engineering/" title="Reverse Engineering">
                    <b>#</b> Reverse Engineering
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="Tags"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Write-up/" title="Write-up">
                    #Write-up
                  </a>
                </span>
                
                <span class="span--tag mr-8">
                  <a href="/tags/Reverse-Engineering/" title="Reverse Engineering">
                    #Reverse Engineering
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>个人的一些逆向小练习和解题思路</p>
<p>每天一道</p>
<span id="more"></span>

<h1 id="课后小程序下载地址"><a href="#课后小程序下载地址" class="headerlink" title="课后小程序下载地址"></a>课后小程序下载地址</h1><p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1U-LK9lZf4CjVjUCuSSFIlQ">https://pan.baidu.com/s/1U-LK9lZf4CjVjUCuSSFIlQ</a><br>提取码：k5pf </p>
<h1 id="第一课课后作业"><a href="#第一课课后作业" class="headerlink" title="第一课课后作业"></a>第一课课后作业</h1><h2 id="软件使用"><a href="#软件使用" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203152510850.png" alt="image-20211203152510850"></p>
<h2 id="MessageBoxA-API断点"><a href="#MessageBoxA-API断点" class="headerlink" title="MessageBoxA API断点"></a>MessageBoxA API断点</h2><p>通过信息框，猜测有<code>MessageBox</code> API被调用，<code>ctrl+g</code>找到调用处，直接下断点</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203152727330.png" alt="image-20211203152727330"></p>
<p>点击按钮后让他在此处断下。</p>
<p>看见右下方堆栈顶端显示了CALL的返回地址，右键跟随反汇编窗口。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203152857114.png" alt="image-20211203152857114"></p>
<p>这里跟随到的是返回地址，这样我们就可以找到这个<code>MessageBoxA</code>的返回地址了。</p>
<p>在此处下断点，继续运行，让他断到这里来。往上看了下，好像并没有看见什么明显的判断条件，继续F8。<img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153141019.png" alt="image-20211203153141019"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153406827.png" alt="image-20211203153406827"></p>
<p>往上面找，但发现这个我们猜测的成功的call并没有命令跳过它。继续往上看，发现又有2个这样的call，同时有个je跳过了这2个call</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153609778.png" alt="image-20211203153609778"></p>
<p>基本可以确定是这个跳转的问题了。</p>
<p>直接nop掉。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153658090.png" alt="image-20211203153658090"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153721601.png" alt="image-20211203153721601"></p>
<h2 id="交叉引用查找法"><a href="#交叉引用查找法" class="headerlink" title="交叉引用查找法"></a>交叉引用查找法</h2><p>先是在OD里字符串搜索，发现找不到字符串“注册失败” - OD里的各种插件可能会导致这个问题。于是转用IDA。</p>
<p>视图-》子视图-》字符串， 搜索<code>注册失败</code></p>
<blockquote>
<p>搜索字符串还是搜索不到?</p>
<p>在快捷方式处添加<code>-dCULTURE=all</code></p>
</blockquote>
<p>找到后双击跟过去<img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203154530079.png" alt="image-20211203154530079"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203154638521.png" alt="image-20211203154638521"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203154720897.png" alt="image-20211203154720897"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203154812809.png" alt="image-20211203154812809"></p>
<p>上面的JE就是关键跳了。NOP掉即可</p>
<h2 id="内存查找法"><a href="#内存查找法" class="headerlink" title="内存查找法"></a>内存查找法</h2><p>我们知道软件在运行的时候，函数的数据是会保存在内存里的</p>
<p>如果我们运行软件后将他暂停，再看内存窗口的话，可以查找到字符串</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203155354377.png" alt="image-20211203155354377"></p>
<p>内存断点或硬件断点即可。</p>
<p>注意，如果硬件断点不起作用，可能是OD的问题，它各种反调试插件、汉化等等都可能导致这个问题，我们可以使用<strong>x64dbg.</strong></p>
<h2 id="栈回溯-ALT-K暂停法"><a href="#栈回溯-ALT-K暂停法" class="headerlink" title="栈回溯 ALT+K暂停法"></a>栈回溯 ALT+K暂停法</h2><p>软件再执行call的时候，会把一些参数都压入堆栈，最后执行完后再pop出来，我们可以在弹出信息框的时候给他暂停，这样参数都会保留在stack中，这时我们再去OD的K窗口（栈回溯窗口），就能看到function的信息了。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203155835217.png" alt="image-20211203155835217"></p>
<h2 id="GetWindowTextA-API断点"><a href="#GetWindowTextA-API断点" class="headerlink" title="GetWindowTextA API断点"></a>GetWindowTextA API断点</h2><p>对<code>GetWindowTextA</code> API进行断点，执行程序后被断下，一直F8。</p>
<p>发现在做比较，正确的字符串已经获取到了。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203160619957.png" alt="image-20211203160619957"></p>
<p>后续就不分析了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>之前一直以为从断下的地方跳一层就会回到主函数下面，导致这么简单都没搞出来，事实上跳N层都是有可能的。</p>
<h1 id="第二课课后作业"><a href="#第二课课后作业" class="headerlink" title="第二课课后作业"></a>第二课课后作业</h1><h2 id="软件使用-1"><a href="#软件使用-1" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204090025209.png" alt="image-20211204090025209"></p>
<h2 id="栈溯源法-ALT-K暂停法"><a href="#栈溯源法-ALT-K暂停法" class="headerlink" title="栈溯源法 ALT+K暂停法"></a>栈溯源法 ALT+K暂停法</h2><p>加载程序后运行，点击按钮让他弹出信息框，然后暂停。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204090912027.png" alt="image-20211204090912027"></p>
<p>在窗口K中找到堆栈信息，双击</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204090935331.png" alt="image-20211204090935331"></p>
<p>发现有跳转，直接enter进入</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204090953203.png" alt="image-20211204090953203"></p>
<p>在此处断点</p>
<p>再让程序跑一次，找到最终返回的地方。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204091114188.png" alt="image-20211204091114188"></p>
<p>此处跳过了成功消息，将JNZ改为NOP</p>
<h2 id="交叉引用断点"><a href="#交叉引用断点" class="headerlink" title="交叉引用断点"></a>交叉引用断点</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204093044610.png" alt="image-20211204093044610"></p>
<p>在OD处修改即可。</p>
<p><strong>如何在IDA修改？</strong></p>
<p>选项-》常规-》操作数字节-》16</p>
<p>编辑-》修补程序-》汇编</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204093940723.png" alt="image-20211204093940723"></p>
<p>nop两次把这两个都填充</p>
<p>编辑-》修补程序-》修补程序到输入文件</p>
<p>EA起始为你的基址</p>
<p>生成即可</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204094300480.png" alt="image-20211204094300480"></p>
<h2 id="补丁使用"><a href="#补丁使用" class="headerlink" title="补丁使用"></a>补丁使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204094354057.png" alt="image-20211204094354057"></p>
<h1 id="第三课课后作业"><a href="#第三课课后作业" class="headerlink" title="第三课课后作业"></a>第三课课后作业</h1><h2 id="软件使用-2"><a href="#软件使用-2" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205103356194.png" alt="image-20211205103356194"></p>
<h2 id="MessageBoxA-API断点-1"><a href="#MessageBoxA-API断点-1" class="headerlink" title="MessageBoxA API断点"></a>MessageBoxA API断点</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205103426796.png" alt="image-20211205103426796"></p>
<p>发现带壳，之后得用补丁。</p>
<p>先让程序运行起来，下断点MessageBoxA</p>
<p>找到关键跳，需要修改JE为nop</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205103920873.png" alt="image-20211205103920873"></p>
<h2 id="补丁使用-1"><a href="#补丁使用-1" class="headerlink" title="补丁使用"></a>补丁使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205104024600.png" alt="image-20211205104024600"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205104112887.png" alt="image-20211205104112887"></p>
<h1 id="第四课课后作业"><a href="#第四课课后作业" class="headerlink" title="第四课课后作业"></a>第四课课后作业</h1><h2 id="E语言写内存补丁"><a href="#E语言写内存补丁" class="headerlink" title="E语言写内存补丁"></a>E语言写内存补丁</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205104706503.png" alt="image-20211205104706503"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205104725383.png" alt="image-20211205104725383"></p>
<h2 id="E语言写劫持补丁"><a href="#E语言写劫持补丁" class="headerlink" title="E语言写劫持补丁"></a>E语言写劫持补丁</h2><p>检测数据是否被壳还原 -》 检测004010A9地址的数据是否为0x55(85)</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205124112526.png" alt="image-20211205124112526"></p>
<h2 id="C语言写内存补丁"><a href="#C语言写内存补丁" class="headerlink" title="C语言写内存补丁"></a>C语言写内存补丁</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205124716992.png" alt="image-20211205124716992"></p>
<p>这里主要是用<code>OpenProcess()</code>和<code>WriteProcessMemory()</code>来完成内存写入操作的。</p>
<h1 id="第五课课后作业"><a href="#第五课课后作业" class="headerlink" title="第五课课后作业"></a>第五课课后作业</h1><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>这一课涉及到了很多知识点，我花了两三天的事件才慢慢把各个知识点理清楚。 主要涉及到了硬件断点、硬件HOOK和线程方面的知识，虽然老师只讲了一节课，但是自己真正弄清楚并实践还是得费不少时间。另外我使用的VS2022版本给我带来了不少麻烦，各种不兼容，还好最后解决了，之后可能会出一些解决VS问题的合集。</p>
<p>该课后作业的要求是<strong>不修改代码从而实现破解。</strong></p>
<h2 id="软件使用-3"><a href="#软件使用-3" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125058597.png" alt="image-20211208125058597"></p>
<h2 id="SetWindowTextA-寻找关键跳"><a href="#SetWindowTextA-寻找关键跳" class="headerlink" title="SetWindowTextA 寻找关键跳"></a>SetWindowTextA 寻找关键跳</h2><p>OD载入发现有壳</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125215342.png" alt="image-20211208125215342"></p>
<p>我们将它运行起来 - 加壳的程序必须运行起来，才会被恢复源码。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125611118.png" alt="image-20211208125611118"></p>
<p><strong>注册失败</strong>的信息显示在了标题上，那么可以猜测它使用了SetWindowTextA函数，下一个断点。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125735454.png" alt="image-20211208125735454"></p>
<p>断下来了，开始F8。现在走到了一个可疑的地方，附近有大跳，我们用Immlabel插件标记一下，发现上面也有一处一样的call，那么猜测可能是成功的call。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125913192.png" alt="image-20211208125913192"></p>
<p>观察发现，上面有一个jnz跳转，跳过了成功的call，那么我们可以确定关键跳就在这里了<strong>0x401053</strong>。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208130101207.png" alt="image-20211208130101207"></p>
<h2 id="破解方法一：进程挂起-修改ZF标志位"><a href="#破解方法一：进程挂起-修改ZF标志位" class="headerlink" title="破解方法一：进程挂起+修改ZF标志位"></a>破解方法一：进程挂起+修改ZF标志位</h2><p>在之前得知的关键跳<strong>0x401053</strong>处下一个CC断点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/1.gif" alt="1"></p>
<p>奇怪的是，程序会被终止。CC断点是将地址的首字节改为0xCC，因此我们判断该程序使用了某种校验方法（可能是CRC检测）来检测固定的某段代码段是否在运行过程中被修改。此处我们可以修改JNZ为NOP完成破解，但题目要求是不修改代码破解，所以我们还需另寻他法。</p>
<p>一个软件为了保证整个程序流程正常运行，不太可能将CRC检测(while loop形式)写在主线程（单一线程），不然后面的代码将无法执行，所以猜测可能是有新的线程建立。</p>
<p>在OD的T窗口查看线程情况</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208130947860.png" alt="image-20211208130947860"></p>
<p>发现了一个异常活跃的线程，基本可以确定是用来检测的线程 - 直接将线程挂起。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208131235695.png" alt="image-20211208131235695"></p>
<p>再次将<strong>0X00401053</strong>下断，发现程序正常，成功过掉CRC检测。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208131301886.png" alt="image-20211208131301886"></p>
<p>JNZ在ZF标志位为1的时候不跳转 <img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208130254590.png" alt="image-20211208130254590"></p>
<p>破解成功</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208131520337.png" alt="image-20211208131520337"></p>
<h2 id="破解方法二：硬件HOOK"><a href="#破解方法二：硬件HOOK" class="headerlink" title="破解方法二：硬件HOOK"></a>破解方法二：硬件HOOK</h2><p>已知检测程序是校验代码位数，从而判断代码是否被修改，但硬件断点不会被断下，因为它是通过操纵Dr寄存器来完成的下断。关于硬件断点的讲解见<a target="_blank" rel="noopener" href="https://leihehehe.github.io/2021/12/07/%E6%B5%85%E6%9E%90%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9%E5%92%8C%E5%86%85%E5%AD%98%E6%96%AD%E7%82%B9/">浅析硬件断点和内存断点</a></p>
<p>硬件断点会触发**STATUS_SINGLE_STEP(单步异常)**，异常会交给程序的异常处理函数管理，若程序的异常处理函数不处理，才会交给调试器。</p>
<p>我们现在可以利用以下思路：</p>
<p>配合DLL劫持，让程序在JNZ跳转<strong>0x401053</strong>处触发硬件断点，同时给程序写一个异常处理函数 - 异常处理函数里是我们的恶意代码 - 将EIP+6，这样能够直接<strong>绕过JNZ判断</strong>。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208132929602.png" alt="image-20211208132929602"></p>
<p><strong>WIN10代码</strong>（我的环境）: <strong>winspool.drv</strong>，使用第四课的C语言劫持补丁代码进行改写。</p>
<p>注意:win10在设置硬件断点的时候必须<strong>先挂起目标线程</strong>，否则无法断点，所以我们需要创建一个新的线程，再在这个线程中暂停主线程从而保存修改后的寄存器内容。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">DWORD g_dwBreakPoint = <span class="number">0x401053</span>;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(_In_ LPVOID lpMainThreadId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	HANDLE hMainThread = <span class="built_in">OpenThread</span>(THREAD_ALL_ACCESS, TRUE, (DWORD)lpMainThreadId);</span><br><span class="line">	<span class="built_in">SuspendThread</span>(hMainThread);<span class="comment">// 暂停这个线程，避免它检测</span></span><br><span class="line">	CONTEXT ctx;</span><br><span class="line">	ctx.ContextFlags = CONTEXT_ALL;</span><br><span class="line">	<span class="built_in">GetThreadContext</span>(hMainThread, &amp;ctx);<span class="comment">//获取该线程的context=》包含了这个线程的各种参数，其中就包含dr寄存器的内容</span></span><br><span class="line">	ctx.Dr7 = (DWORD)<span class="number">0x1</span>;<span class="comment">//将该线程的dr7设为0x1=》代表DR0是有效的(L0=1)</span></span><br><span class="line">	ctx.Dr0 = g_dwBreakPoint;<span class="comment">//Dr0=硬件断点的地址</span></span><br><span class="line">	<span class="built_in">SetThreadContext</span>(hMainThread, &amp;ctx);<span class="comment">//把修改的值set到context里</span></span><br><span class="line">	<span class="built_in">ResumeThread</span>(hMainThread);<span class="comment">//恢复线程</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//异常捕捉</span></span><br><span class="line"><span class="function">DWORD NTAPI <span class="title">ExceptionHandler</span><span class="params">(EXCEPTION_POINTERS* ExceptionInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((DWORD)ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress == g_dwBreakPoint)<span class="comment">//如果发生异常的位置就是我们想要跳过的位置</span></span><br><span class="line">	&#123;</span><br><span class="line">		ExceptionInfo-&gt;ContextRecord-&gt;Eip += <span class="number">6</span>;<span class="comment">//将该地址的EIP+6，从而我们可以跳过检测。</span></span><br><span class="line">		<span class="comment">//已经处理了异常，不需要再调用下一个异常处理来处理此异常</span></span><br><span class="line">		<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//调用下一个处理器</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD dwReason, PVOID pvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dwReason == DLL_PROCESS_ATTACH)</span><br><span class="line">	&#123;</span><br><span class="line">		::<span class="built_in">MessageBoxA</span>(<span class="number">0</span>, <span class="string">&quot;开始破解拉&quot;</span>, <span class="string">&quot;能否成功呢？leihehehe.github.io&quot;</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">DisableThreadLibraryCalls</span>(hModule);</span><br><span class="line">		<span class="built_in">AddVectoredExceptionHandler</span>(<span class="number">1</span>, (PVECTORED_EXCEPTION_HANDLER)ExceptionHandler);<span class="comment">//添加一个VEH异常处理的函数，如果有异常，该函数会被call</span></span><br><span class="line">		<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, ThreadProc, (LPVOID)<span class="built_in">GetCurrentThreadId</span>(), <span class="literal">NULL</span>, <span class="literal">NULL</span>);<span class="comment">//创建线程来制造硬件断点,这里会发出异常，VEH异常处理函数能捕获它。</span></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Load</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dwReason == DLL_PROCESS_DETACH)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Free</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是<strong>win7代码</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">DWORD g_dwBreakpoint = <span class="number">0x401053</span>; <span class="comment">// 关键指令，希望跳过这条指令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置硬件断点函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetHardwareBreakPoint</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CONTEXT ctx;</span><br><span class="line">	ctx.ContextFlags = CONTEXT_ALL;</span><br><span class="line">	<span class="built_in">GetThreadContext</span>(<span class="built_in">GetCurrentThread</span>(), &amp;ctx);</span><br><span class="line">	ctx.Dr7 = (DWORD)<span class="number">0x1</span>; <span class="comment">// 启用Dr0</span></span><br><span class="line">	ctx.Dr0 = g_dwBreakpoint; <span class="comment">// 设置硬件断点	</span></span><br><span class="line">	<span class="built_in">SetThreadContext</span>(<span class="built_in">GetCurrentThread</span>(), &amp;ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异常处理函数</span></span><br><span class="line"><span class="function">DWORD NTAPI <span class="title">ExceptionHandler</span><span class="params">(PEXCEPTION_POINTERS pExceptionInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((DWORD)pExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress == g_dwBreakpoint)</span><br><span class="line">	&#123;</span><br><span class="line">		pExceptionInfo-&gt;ContextRecord-&gt;Eip += <span class="number">6</span>;</span><br><span class="line">		<span class="comment">// 已经处理了异常，不需要调用下一个异常处理来处理该异常</span></span><br><span class="line">		<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 入口函数</span></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD dwReason, PVOID pvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dwReason == DLL_PROCESS_ATTACH)</span><br><span class="line">	&#123;	</span><br><span class="line">		<span class="built_in">DisableThreadLibraryCalls</span>(hModule);</span><br><span class="line">		<span class="built_in">AddVectoredExceptionHandler</span>(<span class="number">1</span>, (PVECTORED_EXCEPTION_HANDLER) ExceptionHandler);</span><br><span class="line">		<span class="built_in">SetHardwareBreakPoint</span>(); <span class="comment">//设置硬件断点,不需要创建一个线程来执行硬件断点</span></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Load</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dwReason == DLL_PROCESS_DETACH)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Free</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>破解成功。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/hw5HardBreakHook.gif" alt="hw5HardBreakHook"></p>
<h1 id="第六课课后作业"><a href="#第六课课后作业" class="headerlink" title="第六课课后作业"></a>第六课课后作业</h1><h2 id="软件使用-4"><a href="#软件使用-4" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209185701029.png" alt="image-20211209185701029"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209185710786.png" alt="image-20211209185710786"></p>
<p>此处注册码并没有任何用处，随意输入也会提示注册成功</p>
<h2 id="破解方法"><a href="#破解方法" class="headerlink" title="破解方法"></a>破解方法</h2><p>运行起来转到代码段401000 - 从模块中删除分析</p>
<p>字符串搜索</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209185906127.png" alt="image-20211209185906127"></p>
<p>我们看见有一个<strong>\License.key</strong>，双击过去，在<strong>段开头</strong>断点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209190001299.png" alt="image-20211209190001299"></p>
<p>我们猜测该程序是在启动的时候判断是否注册，而关键点就在于这个<strong>License.key</strong></p>
<p>记录一下下断点的地址<strong>004016D6</strong></p>
<p>现在重新运行软件，正常的话，程序应该在这里断下来，但现在并没有断下，发现断点被禁用了。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209190436336.png" alt="image-20211209190436336"></p>
<p>程序带壳，刚开始运行时，下断的地址没有被恢复，所以断点会被禁止。</p>
<p>因此我们需要在程序代码恢复后再给<strong>004016D6</strong>地址下断。</p>
<p>转到<strong>CreateWindowExW</strong>下断 - 大部分加壳程序代码在此处都已还原。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209191453997.png" alt="image-20211209191453997"></p>
<p>在004016D6下断</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209191547960.png" alt="image-20211209191547960"></p>
<p>运行后被断下,一直F8</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209191725737.png" alt="image-20211209191725737"></p>
<p>在此处修改jnz为nop即可</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209191821736.png" alt="image-20211209191821736"></p>
<h1 id="第七课课后作业"><a href="#第七课课后作业" class="headerlink" title="第七课课后作业"></a>第七课课后作业</h1><h2 id="软件使用-5"><a href="#软件使用-5" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213153606918.png" alt="image-20211213153606918"></p>
<p><strong>作业要求：逆出算法，不能爆破，不能修改代码。</strong></p>
<h2 id="逆向流程"><a href="#逆向流程" class="headerlink" title="逆向流程"></a>逆向流程</h2><p>直接载入OD，找关键点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213153904764.png" alt="image-20211213153904764"></p>
<p>在IDA中发现左侧第一个就是401000的函数，我们点击以后按F5，让它直接转变为代码</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213154209385.png" alt="image-20211213154209385"></p>
<p>分析a1应该是我们输入的key，下面的messageBox乱码，怎么解决呢？双击乱码的地方过去</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213154450306.png" alt="image-20211213154450306"></p>
<p>这种情况通常是因为IDA将其识别为Unicode，而unicode不能正确表示我们的字符串。</p>
<p>菜单栏-&gt;选项-&gt;字符串文本-&gt;修改为UTF-16LE</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213154629467.png" alt="image-20211213154629467"></p>
<p>发现已经改回来了。</p>
<p>再回到之前的代码区，按F5</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213154656969.png" alt="image-20211213154656969"></p>
<p>代码成功恢复</p>
<p>接下来我们对一些变量名做一些修改，方便理解</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213160036921.png" alt="image-20211213160036921"></p>
<h2 id="C语言逆算法"><a href="#C语言逆算法" class="headerlink" title="C语言逆算法"></a>C语言逆算法</h2><p>直接把代码从IDA上copy&amp;paste，然后做一些修改。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">checkKey</span><span class="params">(<span class="type">int</span> inputKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> result; <span class="comment">// </span></span><br><span class="line">	<span class="type">int</span> v2; <span class="comment">// 这个应该是用来作为BOOL，作为一个FLAG判断</span></span><br><span class="line"></span><br><span class="line">	v2 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (inputKey * (inputKey - <span class="number">23</span>) == <span class="number">-102</span>)</span><br><span class="line">		v2 = <span class="number">1</span>;</span><br><span class="line">	result = v2;</span><br><span class="line">	<span class="keyword">if</span> (v2)<span class="comment">//如果上面的条件成立了，则继续检测下面是否成立</span></span><br><span class="line">	&#123;</span><br><span class="line">		result = inputKey * inputKey * inputKey;</span><br><span class="line">		<span class="keyword">if</span> (result == <span class="number">4913</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0xFFFFFFFF</span>; i++) &#123;<span class="comment">//遍历key是否正确</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">checkKey</span>(i)) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213160052211.png" alt="image-20211213160052211"></p>
<p>算出来正确的注册码是17</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213160126767.png" alt="image-20211213160126767"></p>
<h1 id="第八课课后作业"><a href="#第八课课后作业" class="headerlink" title="第八课课后作业"></a>第八课课后作业</h1><h2 id="软件使用-6"><a href="#软件使用-6" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213160322310.png" alt="image-20211213160322310"></p>
<h2 id="去花指令"><a href="#去花指令" class="headerlink" title="去花指令"></a>去花指令</h2><p>载入OD后在字符串中查找，发现并没有注册失败或成功，跟进<code>请输入注册码</code>，发现后面代码加了花指令</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213162550645.png" alt="image-20211213162550645"></p>
<p>我选择先去除花指令。</p>
<p>花指令一般是由恒成立的跳转组成的，我们只需要nop掉永远不会访问的无效指令，就能去除</p>
<p>例如</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213163002542.png" alt="image-20211213163002542"></p>
<p>在数据窗口中去除 <img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213163034570.png" alt="image-20211213163034570"></p>
<p>将所有花指令去除后，复制保存到可执行文件</p>
<h2 id="分析算法"><a href="#分析算法" class="headerlink" title="分析算法"></a>分析算法</h2><p>因为程序比较小，我们可以直接拖入IDA，在前几个函数中能找到我们的关键位置</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213163536224.png" alt="image-20211213163536224"></p>
<p>我们做一些注释</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213164107383.png" alt="image-20211213164107383"></p>
<p>其中一个call中的**&amp;byte_442578<strong>引起了我的注意，我有些困惑这是什么，根据上下文猜测，感觉后面的v4像是我们输入的key，</strong>&amp;byte_442578**又是什么呢？</p>
<p>双击进去看看，此时它为数据类型</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213164245856.png" alt="image-20211213164245856"></p>
<p>我们将他转换成字符串，发现它变成了%s</p>
<p>返回刚才的地方F5，显而易见，这是一个**scanf()**方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213164406622.png" alt="image-20211213164406622"></p>
<p>我们进入**algrithms()**继续分析算法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165156917.png" alt="image-20211213165156917"></p>
<p>一顿分析后，我们发现下方有一个<code>*(_BYTE *)</code>，通常这种<strong>pointer</strong>前方又有一个星号的情况，都是因为IDA识别错误。</p>
<p>我们发现括号后面finalResult，和inputKey的类型是错误的</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165345317.png" alt="image-20211213165345317"></p>
<p>修改一下参数类型</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165435708.png" alt="image-20211213165435708"></p>
<p>显示正常。</p>
<p>同样我们再修改一下以下位置</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165659661.png" alt="image-20211213165659661"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165742029.png" alt="image-20211213165742029"></p>
<p>对应的值为**’bcdaren’**</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165804348.png" alt="image-20211213165804348"></p>
<h2 id="C语言逆算法-1"><a href="#C语言逆算法-1" class="headerlink" title="C语言逆算法"></a>C语言逆算法</h2><p>将算法从IDA复制到C</p>
<p>观察下面的算法,我们发现再第二个for循环中，<strong>i</strong>一直没变，不停的再给同一个数重新赋值新的<strong>aBacdaren_1[j]^xxx</strong>，所以我们可以看出来，其实这两个for循环是在干一件事，就是把最后一个字母<strong>n</strong>和(key中的每一位+13)做异或运算。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  v4 = i;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt;= keyLen )                        <span class="comment">// 如果循环次数大于了key的长度就退出循环</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>(<span class="string">&quot;bcdaren&quot;</span>); ++j )</span><br><span class="line">    finalResult[i] = aBcdaren_1[j] ^ (inputKey[i] + <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>化简以后：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; keyLen; i++) &#123;</span><br><span class="line">		finalResult[i] = <span class="string">&#x27;n&#x27;</span> ^ (inputKey[i] + <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是我们可以分析出，该程序的算法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span>* <span class="title">algrithms</span><span class="params">(<span class="type">char</span>* inputKey, <span class="type">char</span>* finalResult, <span class="type">unsigned</span> <span class="type">int</span> maxLen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> v4; </span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> keyLen; </span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> i; </span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (inputKey &amp;&amp; finalResult &amp;&amp; maxLen)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strlen</span>(inputKey) &lt;= maxLen)           <span class="comment">// 判断长度是否小于maxLen</span></span><br><span class="line">			keyLen = <span class="built_in">strlen</span>(inputKey);                <span class="comment">// 如果&lt;=最大长度，取key原本的长度</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			keyLen = maxLen;                          <span class="comment">// 如果大于最大长度，取最大长度</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; keyLen; i++) &#123;</span><br><span class="line">				finalResult[i] = <span class="string">&#x27;n&#x27;</span> ^ (inputKey[i] + <span class="number">13</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> finalResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213172917906.png" alt="image-20211213172917906"></p>
<p>最后<strong>finalResult</strong>的值应该等于<code>((++**--,,//..QQPP</code></p>
<p>我们再写个逆运算的算法，注意，<strong>异或运算中任意两个数异或可以得到第三个数</strong>，例如：</p>
<p>a^b=c</p>
<p>a^c=b</p>
<p>b^c=a</p>
<p><strong>最终逆向算法：</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span>* <span class="title">getCorrectKey</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* keyToBeConverte, <span class="type">char</span>* finalResult, <span class="type">unsigned</span> <span class="type">int</span> maxLen)</span> </span>&#123;</span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> keyLen;</span><br><span class="line">	<span class="keyword">if</span> (keyToBeConverte &amp;&amp; finalResult &amp;&amp; maxLen) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strlen</span>(keyToBeConverte) &lt;= maxLen)           <span class="comment">// 判断长度是否小于maxLen</span></span><br><span class="line">			keyLen = <span class="built_in">strlen</span>(keyToBeConverte);                <span class="comment">// 如果&lt;=最大长度，取key原本的长度</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			keyLen = maxLen;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; keyLen; i++) &#123;</span><br><span class="line">			finalResult[i] = (<span class="string">&#x27;n&#x27;</span> ^ keyToBeConverte[i])<span class="number">-13</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> finalResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> finalResult[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="built_in">getCorrectKey</span>(<span class="string">&quot;((++**--,,//..QQPP&quot;</span>, finalResult, <span class="number">128</span>));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213175431347.png" alt="image-20211213175431347"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213175444354.png" alt="image-20211213175444354"></p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2021/11/24/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJavassist-8/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2023-06-15 17:12:06
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="Categories"></i>
                    
                    <span class="span--category">
                      <a href="/categories/Reverse-Engineering/" title="Reverse Engineering">
                        <b>#</b> Reverse Engineering
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="Tags"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Write-up/" title="Write-up">
                        #Write-up
                      </a>
                    </span>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/Reverse-Engineering/" title="Reverse Engineering">
                        #Reverse Engineering
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2021/12/07/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-%E4%B8%80-Filter%E5%9E%8B/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BE%E5%90%8E%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80"><span class="toc-text">课后小程序下载地址</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%AF%BE%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A"><span class="toc-text">第一课课后作业</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8"><span class="toc-text">软件使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MessageBoxA-API%E6%96%AD%E7%82%B9"><span class="toc-text">MessageBoxA API断点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E5%8F%89%E5%BC%95%E7%94%A8%E6%9F%A5%E6%89%BE%E6%B3%95"><span class="toc-text">交叉引用查找法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%9F%A5%E6%89%BE%E6%B3%95"><span class="toc-text">内存查找法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%88%E5%9B%9E%E6%BA%AF-ALT-K%E6%9A%82%E5%81%9C%E6%B3%95"><span class="toc-text">栈回溯 ALT+K暂停法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GetWindowTextA-API%E6%96%AD%E7%82%B9"><span class="toc-text">GetWindowTextA API断点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%AF%BE%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A"><span class="toc-text">第二课课后作业</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8-1"><span class="toc-text">软件使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%88%E6%BA%AF%E6%BA%90%E6%B3%95-ALT-K%E6%9A%82%E5%81%9C%E6%B3%95"><span class="toc-text">栈溯源法 ALT+K暂停法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A4%E5%8F%89%E5%BC%95%E7%94%A8%E6%96%AD%E7%82%B9"><span class="toc-text">交叉引用断点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E4%BD%BF%E7%94%A8"><span class="toc-text">补丁使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%AF%BE%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A"><span class="toc-text">第三课课后作业</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8-2"><span class="toc-text">软件使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MessageBoxA-API%E6%96%AD%E7%82%B9-1"><span class="toc-text">MessageBoxA API断点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E4%BD%BF%E7%94%A8-1"><span class="toc-text">补丁使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E8%AF%BE%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A"><span class="toc-text">第四课课后作业</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#E%E8%AF%AD%E8%A8%80%E5%86%99%E5%86%85%E5%AD%98%E8%A1%A5%E4%B8%81"><span class="toc-text">E语言写内存补丁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#E%E8%AF%AD%E8%A8%80%E5%86%99%E5%8A%AB%E6%8C%81%E8%A1%A5%E4%B8%81"><span class="toc-text">E语言写劫持补丁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C%E8%AF%AD%E8%A8%80%E5%86%99%E5%86%85%E5%AD%98%E8%A1%A5%E4%B8%81"><span class="toc-text">C语言写内存补丁</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E8%AF%BE%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A"><span class="toc-text">第五课课后作业</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-1"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8-3"><span class="toc-text">软件使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SetWindowTextA-%E5%AF%BB%E6%89%BE%E5%85%B3%E9%94%AE%E8%B7%B3"><span class="toc-text">SetWindowTextA 寻找关键跳</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A0%B4%E8%A7%A3%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E8%BF%9B%E7%A8%8B%E6%8C%82%E8%B5%B7-%E4%BF%AE%E6%94%B9ZF%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="toc-text">破解方法一：进程挂起+修改ZF标志位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A0%B4%E8%A7%A3%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E7%A1%AC%E4%BB%B6HOOK"><span class="toc-text">破解方法二：硬件HOOK</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E8%AF%BE%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A"><span class="toc-text">第六课课后作业</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8-4"><span class="toc-text">软件使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A0%B4%E8%A7%A3%E6%96%B9%E6%B3%95"><span class="toc-text">破解方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E8%AF%BE%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A"><span class="toc-text">第七课课后作业</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8-5"><span class="toc-text">软件使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%86%E5%90%91%E6%B5%81%E7%A8%8B"><span class="toc-text">逆向流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C%E8%AF%AD%E8%A8%80%E9%80%86%E7%AE%97%E6%B3%95"><span class="toc-text">C语言逆算法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E8%AF%BE%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9A"><span class="toc-text">第八课课后作业</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8-6"><span class="toc-text">软件使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%BB%E8%8A%B1%E6%8C%87%E4%BB%A4"><span class="toc-text">去花指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%AE%97%E6%B3%95"><span class="toc-text">分析算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#C%E8%AF%AD%E8%A8%80%E9%80%86%E7%AE%97%E6%B3%95-1"><span class="toc-text">C语言逆算法</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




<script>
  document.addEventListener("DOMContentLoaded", function() {
    var expandIconSVG = '<svg t="1701763017908" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1557" width="20" height="11"><path d="M332.16 883.84a40.96 40.96 0 0 0 58.24 0l338.56-343.04a40.96 40.96 0 0 0 0-58.24L390.4 140.16a40.96 40.96 0 0 0-58.24 58.24L640 512l-307.84 314.24a40.96 40.96 0 0 0 0 57.6z" fill="#8a8a8a" p-id="1558"></path></svg>'; // Your collapse icon SVG
    var collapseIconSVG = '<svg t="1701763045407" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1839" width="20" height="11"><path d="M140.16 332.16a40.96 40.96 0 0 0 0 58.24l343.04 338.56a40.96 40.96 0 0 0 58.24 0l342.4-338.56a40.96 40.96 0 1 0-58.24-58.24L512 640 197.76 332.16a40.96 40.96 0 0 0-57.6 0z" fill="#8a8a8a" p-id="1840"></path></svg>'; // Your expand icon SVG

    var tocItems = document.querySelectorAll('.catalog-content .toc-item');
    tocItems.forEach(function(item) {
      if (item.querySelector('.toc-child')) {
        var button = document.createElement('span');
        button.innerHTML = item.classList.contains('collapsed') ? expandIconSVG : collapseIconSVG; // Set initial icon
        button.classList.add('collapse-button');
        item.insertBefore(button, item.firstChild);

        button.addEventListener('click', function() {
          item.classList.toggle('collapsed');
          // Update icon
          button.innerHTML = item.classList.contains('collapsed') ? expandIconSVG : collapseIconSVG;
        });
      }
    });
  });
</script>




    
      <div class="comments-container">
        






  <div id="gitalk-container"></div>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
  <script>
    function loadGitalkSuc() {
      const gitalk = new Gitalk({
        clientID: '4fd0839f78c35735511f',
        clientSecret: 'c4d98a543b9bf9970b444154ad05c4c045afea26',
        repo: 'commentSys',
        owner: 'leihehehe',
        admin: ['leihehehe'],
        id: md5(location.pathname),
        distractionFreeMode: false
      })

      gitalk.render('gitalk-container')
    }
  </script>
  
    <link rel="stylesheet" href="/plugins/gitalk.css">
    <script type="text/javascript" src="/plugins/gitalk.min.js" onload="loadGitalkSuc(this)"></script>
  



      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/leihehehe">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="mailto:hslscarlett@gmail.com">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="linkedin" target="_blank" rel="noopener" href="https://www.linkedin.com/in/shulei-he/">
            <i class="iconfont icon-linkedin"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/leihehehe">Copyright © 2025 Shulei He</a>
        
    </div>
  
    
    <div class="footer-more">
      
        Theme by Oranges | Modified by Shulei
        
    </div>
  
  
    <div class="footer-views">
      
          Total Site Visits:<span id="busuanzi_value_site_pv"></span>
        
      
          Total Artical Views:<span id="busuanzi_value_page_pv"></span>
        
      
          Total Visitors Count:<span id="busuanzi_value_site_uv"></span>
        
      
    </div>
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup + '&url=' + https%3A%2F%2Fleihehe.top%2F2021%2F12%2F02%2FNCK%25E9%2580%2586%25E5%2590%2591%25E8%25AF%25BE%25E5%2590%258E%25E4%25BD%259C%25E4%25B8%259Awriteup%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://leihehe.top/2021/12/02/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
